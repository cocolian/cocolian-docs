---
layout:     source 
title:      "2017-11-16-WeChat"
date:       2017-11-16 12:00:00
author:     "PaymentGroup"
tag:		  [chat]
header-img: "img/post-bg-wechat.jpg"
---
> 10:37:34  Alive  
   
有做过下单支付 调用支付宝SDK的朋友吗？请教个问题  
   
> 10:44:22  Alive  
   
最近接入支付宝，碰到个问题，下单支付调用支付宝的SDK 支付后,1、支付宝通知用户APP端超时，APP应该怎么处理？ 2、即使通知成功，服务端网络异常或者升级，没收到通知，用户查看订单详情后，发现未支付，又进行支付，怎么处理呢  
   
> 10:53:15  Judy??  
   
我接触过微信的SDK。首先微信可以设置一个有效期，我们当时设置的是5min，发起时5min不得再发起。没收到通知的，可以在微信后台做一个补发通知的操作。或者是若重复支付了，微信后台可以发起退款。  
   
> 10:53:42  Alive  
   
谢谢大佬的耐心解答  
   
> 10:55:28  H?o?wa?r?d?_?WANG  
   
@汪根-杭州-金百仕支付-研发?咱们金百仕支付是第三方支付吗？怎么能和支付宝直接对接呢[调皮]  
   
> 10:56:20  Alive  
   
[捂脸]  
   
> 10:56:21  闹闹爸鼻  
   
状态确认除了等待三方的通知，还要支持主动的查询订单状态  
   
> 10:59:57  路杨  
   
业务订单再次发起支付时，先查询关联的支付订单状态，如果是未知，先向微信支付宝查询确认第一次创建的支付订单状态。本身第一次创建的支付订单一直没收到微信支付宝回调，一般也会在10秒后开始主动轮询向微信支付宝查状态了  
   
> 11:11:24  Alive  
   
谢谢 热心的大佬  
   
> 11:11:51  Alive  
   
恩。业务上应该怎么减少 用户二次支付的场景呢 或者说 产品层面上做引导。  
   
> 11:19:22  淡风林  
   
用户进入商户APP的时候查询这个用户是否有订单未支付，如果有则调用查询接口去微信/支付宝查询，如果确定未支付则显示个弹窗问用户是否继续支付。  
   
> 11:20:49  淡风林  
   
如果一笔订单收到支付成功的回调后查询这笔订单还有哪些支付订单处于未支付的状态，如果有则调用撤销订单接口去微信/支付宝撤销订单防止用户继续支付。如果有订单有两笔支付成功的请求就把后一笔退款退掉  
   
> 11:21:23  Alive  
   
用户进入商户APP的时候实时查询调用支付宝接口查询状态吗？  
   
> 11:22:08  淡风林  
   
先查自己订单系统这个用户有没有中间状态的订单，如果有再去支付宝微信查  
   
> 11:22:30  淡风林  
   
这个比较节约资源吧，不过查查可能也挺慢的，做好当然是做轮询了  
   
> 11:27:57  Alive  
   
谢谢 大佬 的解答  
   
> 11:28:15  淡风林  
   
。。。。我也是自学的啊  
   
> 11:31:06  姚刚  
   
给大群的朋友们发个红包！人人可领，领完就能用。#吱口令#长按复制此消息，打开支付宝就能领取！LkOxrR82hv  
   
> 11:37:27  路杨  
   
@汪根-杭州-金百仕支付-研发 从你APP跳转到支付宝APP支付后，用户如果点击返回**APP，这个时候你的APP会收到通知，这个时候APP就可以向后台查询支付结果并刷新前端订单状态；如果用户没点击返回**APP，通过任务管理器切换回你的APP，这时可以弹一个对话框：是否支付成功，用户选“是”，就向后台查询支付结果并刷新前端订单状态。这是我们的做法  
   
> 11:38:29  Alive  
   
谢谢 大佬的耐心解答  
   
> 14:55:35  卡  
   
请教个问题啊 有木有遇到过微信公众号支付 安卓手机调不起来的情况  
   
> 15:04:21  元宝  
   
报什么错？  
   
> 15:15:53  卡  
   
不报错 就是换不起来  
   
> 15:21:17  Leonard  
   
配置搞好了没  
   
> 15:21:24  Leonard  
   
授权目录什么的  
   
> 15:21:44  卡  
   
配置过的 苹果可以唤起  
   
> 15:21:46  卡  
   
  
   
> 15:22:12  Leonard  
   
所有安卓都不行？  
   
> 15:24:22  卡  
   
对  
   
> 15:30:52  淡风林  
   
我之前做微信鉴权的时候碰到过类似的，你们开始是将地址等相关参数传给浏览器后通过浏览器重定向到微信的吗？  
   
> 16:37:38  Ant  
   
各位大神，请教一个问题，微信和支付宝在绑定银行卡的时候，为什么发出来的验证码是微信的而不是银行的呀  
   
> 16:38:14  Ant  
   
这个是走的什么鉴权接口  
   
> 16:45:06  邵翁路  
   
@Ant 这个看场景的，比如快捷支付，银行的快捷就银行发，支付公司自己包的快捷肯定支付公司自己发OTP  
   
> 16:45:07  Nada  
   
不是鉴权接口，是 快捷支付当中的绑卡接口  
   
> 16:46:57  Ant  
   
我们现在用的四要素，是银行发的  
   
> 16:47:32  李寻欢  
   
@Ant?支付宝微信的信誉比较好，技术也有保障，银行把短信交给他们发放心，放给银联的快捷绑卡短信也是放给银联去发的  
   
> 16:47:54  李寻欢  
   
一般公司没有这个待遇的  
   
> 16:48:13  李寻欢  
   
交行是这样的  
   
> 16:48:52  Ant  
   
我们现在平台经常遇到银行预留手机号不对，导致认证不了的。。 很多是 开户手机号和联系人号码 导致的  
   
> 16:48:58  Ant  
   
不知道你们是否遇到国这种问题  
   
> 16:50:48  邵翁路  
   
让用户去银行更新手机号或者换绑卡重新鉴权  
   
> 16:52:57  Ant  
   
这就有点麻烦  
   
> 17:01:20  北京一张泽雄  
   
这个应该和协议有关了  
   
> 17:03:18  北京一张泽雄  
   
我们以前做的时候，是有个免短信码的协议，没有签协议，短信验证码是必须上送的  
   
> 17:08:07  dio  
   
问一下各位大佬，这个网联做起来了，银行之间的在线交易需不需要经过网联  
   
> 17:08:25  dio  
   
比如招行转建行，需要经过网联吗  
   
> 17:17:34  崔莹峰  
   
不需要  
   
> 17:19:18  dio  
   
谢谢，也就是说只有第三方支付才需要是吧  
   
> 17:20:47  秋水-厚本金融-产品经理  
   
非银  
   
> 17:25:52  车睿??  
   
想问一下，如果想用一家三方公司，接支付宝支付，是怎样的流程？信息流和资金流分别什么样的？是通过银行间联吗  
   
> 17:30:52  邵翁路  
   
嗯，三方支付理论上无法连三方，一般通过银行转下  
   
> 17:31:21  秋水-厚本金融-产品经理  
   
现在无法，将来网联无限可能  
   
> 17:34:11  车睿??  
   
网联还得再等等，现在各个三方机构也还没接入呢吧  
   
> 17:34:59  dio  
   
朋友你可以试试大商户模式，不过不不知道现在还能不能用  
   
> 17:35:47  秋水-厚本金融-产品经理  
   
大商户模式到底能不能用  
   
> 17:36:03  秋水-厚本金融-产品经理  
   
这个谁有经验呀  
   
> 17:36:45  车睿??  
   
大商户，是指大资金池模式吗？  
   
> 17:37:23  车睿??  
   
资金收入三方公司，由平台通过指令，实际资金从三方公司进行代付？  
   
> 17:39:47  dio  
   
我没记错的话应该是资金先从客户那里进入微信和支付宝，然后微信和支付宝结给银行，银行结给第三方，第三方结给商户  
   
> 17:42:12  车睿??  
   
嗯，是这种，这个是每个节点的资金流。但是现在支付宝有开放线上收单接口吗  
   
> 17:43:12  秋水-厚本金融-产品经理  
   
你仔细观察，蘑菇街现在只支持支付宝、微信，其他不支持  
   
> 17:43:53  dio  
   
收单我不太清楚，我之前主要是聚合支付走公众号这块  
   
> 17:44:22  少帅  
   
民生代扣啥时候恢复，各位有可靠消息吗  
   
> 17:44:43  北京一张泽雄  
   
年底  
   
> 17:45:40  ffff  
   
哈哈权威解答  
   
> 17:46:05  秋水-厚本金融-产品经理  
   
@小吴_产品-承泰-上海 聚合支付走的是大商户模式？  
   
> 17:46:19  dio  
   
是的  
   
> 17:46:43  dio  
   
还用另外一种，不过那种我们不赚钱所以就没有用了  
   
> 18:01:08  秋水-厚本金融-产品经理  
   
今天看美团的支付宝付款直接到商户了  
   
> 18:01:19  秋水-厚本金融-产品经理  
   
![2017-11-16 18:01:19](http://static.cocolian.cn/img/201711/20171116_180119.png) 
   
> 18:01:25  秋水-厚本金融-产品经理  
   
怎么搞的？  
   
> 18:03:33  Leonard  
   
这得绑定商户账户了  
   
> 18:03:38  Leonard  
   
咋搞的  
   
> 18:04:17  Leonard  
   
量这么大，动作好快啊  
   
> 18:04:36  秋水-厚本金融-产品经理  
   
前面还是美团订单  
   
> 18:15:36  superbboy  
   
会不会只是商户把自己的支付宝账号放到美团里面呢？  
   
> 18:18:26  秋水-厚本金融-产品经理  
   
美团外卖还是走的美团  
   
> 18:21:33  superbboy  
   
刚刚买了一个优惠券，也还是美团  
   
> 18:23:01  想成为万能青年的修  
   
这个是线下扫码？  
   
> 18:27:42  想成为万能青年的修  
   
如果没错，线下的聚合扫码，商户录入的时候，就直接到支付宝那。  
   
> 18:36:04  Judy??  
   
@Ant?亲 就你这个问题。是他们走的四要素认证是不带发短信的银联的通道。当系统收到四要素认证正确，就自己触发发短信  
   
> 18:38:24  Ant  
   
@七七-明特-北京?那这个取决于我们三方支付？  
   
> 18:44:12  Judy??  
   
取决于你用的第三方通道，一般都会有很多种接口。  
   
> 18:49:55  Judy??  
   
有带短信验证码的接口，也有只是纯四要素认证的接口  
   
> 18:51:26  Ant  
   
嗯，谢谢  
   
> 19:00:18  Bison  
   
请教大家个问题，实时代付，对商户余额进行冻结，热点账户问题有什么好的解决办法吗？  
   
> 19:02:16  右军  
   
谁付给谁？  
   
> 19:02:24  右军  
   
一个账户付给多个？  
   
> 19:02:47  车睿??  
   
为什么冻结，不直接先扣呢？  
   
> 19:04:06  Bison  
   
商户的钱付给C端用户，商户通过接口调用发起  
   
> 19:04:54  Bison  
   
冻结后，会清分，和渠道确认成功后才记账、扣款  
   
> 19:05:15  车睿??  
   
先扣除，记账，失败了返还呢？  
   
> 19:05:19  Bison  
   
商户在支付平台的钱  
   
> 19:06:38  Bison  
   
嗯，扣除和冻结业务虽然不一样，但我理解技术上应该类似  
   
> 19:06:53  Bison  
   
都是对商户的余额做操作  
   
> 19:07:08  Bison  
   
如果并发大了，如何提高效率  
   
> 19:09:30  Bison  
   
这个场景有钱包提现，信贷放款  
   
> 19:10:10  lisp  
   
让商户多开几个账户吧...[捂脸]  
   
> 19:10:17  Bison  
   
我是站在第三方支付角度提的问题  
   
> 19:11:03  Bison  
   
@xuetao-分期乐-业余产品-深圳 ??  
   
> 19:11:20  萍萍妞  
   
有中间账户吗  
   
> 19:11:45  lisp  
   
中间账户可能没啥用，除非做逻辑简化  
   
> 19:11:46  闹闹爸鼻  
   
商户的账号分结算户和提现户，结算户用户不能操作，代付后统一更新余额  
   
> 19:12:28  Bison  
   
嗯，结算和提现是分开的  
   
> 19:13:56  萍萍妞  
   
做个中间账户把钱先扣到中间账户是否可行？  
   
> 19:15:54  Bison  
   
我理解不是中间账户的问题  
   
> 19:16:44  Bison  
   
是商户的现金账户的余额如何有效冻结  
   
> 19:16:56  Bison  
   
冻结到中间账户  
   
> 19:17:28  Bison  
   
比如同时有1000笔该商户的代付的并发请求  
   
> 19:18:09  Bison  
   
如何保证效率的同时，又不算错余额  
   
> 19:19:08  萍萍妞  
   
逐笔冻结？  
   
> 19:21:14  Bison  
   
是的  
   
> 19:21:18  Bison  
   
不然呢？  
   
> 19:21:44  Bison  
   
加个队列和时间  
   
> 19:22:13  Bison  
   
队列到一定数量，或时间到了，加和，一笔冻结  
   
> 19:22:17  Bison  
   
这效率也不高  
   
> 19:22:42  lisp  
   
冻结一个总的额度？  
   
> 19:22:43  Bison  
   
把余额放redis里  
   
> 19:23:02  Bison  
   
接着上面 例子  
   
> 19:23:25  王向东  
   
假如1000笔中有两笔失败的，怎么处理？  
   
> 19:23:32  Bison  
   
@xuetao-分期乐-业余产品-深圳 不是，我上面是YY的  
   
> 19:23:38  Bison  
   
失败没问题  
   
> 19:23:52  Bison  
   
反清分、反记账  
   
> 19:24:04  Bison  
   
怕是余额不足，还付出去了  
   
> 19:24:18  王向东  
   
只解冻划扣成功的，还是？  
   
> 19:25:36  王向东  
   
对于失败的解冻但是不划扣，是不是这个理[微笑]  
   
> 19:25:55  Bison  
   
是的  
   
> 19:26:06  Bison  
   
现在是冻结这块  
   
> 19:26:10  Bison  
   
想提高效率  
   
> 19:26:27  闹闹爸鼻  
   
一笔总代发下挂子代发，这样就是一笔交易，可以只冻结一次  
   
> 19:26:32  Bison  
   
问下大家有木有简单、高效滴解决办法[偷笑]  
   
> 19:27:02  Bison  
   
请求是分散的  
   
> 19:27:09  Bison  
   
逐笔的  
   
> 19:27:26  lisp  
   
让他只能上传文件....  
   
> 19:28:17  lisp  
   
[捂脸]  
   
> 19:28:45  lisp  
   
然后就不合作了，解决了热点问题[捂脸]  
   
> 19:32:15  Bison  
   
[抱拳][抱拳]  
   
> 19:32:49  Bison  
   
有批量代付  
   
> 19:33:44  Bison  
   
orcale 的 select for update  
   
> 19:33:54  Bison  
   
效果不理想  
   
> 19:35:07  lisp  
   
你们代付时效现在大概多少？  
   
> 19:36:49  Bison  
   
目前50/s  
   
> 19:37:02  Bison  
   
想100/s  
   
> 19:37:35  萍萍妞  
   
一个包统一冻结到中间账户，减少余额账户操作频率  从中间账户代付  可同时多中间账户并发   
   
> 19:38:12  萍萍妞  
   
yy的  
   
> 19:38:59  Bison  
   
嗯呐  
   
> 20:12:47  Aaron  
   
群里有PayPal的兄弟吗？中国区  
   
> 20:14:42  卡  
   
要了解啥么 我可以帮你问问  
   
> 20:16:21  维森陌-拉莫帅-帅德-布耀布耀德  
   
[机智][机智][机智]  
   
> 20:18:18  hui  
   
昨天开始民生银行停了支付接口，群里有朋友知道是啥咋回事吗  
   
> 20:19:02  小东东  
   
[捂脸]代付提前一个月不行了  
   
> 21:25:22  北京一张泽雄  
   
走批量代付可以提高效率  
   
> 21:27:14  北京一张泽雄  
   
打一个批次，一次冻结  
   
> 21:30:28  Bison  
   
目前设计实付是实时返回结果  
   
> 21:31:13  Bison  
   
一笔交易从头跑到尾  
   
> 21:31:25  Bison  
   
然后给商户结果  
   
> 21:31:45  Bison  
   
没有终态的给处理中  
   
> 21:32:23  Bison  
   
商户可通过查询接口查看终态  
   
> 21:32:31  Bison  
   
我们也有通知接口  
   
> 21:33:34  秋水-厚本金融-产品经理  
   
打包加中间账户？  
   
> 21:35:20  Bison  
   
打包的走批复，只要是渠道的返回也慢  
   
> 21:35:38  Bison  
   
有的渠道还有人工审核机制等  
   
> 21:35:45  Bison  
   
时间上不能保证  
   
> 21:35:50  北京一张泽雄  
   
实时交易流程太长  
   
> 21:36:00  Bison  
   
嗯  
   
> 21:36:56  Bison  
   
打包走批付，渠道目前返回终态的时间不能保证  
   
> 21:43:17  北京一张泽雄  
   
打批，再批转联  
   
> 21:44:34  北京一张泽雄  
   
你现在的瓶颈在余额扣减这  
   
> 21:47:08  Bison  
   
是的  
   
> 21:47:34  Bison  
   
打批，再批转联是？  
   
> 21:49:28  北京一张泽雄  
   
就是批量扣一次余额，比如100笔共100万元，然后这100笔可以并行走单笔付款接口付款  
   
> 21:51:14  Bison  
   
嗯呐  
   
> 21:53:33  Bison  
   
提高取一次商户余额的效率，取一次商户余额，把该商户目前队列里未处理的请求的金额都扣除掉，然后更新数据库  
   
> 21:54:17  Bison  
   
而不是一个实付请求取一次，扣减一次  
   
> 21:54:40  Bison  
   
不知有朋友这样实现过没有  
   
> 21:54:50  Bison  
   
有没有什么坑  
   
> 21:55:37  李丹  
   
好像没有??  
   
> 21:56:26  风行天下  
   
我们的是先冻结，入库；之后再解冻，走单笔；  
   
> 21:58:43  北京一张泽雄  
   
道理是一样的，不垫款原则  
   
> 21:59:31  龚晓冬  
   
嗯，先收妥后支付  
   
> 21:59:38  风行天下  
   
嗯，单笔付时余额不足，就直接失败了。  
   
> 21:59:43  王晓东  
   
联想自己也开始做金融了  
   
> 22:10:56  Bison  
   
jv  
   
