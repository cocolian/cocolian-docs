---
layout:     source 
title:      "2017-05-26-WeChat"
date:       2017-05-26 12:00:00
author:     "PaymentGroup"
tag:		  [chat]
header-img: "img/post-bg-wechat.jpg"
---
> 01:10:25  david-橙子支付-技术总监  
   
@雪鹰-快捷通-架构? 渠道路由流程这个图是用了责任链模式去实现的？  
   
> 01:11:19  david-橙子支付-技术总监  
   
@雪鹰-快捷通-架构?在高并发下，渠道电如何去分流的？  
   
> 08:10:28  龚正-滴滴-支付金融  
   
![2017-05-26 08:10:28](http://static.cocolian.cn/img/20170526_081028.png) 
   
> 08:21:37  MEET  
   
独家：关于现代金控清算异常事件的通报！2次事件重复到账涉及4.5亿多！  
   
> 08:22:13  MEET  
   
这就是因为技术不严谨问题造成的  
   
> 08:23:51  张泽雄-民生金服 项目总监  
   
现代金控？就是中国能源下面那家？  
   
> 08:30:26  张泽雄-民生金服 项目总监  
   
专业的事一定要专业人去做，对于金融一定要敬畏  
   
> 08:37:27  李钦珑-深圳优讯-PM  
   
在理[强]  
   
> 08:37:56  袁军-架构师-快捷通  
   
@张泽雄-民生金服-研发-北京? 那个paid settled都发消息的  
   
> 08:40:56  张泽雄-民生金服 项目总监  
   
@雪鹰-快捷通-架构?嗯，了解，关于回调地址你们是存在订单系统还是在创建订单时候直接拆分到了通知系统？  
   
> 08:44:25  袁军-架构师-快捷通  
   
@david~圈存~广州? 责任链-过滤器，分流多个通道分配不同权重，比如三个通道权重100:100:50，就是250笔交易的话分别有100笔，100笔，50笔。  
   
> 08:44:33  张泽雄-民生金服 项目总监  
   
我在规划交易平台微服务化，每个模型都想精简下  
   
> 08:52:14  李小-交通银行商户运营 支付PM  
   
每天早上爬楼学知识，受益良多  
   
> 08:54:24  我  
   
20170524交流记录和专题  
   
> 08:54:53  我  
   
感谢@雷敏-结算中心-产品?的工作  
   
> 08:55:20  华-南京亚软-IT总监  
   
在支付平台大家的运维保障是怎么做的，研发，运维比重是多少？  
   
> 08:56:24  李钦珑-深圳优讯-PM  
   
感谢  
   
> 08:56:51  袁军-架构师-快捷通  
   
@张泽雄-民生金服-研发-北京?订单系统，要发通知去取回调地址。  
   
> 08:58:37  张泽雄-民生金服 项目总监  
   
了解了，谢谢，我想把业务和非业务的分开  
   
> 08:58:45  袁军-架构师-快捷通  
   
商户回调地址可能每笔都不一样，一般校验域名或IP，  
   
> 08:59:43  张泽雄-民生金服 项目总监  
   
是不一样，每个订单对应一个回调地址  
   
> 09:04:38  龚正-滴滴-支付金融  
   
【D  早报】 2017-5-26  星期五  【新闻】 1、58同城第一季度未经审计的财务报告。实现营收19.883亿人民币，人民币同比增长31.7%，超过公司18.55亿人民币的预期上限；毛利为17.887亿人民币，人民币同比增长32.4%；  2、星巴克近期在中国市场投放了两款即饮产品——瓶装红茶星冰乐与瓶装抹茶星冰乐，已率先在天猫超市上线。官方称综合了中国境内上千家星巴克店铺的数据，发现抹茶及红茶类饮品的在店内的购买量长期居于前列；  3、金山软件执行董事兼首席财务官吴育强表示，旗下北京办公软件获得中证监批准，建议于深交所创业板上市，预期明年上半年上市，届时金山软件仍会作为大股东持有60%股份；  4、熊猫直播宣布获得10亿元B轮融资，本轮融资由兴业证券兴证资本领投，汉富资本、沃肯资本、光源资本、中冀投资、昌迪资本、明石投资跟投，光源资本担任此次融资独家财务顾问。本轮融资的资金将用于建立完备的内容生态体系以及拓展团队；  5、阿里巴巴领投饿了么最新一轮最少10亿美元融资。此轮投资后，饿了么的估值约为55亿美元到60亿美元。2016年4月，饿了么宣布获得12.5亿美元的投资，阿里巴巴和蚂蚁金服分别出资9亿美元和3.5亿美元；  6、《2016年度中国网络零售市场数据监测报告》显示，2016年国内生鲜电商整体交易额约913亿元，同比2015年增长80%，2017年整体市场规模可达1500亿元。全国4000多家生鲜电商企业中只有1%实现盈利，7%巨亏、88%亏损、4%持平；  【政策】 1、北京市住建委获悉，今后5年，北京市将继续加大租赁住房供应，计划供地1300公顷，建设租赁住房50万套，并主要通过集体建设用地安排。  
   
> 09:06:26  李征烈-钱通支付PM  
   
[西瓜]  
   
> 09:14:57  袁军-架构师-快捷通  
   
关于现代金控那个，超时处理机制有问题吧。首先超时不能就认为失败！我理解2个概念重发，重路由。重发：原通道重发，不改变订单号，银行保证幂等性。重路由：重新路由选择通道出款，重路由风险都比较大，改变订单号也算重路由。不建议系统自动，不能保证银行哪天返回结果有问题。  
   
> 09:18:05  胡新松-银联  
   
现代金控又出事了啊？  
   
> 09:22:58  李小-交通银行商户运营 支付PM  
   
这次是小钱  
   
> 09:32:02  占进冬-科大讯飞-开发组长  
   
有银行卡签约相关的资料吗？  
   
> 09:32:40  占进冬-科大讯飞-开发组长  
   
计划做这块，但不太了解  
   
> 09:35:02  王晗  
   
@雪鹰-快捷通-架构?问一下银行一般有频次限制，这里流控怎么弄呢？  
   
> 09:47:13  david-橙子支付-技术总监  
   
@雪鹰-快捷通-架构 对于商户的同一个商户订单号发起多次支付，订单系统里的订单是多笔吗？  
   
> 09:49:03  名叫旺达的鱼  
   
应该是一笔，支付记录可能多条  
   
> 09:51:55  名叫旺达的鱼  
   
@david~圈存~广州 我也想了解一下这个问题，  银行那边的订单号不能重复，如果上次未完成支付，网银这种情况，如果再次支付的话，重新生成一条支付记录，  在提交到银行，但是商户提交过来的订单就只有一条。  
   
> 09:53:31  王晗  
   
多次支付，支付订单应该是多笔，对于交易的订单是一笔，交易订单1：N支付订单  
   
> 09:54:45  袁军-架构师-快捷通  
   
入款你换订单号没关系的，顶多退款。前面说的针对出款的  
   
> 09:55:15  袁军-架构师-快捷通  
   
出款那样会资损的。  
   
> 09:55:39  袁军-架构师-快捷通  
   
单号不一样就是2笔  
   
> 09:57:17  名叫旺达的鱼  
   
这个单号，是指支付系统生成发 给银行的订单号，还是商户生成的订单号  
   
> 09:57:36  袁军-架构师-快捷通  
   
一笔交易多次支付，后面的自动退款就好了。  
   
> 09:58:14  袁军-架构师-快捷通  
   
交易订单，支付订单，机构订单（银行）  
   
> 10:00:29  袁军-架构师-快捷通  
   
一笔交易可以多次支付，支付订单正常来说和机构订单1VS1，重路由的话1VS多。  
   
> 10:04:09  张泽雄-民生金服 项目总监  
   
银行那边好像只有成功交易才不允许单号重复吧？  
   
> 10:04:13  名叫旺达的鱼  
   
嗯，我这边发生过重复支付的情况，  第一次支付（网银），支付完成后未收到回执， 支付订单还是未支付状态，这时用户在此支付，就出现重复支付了。 原本我是在第二次支付之前，查询前一次支付的支付状态， 发现效率很低。    
   
> 10:05:15  名叫旺达的鱼  
   
我对接的银行，无论是否成功，  订单号都不能重复。  
   
> 10:05:46  名叫旺达的鱼  
   
所以每次发起都要生成一条支付记录  
   
> 10:08:08  张泽雄-民生金服 项目总监  
   
如果是偶尔的话对账时对出差错，自动退就行  
   
> 10:08:30  张嘉杰  
   
你付多少次都行无所谓~ 后续走自动退款流程~  
   
> 10:08:55  张泽雄-民生金服 项目总监  
   
用户疯了  
   
> 10:09:45  蘑菇街_陈宗  
   
收银台需要引导用户不能做重复支付，否则用户会疯掉  
   
> 10:09:50  名叫旺达的鱼  
   
有可能会，体验会比较差  
   
> 10:09:56  张泽雄-民生金服 项目总监  
   
网银不是有前台通知和后台通知吗，前台通知也慢？  
   
> 10:11:00  蘑菇街_陈宗  
   
例如 支付宝 app支付，只有后台的通知，这种情况下，后台通知延迟的情况下，用户有可能会重复支付  
   
> 10:11:06  名叫旺达的鱼  
   
目前只有前台通知，要么主动查询  
   
> 10:12:27  名叫旺达的鱼  
   
前台通知也有不靠谱的，银行支付成功后，出现一个页面倒计时5秒之后回通知网关，这时页面被关闭了，就通知不到了  
   
> 10:14:19  张泽雄-民生金服 项目总监  
   
这种情况下，前端系统最好给用户提示一下  
   
> 10:16:10  蘑菇街_陈宗  
   
后端主动查询网银，前端轮询交易订单状态  
   
> 10:17:14  张嘉杰  
   
不是用户疯掉的问题~ 比如周杰伦演唱会，票源紧张，用户的需求就是要买到票，第三方支付返回就是有点问题，这时用户立马会换其他支付方式，直到看到支付成功。然后才会联系客服：提供第三方支付成功流水，要求退余款~  
   
> 10:18:51  蘑菇街_陈宗  
   
一般这种同一交易单，多支付单情况，支付系统内部需要对晚通知的支付单做异常退款，且发送异常退款消息给到用户。  
   
> 10:20:40  蘑菇街_陈宗  
   
另外一个，我觉得啊，例如买票的行为，在用户下单的时候，订单会有一个锁定期，比如15min，在锁定期内支付就行  
   
> 10:20:45  乔俊翔-爱又米-支付开发  
   
重复支付的情况在收银台要做下控制，用户切换支付方式重新支付，要查询下之前一笔第三方的支付状态，明确返回失败，才允许用户继续支付，否则提示支付处理中  
   
> 10:21:40  dio  
   
问一下 各位  如果说电商后台对账模块   一般是怎么做   有没有调账这个功能  
   
> 10:23:31  蘑菇街_陈宗  
   
重复支付这个问题，假设存在支付宝、微信俩支付方式，用户请求支付宝，但是不做支付。  由于支付宝未支付，且未支付失败，那么这个时候，用户使用微信支付就不行了  针对这种情况，各位是如何做的呢？  
   
> 10:23:55  张泽雄-民生金服 项目总监  
   
如果是偶发，怎么处理都行，比如后台自动换通道  
   
> 10:25:50  蘑菇街_陈宗  
   
这是一个正常的用户行为，比如用户一开始使用支付宝，后来发现想用微信来支付。  
   
> 10:25:56  dio  
   
我的问题有没有人帮我解决一下    
   
> 10:26:13  张泽雄-民生金服 项目总监  
   
可以支付啊，没问题啊，直接支付  
   
> 10:26:38  袁军-架构师-快捷通  
   
同笔交易快捷支付前一笔状态处理中，我们限制3分钟不能在支付。网银我们不做限制  
   
> 10:27:21  张泽雄-民生金服 项目总监  
   
调账是财务功能，差错出来了通过交易去平  
   
> 10:27:33  袁军-架构师-快捷通  
   
尝试下来还行，只要渠道别大量长时间掉单  
   
> 10:27:38  蘑菇街_陈宗  
   
快捷支付可以做限制。但是其他的三方支付，交易单我们没有做限制。  
   
> 10:28:04  蘑菇街_陈宗  
   
渠道大量掉单，或者通知延迟的情况下，会造成大量的重复支付  
   
> 10:28:15  张泽雄-民生金服 项目总监  
   
订单不用限制，以当前实时状态为  
   
> 10:28:18  张泽雄-民生金服 项目总监  
   
准  
   
> 10:28:35  袁军-架构师-快捷通  
   
三方行为不可控的  
   
> 10:29:01  袁军-架构师-快捷通  
   
快捷支付是肯定支付的  
   
> 10:29:03  蘑菇街_陈宗  
   
三方支付由于用户可在三方的app上进行任何操作，同时也可停顿  
   
> 10:29:13  蘑菇街_陈宗  
   
和快捷支付行为不一致  
   
> 10:30:00  袁军-架构师-快捷通  
   
我们也试过的，用户影响很大  
   
> 10:30:05  张泽雄-民生金服 项目总监  
   
所以，这种情况下不做限制  
   
> 10:30:07  袁军-架构师-快捷通  
   
还是去掉了  
   
> 10:31:04  蘑菇街_陈宗  
   
对，所以现在回到原问题，这种无限制的情况下，如何防止用户大量重复支付行为  
   
> 10:31:10  蘑菇街_陈宗  
   
收银台引导是一方面  
   
> 10:31:13  张嘉杰  
   
@铁手_蘑菇街_技术_杭州 我们现在就是允许支付~ 后退款~  
   
> 10:31:22  蘑菇街_陈宗  
   
恩，我们现在也是  
   
> 10:31:45  蘑菇街_陈宗  
   
但是原路退款到账时间不定，对用户的体验会有影响  
   
> 10:32:08  袁军-架构师-快捷通  
   
@小吴_产品-承泰-上海? 调账就是个最简单的支付流程。在会计上对应有个会计凭证。  
   
> 10:33:46  张嘉杰  
   
嗯~ 余额支付是实时到账~ 其他的原路退时间不定~  
   
> 10:34:06  dio  
   
电商类型的对账后台          需要调账功能吗       我目前这个系统不需要所谓的会记凭证  
   
> 10:34:29  张泽雄-民生金服 项目总监  
   
你说的调账是啥  
   
> 10:34:56  蘑菇街_陈宗  
   
电商类型的对账后台  电商系统里面的支付对账吗？  
   
> 10:35:35  张泽雄-民生金服 项目总监  
   
对于支付宝和微信这两种支付方式，可以不做限制  
   
> 10:35:38  袁军-架构师-快捷通  
   
重复支付但一般成功不多，直链银行退款效率不错的，比银联好多了  
   
> 10:35:59  袁军-架构师-快捷通  
   
只是发起很多次  
   
> 10:36:01  dio  
   
不是支付机构类型的     系统目前只是要知道交易成功或者失败  然后跟第三方核对一下   这个需不需要有类似于支付机构那种差错帐处理  
   
> 10:36:51  dio  
   
调账就是   对支付订单进行操作呀   每个支付系统都有的吧    挂账   入账   退款  这类的  
   
> 10:38:10  袁军-架构师-快捷通  
   
调账是账记错了，业务都已经处理完后的。  
   
> 10:38:46  袁军-架构师-快捷通  
   
业务都还在处理中，那不是调账吧。我理解是这样啊  
   
> 10:38:52  张泽雄-民生金服 项目总监  
   
这个你可以做也可以不做，关键是要形成差错，你说的调账其实是个差错处理，找到原因，多的退了，少的补上  
   
> 10:39:03  dio  
   
是的     
   
> 10:40:29  dio  
   
主要是目前要做的这个系统其实     没有多退少补这概念     说白了就是一个记录  就是知道交易到底有没有成功     
   
> 10:41:10  dio  
   
接的是第三方支付   所以不清楚要不要这个   
   
> 10:42:11  蘑菇街_陈宗  
   
是指内部交易系统与第三方系统对账之后的处理？  
   
> 10:42:16  张泽雄-民生金服 项目总监  
   
正常情况下是不区分电商不电商的，别人欠自己的钱，还的钱对不对，这就是对账。你说的这个是比较简单的流水勾兑，  
   
> 10:42:33  张泽雄-民生金服 项目总监  
   
或者叫台账  
   
> 10:42:43  dio  
   
是的  
   
> 10:43:26  张泽雄-民生金服 项目总监  
   
流水沟兑只是信息流，你的资金对不对？  
   
> 10:44:03  dio  
   
要知道资金有没有交易成功  
   
> 10:44:38  王晓韡-通联支付-PM  
   
有的资金没有交易状态  
   
> 10:44:43  王晓韡-通联支付-PM  
   
这就是需要对帐  
   
> 10:45:04  王晓韡-通联支付-PM  
   
以某一方为准  
   
> 10:45:14  dio  
   
内部交易系统跟第三方系统对账   资金对账要怎么对  
   
> 10:45:49  王晓韡-通联支付-PM  
   
无非就是对状态  
   
> 10:45:51  王晓韡-通联支付-PM  
   
一样的  
   
> 10:47:03  dio  
   
那需要差错对账吗  就是 把勾兑没成功的挂起  然后跟第三方支付校核  对订单状态进行人工操作？  
   
> 10:48:12  张泽雄-民生金服 项目总监  
   
资金对账有两方面对，一个是看每一笔的金额是不是对，总额是不是对，另一个是要看对方打到银行账户上的钱，是不是和总额对得上。  
   
> 10:51:10  张泽雄-民生金服 项目总监  
   
你会计系统都没有，这些可以不要，只要能将差错核销掉就行。  
   
> 10:51:25  dio  
   
问题是我就是个撮合交易网站   类似于电商或者P2P类型的   而且我还没办法对资金进行调拨    我的对账目的就是要知道每天交易的资金是否交易成功     显示给用户看    这种情况下有没有必要多一个所谓的差错帐处理     
   
> 10:52:16  dio  
   
这里扩展的问一下   如果是正规的电商网站   这块是怎么做的   
   
> 11:54:50  何鹏飞-猪八戒网支付产品经理  
   
请问下 如果用户在商户有余额，在使用快捷支付的时候，应不应该支持组合支付呢？  
   
> 11:55:19  蘑菇街_陈宗  
   
理论上可以，但是貌似大家都不做支持  
   
> 11:55:42  何鹏飞-猪八戒网支付产品经理  
   
这个快捷支付卡，有第一次绑定做支付的，也有之前完成过支付的卡  
   
> 11:56:22  何鹏飞-猪八戒网支付产品经理  
   
我看京东是支持 现有快捷卡+余额 的组合支付的  
   
> 11:56:23  蘑菇街_陈宗  
   
这种组合支付，以外部渠道为先，例如快捷支付完成之后，才会做余额扣款  
   
> 11:56:39  张泽雄-民生金服 项目总监  
   
做肯定能做，但会把交易拉长  
   
> 11:56:46  何鹏飞-猪八戒网支付产品经理  
   
但是没有支持 新绑卡+余额 的组合支付  
   
> 11:57:28  何鹏飞-猪八戒网支付产品经理  
   
而且收银台的逻辑会变的很复杂@张泽雄-民生金服-研发-北京?  
   
> 11:57:32  蘑菇街_陈宗  
   
技术层面上没有问题，但是提供组合支付对业务的帮助并不大，很多公司应该都砍掉这块的支持  
   
> 11:58:28  何鹏飞-猪八戒网支付产品经理  
   
不晓得评审能不能通过，因为现在收银台是支持 余额+第三方  和余额+网银的  
   
> 11:59:11  何鹏飞-猪八戒网支付产品经理  
   
谢谢两位大大  
   
> 12:00:27  Chess-技术总监 首付游   
   
[强]  
   
> 12:04:48  张嘉杰  
   
@何鹏飞-猪八戒-支付产品-重庆 你们公司产品刘伟之前做过组合支付业务，直接请教就可以了~  
   
> 12:05:57  何鹏飞-猪八戒网支付产品经理  
   
@南迪-永乐-架构-北京?嗯嗯  
   
> 12:06:06  何鹏飞-猪八戒网支付产品经理  
   
[抱拳]  
   
> 12:08:15  郭芬-中央结算公司  
   
调账，在我们这是作为一个应急功能  
   
> 12:09:42  张泽雄-民生金服 项目总监  
   
是的，调账相当于直接改账，要双岗加审核的  
   
> 12:14:43  郭芬-中央结算公司  
   
我举一个我们目前现实的例子，大家看看用得对不对，买卖双方，原本双方线下商量好，以1000W，成交，最后因为输入错误，输入了100W。  
   
> 12:16:49  郭芬-中央结算公司  
   
这是由交易双方，提交申请，可以进行调账。调账有两种方式，一种是调资金帐，相当于由买房直接向卖方支付900W。或者调资产账，将交易的资产由原来的数量，调整到100W的价值，再由双方再做一笔交易。  
   
> 12:17:33  郭芬-中央结算公司  
   
我是我们现实发生过的例子  
   
> 12:17:41  郭芬-中央结算公司  
   
少输了个0  
   
> 12:17:52  蔡云龙 开联通支付  
   
我感觉这种场景应该让他们退款后重新交易  
   
> 12:18:54  郭芬-中央结算公司  
   
那资产也退回到卖方么，那也得进行调账。或者系统直接做一个退回交易的功能。目前我们系统没有  
   
> 12:21:12  郭芬-中央结算公司  
   
已经完成的订单，进行撤销，这个大家怎么做的。这礼拜，我们这出现了几次，用户输错流转金额的情况。  
   
> 12:22:43  蘑菇街_陈宗  
   
订单层面上记录下来的就是100w吗？  我的感觉也是做退款，再下个单  
   
> 12:23:05  郭芬-中央结算公司  
   
对，记录的就是100W  
   
> 12:23:35  蔡云龙 开联通支付  
   
估计他们这种和普通支付不一样  
   
> 12:23:38  郭芬-中央结算公司  
   
那退款是做一个反向交易来实现么  
   
> 12:24:05  郭芬-中央结算公司  
   
资产回到卖方，资金回到买方？  
   
> 12:24:17  蔡云龙 开联通支付  
   
如果是普通支付系统我就建议退款或者撤销  
   
> 12:25:25  蘑菇街_陈宗  
   
假设你们做逆向交易，会不会带来额外的问题？  
   
> 12:25:42  郭芬-中央结算公司  
   
我们如果做反向交易的话，系统里头就会出现两个结算通知单，跟业务人员讨论过，觉得不合适。  
   
> 12:26:34  郭芬-中央结算公司  
   
我们每笔交易，都会出具一份加盖公章的结算通知单，表明资金和资产的过户。  
   
> 12:28:01  郭芬-中央结算公司  
   
但我觉得还是系统设计层面的问题，因为系统是AS400，RPG做的，不太敢动交易的各种状态，不然应该会比较好做。  
   
> 12:31:15  蘑菇街_陈宗  
   
那如果直接调账，订单层面上还是100w，还是直接改成1000w，人工介入做订单的订正  
   
> 12:31:54  郭芬-中央结算公司  
   
调账就是直接改帐了，订单层面不改  
   
> 12:34:38  郭芬-中央结算公司  
   
就是一个资产或者资金的划拨过程  
   
> 12:36:26  韩财光  
   
@郭芬-中央结算（中债登）-北京?加一个机器校验环节 类似注册时输入两次密码 提交前让程序参与比对？  
   
> 12:38:04  郭芬-中央结算公司  
   
机器没法比对啊，因为客户输的就是1000000000，但是他以为他输入的10000000000。我觉得加一个数字到中文的转换会比较合适  
   
> 12:38:34  郭芬-中央结算公司  
   
人数0，容易数错，但是中文一看就明白  
   
> 12:39:13  郭芬-中央结算公司  
   
比如说自动识别他输入的一千万  
   
> 12:42:46  freewolf-天津金融资产交易所技术  
   
调账属于人工发起的行为 不能系统发起吧  
   
> 12:43:41  郭芬-中央结算公司  
   
对，人工发起  
   
> 12:43:54  郭芬-中央结算公司  
   
双人复核  
   
> 12:44:43  郭芬-中央结算公司  
   
如果没有进入结算环节，我们也直接改过数据库  
   
> 12:44:50  郭芬-中央结算公司  
   
改订单信息  
   
> 12:45:54  韩财光  
   
支付多少系统不能预先知道吗 或者1'000'000  
   
> 12:47:09  郭芬-中央结算公司  
   
预先知道的是客户输入的价格啊，客户数错了。  
   
> 12:48:43  郭芬-中央结算公司  
   
我们的交易是非标准化的，没有固定的价格，客户线下商量好价格，再来做,多少都行  
   
> 12:50:21  dio  
   
@郭芬-中央结算（中债登）-北京?你说的调账的意思跟我说的是一样的，调账就是出现异常然后手工去处理的  
   
> 12:50:33  方祜桔  
   
调账之后订单和账务怎么对账呢  
   
> 12:50:47  方祜桔  
   
900万和谁去对？  
   
> 12:51:22  dio  
   
他的情况下。要在做一次交易，交易900万  
   
> 12:51:33  韩财光  
   
和转账汇款这种吗 那就转成汉字提示甚至语音提示  
   
> 12:51:48  郭芬-中央结算公司  
   
嗯嗯  
   
> 12:52:23  郭芬-中央结算公司  
   
调账也是一笔特殊的交易，只能由中心端发起，对账的时候没问题。  
   
> 12:54:00  郭芬-中央结算公司  
   
如果平白无故一个账户增加900w,一个账户减少900万，那是改数据库了，不是调账了。  
   
> 12:54:37  dio  
   
你肯定要客户再做一次900万的交易的  
   
> 12:55:26  郭芬-中央结算公司  
   
不一定，因为资产也是托管在我们这的，我们直接对资产调账也行。  
   
> 12:55:37  张泽雄-民生金服 项目总监  
   
补一笔调账交易就行，  
   
> 12:55:38  dio  
   
我目前系统跟你们那个大型债券系统其实有点类似，你有空就说说你们这块怎么弄的吧  
   
> 12:56:28  郭芬-中央结算公司  
   
哈哈，好  
   
> 14:06:24  徐传-收付通-研发部门经理  
   
大家的支付系统中的异步通知一般是多长时间通知多少次啊？  
   
> 14:08:11  孙军-中证互联PM  
   
群里面又做基金业务支付的吗  
   
> 14:19:02  Tim-深圳百灵鸟-架构  
   
一天8次  
   
> 14:19:52  Tim-深圳百灵鸟-架构  
   
有谁做过影院票务系统，想咨询一个问题  
   
> 14:24:48  刘伟-猪八戒-高级PM  
   
我··  
   
> 14:25:21  Tim-深圳百灵鸟-架构  
   
你们的票务系统订场那块是怎么设计的，  
   
> 14:25:35  刘伟-猪八戒-高级PM  
   
私聊  
   
> 14:25:44  Tim-深圳百灵鸟-架构  
   
可以  
   
> 14:25:55  Tim-深圳百灵鸟-架构  
   
通过以下，谢谢  
   
> 14:28:20  胡圣 支付产品经理 猪八戒网  
   
Tim 这个问题记得你一周前问过= =  
   
> 14:28:49  Tim-深圳百灵鸟-架构  
   
恩，没有人深入的聊过  
   
> 15:09:12  张泽雄-民生金服 项目总监  
   
有没有玩lambda架构的朋友？  
   
> 15:18:05  freewolf-天津金融资产交易所技术  
   
lambda架构是啥 不是lambda表达式吗[呲牙]  
   
> 15:18:30  张泽雄-民生金服 项目总监  
   
不是  
   
> 15:19:23  pangning-安邦集团收付团队研发  
   
大数据的东西？  
   
> 15:20:21  张泽雄-民生金服 项目总监  
   
![2017-05-26 15:20:21](http://static.cocolian.cn/img/20170526_152021.png) 
   
> 15:21:05  张泽雄-民生金服 项目总监  
   
大数据计算的  
   
> 15:21:34  freewolf-天津金融资产交易所技术  
   
不开玩笑了 大数据处理架构 这玩意比较复杂  
   
> 15:23:09  张泽雄-民生金服 项目总监  
   
有没有哪位已经应用到系统中的，谈谈有没有什么坑  
   
> 15:23:46  张泽雄-民生金服 项目总监  
   
我打算用在风控系统中用这个架构  
   
> 15:24:59  freewolf-天津金融资产交易所技术  
   
Netflix不是有一套基于lambda的推荐架构吗  
   
> 15:25:06  freewolf-天津金融资产交易所技术  
   
你可以搜一下  
   
> 15:25:13  邹成凯-联通支付  
   
![2017-05-26 15:25:13](http://static.cocolian.cn/img/20170526_152513.png) 
   
> 15:25:20  邹成凯-联通支付  
   
阿里  现在用的这个  
   
> 15:28:51  freewolf-天津金融资产交易所技术  
   
apache flink 资料还多一些  
   
> 15:29:02  邹成凯-联通支付  
   
是的  
   
> 15:32:06  张泽雄-民生金服 项目总监  
   
我先看看吧，谢谢  
   
> 18:20:55  马忠信-联金所-深圳  
   
各位，认证支付和快捷支付到底有什么区别啊，我看用户填写身份信息和银行卡信息是一样的  
   
> 18:21:40  潘儒刚-连连支付PM  
   
验的要去不一样  
   
> 18:21:51  潘儒刚-连连支付PM  
   
要素  
   
> 18:22:40  马忠信-联金所-深圳  
   
不过在用户端填写的信息一样不少啊  
   
> 18:23:42  马忠信-联金所-深圳  
   
![2017-05-26 18:23:42](http://static.cocolian.cn/img/20170526_182342.png) 
   
> 18:23:43  马忠信-联金所-深圳  
   
![2017-05-26 18:23:43](http://static.cocolian.cn/img/20170526_182343.png) 
   
> 18:24:00  马忠信-联金所-深圳  
   
第一张图是认证支付  
   
> 18:24:07  潘儒刚-连连支付PM  
   
认证是 姓名+身份证+银行卡+预留手机  送到渠道校验  全部通过了才能支付成功  
   
> 18:24:16  马忠信-联金所-深圳  
   
第二张是快捷支付  
   
> 18:24:40  马忠信-联金所-深圳  
   
@索马里-连连支付-风控-杭州?这个渠道是指各家银行吗  
   
> 18:24:52  张泽雄-民生金服 项目总监  
   
只是业务上的区别  
   
> 18:25:31  潘儒刚-连连支付PM  
   
一般都是四要素都要写   
   
> 18:26:05  张泽雄-民生金服 项目总监  
   
认证只全要素，快捷第一次也是全要素  
   
> 18:26:06  马忠信-联金所-深圳  
   
感觉用户要填的东西一样没少，可能是第三方支付传给银行的数据没那么多？  
   
> 18:26:41  潘儒刚-连连支付PM  
   
连连的认证是四要素全验  交易时送到各个渠道去校验，都通过了才成功   
   
> 18:26:46  马忠信-联金所-深圳  
   
认证支付现在都是预绑卡吧，感觉跟快捷支付没区别啊  
   
> 18:27:17  潘儒刚-连连支付PM  
   
因为有的银行校验的要素不是四要素   
   
> 18:27:18  马忠信-联金所-深圳  
   
我记得连连好像是不必同卡进出的  
   
> 18:27:49  张泽雄-民生金服 项目总监  
   
第一次快捷要这么多，完成了签约，认证是每次都要，是没有协议的  
   
> 18:28:23  潘儒刚-连连支付PM  
   
比如有的银行只校验身份证和银行卡  成功了就签约成功了    
   
> 18:28:35  张泽雄-民生金服 项目总监  
   
认证就是全要素快捷  
   
> 18:29:06  潘儒刚-连连支付PM  
   
不会吧 连连对所有理财商户都是同卡的 控的很严的   
   
> 18:32:10  马忠信-联金所-深圳  
   
@索马里-连连支付-风控-杭州 是，可以不用同卡进出  
   
> 18:32:15  张泽雄-民生金服 项目总监  
   
认证预绑卡也只是留简单信息，但没有协议，快捷属于协议支付。 认证和快捷都是无密支付  
   
> 18:32:16  马忠信-联金所-深圳  
   
只要是一个人就行  
   
> 18:32:46  马忠信-联金所-深圳  
   
所以交易密码只是商户要求用户输入的  
   
> 18:32:50  马忠信-联金所-深圳  
   
可以这样理解吧  
   
> 18:32:52  潘儒刚-连连支付PM  
   
哪一个商户是这样啊  
   
> 18:33:15  潘儒刚-连连支付PM  
   
@马忠信-联金所-深圳   
   
> 18:33:35  马忠信-联金所-深圳  
   
@索马里-连连支付-风控-杭州 [坏笑]我也不确定  
   
> 18:33:39  马忠信-联金所-深圳  
   
我记得好像是  
   
> 18:34:06  潘儒刚-连连支付PM  
   
历次支付可以协议支付的 @张泽雄-民生金服-研发-北京   
   
> 18:34:35  潘儒刚-连连支付PM  
   
用协议号  
   
> 18:35:24  马忠信-联金所-深圳  
   
@索马里-连连支付-风控-杭州 你们的资金存管业务现在怎么样  
   
> 18:35:35  马忠信-联金所-深圳  
   
p2p不让接了，其他商家呢  
   
> 18:35:50  马忠信-联金所-深圳  
   
还有哪些业务可以使用资金存管啊  
   
> 18:36:00  马忠信-联金所-深圳  
   
电商这种算吗？  
   
> 18:36:28  张泽雄-民生金服 项目总监  
   
协议是为了免责  
   
> 18:36:50  潘儒刚-连连支付PM  
   
目前已经合作的有 新网 北京  浙商 华瑞  微商 恒丰    
   
> 18:37:02  潘儒刚-连连支付PM  
   
其他的都在对接  
   
> 18:37:10  atom-汇付-产品-上海  
   
你们接了不少呀  
   
> 18:37:25  潘儒刚-连连支付PM  
   
就p2p要求严一点吧   
   
> 18:37:33  atom-汇付-产品-上海  
   
华瑞已经跟你接好了？  
   
> 18:37:40  潘儒刚-连连支付PM  
   
不然很多p2p会死掉的   
   
> 18:37:43  潘儒刚-连连支付PM  
   
对啊  
   
> 18:39:06  潘儒刚-连连支付PM  
   
不过商户对接的话也耗时间  
   
> 18:41:04  atom-汇付-产品-上海  
   
对接银行多开发成本好高  
   
> 18:45:13  马忠信-联金所-深圳  
   
是不是只有存管这一种情况，需要用户在第三方支付平台开通账户  
   
> 18:45:22  马忠信-联金所-深圳  
   
@索马里-连连支付-风控-杭州 @张泽雄-民生金服-研发-北京   
   
> 18:46:47  潘儒刚-连连支付PM  
   
应该是在银行开立账户  
   
> 18:46:54  李丹-风控经理-双乾支付  
   
存管只需要在银行注册了  
   
> 18:46:56  潘儒刚-连连支付PM  
   
不然就不是存管了  
   
> 18:48:44  潘儒刚-连连支付PM  
   
关键是资金银行，所有的支付指令都是投资人和借款人发起  
   
> 18:49:50  atom-汇付-产品-上海  
   
存管用户都是在银行开通账户，第三方支付平台会开平台的手续费账户，收费需要  
   
> 18:50:43  李丹-风控经理-双乾支付  
   
+1  
   
> 19:09:45  Yang  
   
我们的存管是在银行开账户是存管，第三方支付账户开商户账户用来结算资金  
   
> 19:10:45  Yang  
   
有些基金支付通路需要开通第三方支付的个人账户  
   
> 19:10:48  atom-汇付-产品-上海  
   
嗯嗯  
   
> 19:22:02  我  
   
微信红包  
   
> 19:22:07  我  
   
大家好，晚上由@张鑫-中金支付-开发-北京?为我们分享。老规矩，通过签到红包签到，谢谢。  
   
> 19:27:16  萌小喵-爱贝计费高级PM  
   
[玫瑰]  
   
> 19:27:38  atom-汇付-产品-上海  
   
[玫瑰]  
   
> 19:27:57  freewolf-天津金融资产交易所技术  
   
[玫瑰]  
   
> 19:28:04  build-去哪儿-QA  
   
[玫瑰]  
   
> 19:28:12  潘儒刚-连连支付PM  
   
[玫瑰]  
   
> 19:28:16  左晨  
   
棒棒哒  
   
> 19:28:47  我  
   
主题是支付账务系统设计。嘉宾分享期间不打断，分享后进入提问环节。  
   
> 19:28:54  李丹-风控经理-双乾支付  
   
[玫瑰]  
   
> 19:29:08  路杨 嘉联支付产品  
   
[玫瑰]  
   
> 19:29:09  万黎-恒丰银行-支付产品PM  
   
[玫瑰]  
   
> 19:29:38  Summer  梁夏  
   
[玫瑰]  
   
> 19:29:50  刘洪明-便利蜂支付  
   
[玫瑰]  
   
> 19:29:58  Jacky-Bluepay支付部门技术PL  
   
[玫瑰]  
   
> 19:30:06  程文东-拉卡拉PL  
   
[玫瑰]  
   
> 19:30:11  李钦珑-深圳优讯-PM  
   
[玫瑰]  
   
> 19:30:22  马忠信-联金所-深圳  
   
[玫瑰]  
   
> 19:30:27  (′???`)  
   
[玫瑰]  
   
> 19:30:38  C'est la vie-科蓝-PM-北京  
   
[玫瑰]  
   
> 19:30:47  饶嘉乐-深圳-腾讯  
   
[玫瑰]  
   
> 19:30:52  落雪飞花-农信互联-开发经理  
   
[玫瑰]  
   
> 19:30:59  刘朝晨-中行软件中心PM  
   
[玫瑰]  
   
> 19:31:01  典典子  
   
[玫瑰]  
   
> 19:31:24  李征烈-钱通支付PM  
   
[玫瑰][玫瑰]  
   
> 19:31:52  yinch-滴滴金融-研发  
   
[玫瑰][玫瑰][玫瑰]  
   
> 19:32:18  owl  
   
[玫瑰]  
   
> 19:32:32  我  
   
请@张鑫-中金支付-开发-北京?开始分享，谢谢。  
   
> 19:33:09  方祜桔  
   
[玫瑰]  
   
> 19:33:16  张鑫-开发总监 中金支付  
   
大家好，先简单自我介绍下，我一直做支付，现在在中金已经7年多了，主要是负责开发、架构、团队等方面的工作  
   
> 19:33:24  华-南京亚软-IT总监  
   
[玫瑰]  
   
> 19:33:32  Wall-E 爱贝云计费产品主管  
   
[玫瑰]  
   
> 19:33:40  沈一点-恒生电子-工程师  
   
[玫瑰]  
   
> 19:33:56  sunshine-苏宁金融  
   
[玫瑰]  
   
> 19:34:14  张鑫-开发总监 中金支付  
   
今天就自己理解的账务系统做一个简单的分享，这也是结合自身业务特点的一家之言，比较粗浅，总体而言我觉得账务会计、会员体系、清分对账等是比较复杂的  
   
> 19:34:21  肖勇  
   
[玫瑰]  
   
> 19:34:54  张鑫-开发总监 中金支付  
   
群里面牛人很多，我也是抛个砖出来，有什么不对的还请各位大牛指正。  
   
> 19:35:21  张鑫-开发总监 中金支付  
   
一、先说下账务系统的设计思路  
   
> 19:36:34  张鑫-开发总监 中金支付  
   
1 我们账务系统和会计系统是分开的，账务是基于我们开展的业务而设计，根据支付业务进行账务处理；而会计系统是面向于财务的复式记账。先简单说明下账务系统的上下文环境及系统边界：  
   
> 19:36:49  张鑫-开发总监 中金支付  
   
![2017-05-26 19:36:49](http://static.cocolian.cn/img/20170526_193649.png) 
   
> 19:37:50  张鑫-开发总监 中金支付  
   
2 这里面，业务系统不仅包括支付业务的处理系统，还包括会员系统。会员系统在领域模型设计上，主要就是三户模型，当然每个公司的的三户模型可能也不一样。这里表达的意思是会员系统里的账户和账务系统是有个映射关系的，会员的账户对外暴露  
   
> 19:39:14  张鑫-开发总监 中金支付  
   
3 之所以这样设计，还得结合整个支付系统的总体架构，整个支付系统在设计上总体体现了“以账务为核心”的思想，这也是账务系统在整个支付系统的定位。  
   
> 19:40:39  张鑫-开发总监 中金支付  
   
4 以账务为核心，最重点的是所有的出入金交易必须记账，记账成功的交易才算成功；记账不成功的，即使调用银行通道接口成功了发生了真实的资金流转也不能算成功，但这就要分情况处理。  
   
> 19:41:44  张鑫-开发总监 中金支付  
   
5 以账务为核心，还有一个细节是每一笔交易有一个账务成功时间，以账务成功时间来表示哪些交易纳入到清结算范围内。  
   
> 19:43:22  张鑫-开发总监 中金支付  
   
6 账务系统在设计的时候，正因为它是资金处理的核心，以账务为准，所以必须要高性能、系统稳定；也是因为这种定位，所以我们设计账务的时候，业务逻辑要尽量简单清晰，单一职责原则，从而保证系统的稳定，不易出错。  
   
> 19:44:53  张鑫-开发总监 中金支付  
   
大家搞开发的都知道，复杂不可控，因此账务系统是单边记账，而复式记账还得做数据库事务，强一致性怕性能会不理想。处于性能及巨大业务量的考虑我们做出了让步。  
   
> 19:45:35  张鑫-开发总监 中金支付  
   
有些公司的账务系统设计是完全双边记账；有些则是先记录单边，事后生成另外一边。  
   
> 19:47:22  张鑫-开发总监 中金支付  
   
7账务记录成功了之后，会异步调用会计复式记账，给会计系统提供原始凭证；会计系统根据会计分录进行记账。  
   
> 19:48:04  张鑫-开发总监 中金支付  
   
8 账务技术上采用异步回调的方式去调用会计，通过回调函数取得会计的处理结果，来判断会计是否处理成功，从而来尽量的确保会计处理是成功的；如果会计响应失败，比如通信异常之类的，我们会后续将所有异常情况批量处理。  
   
> 19:48:54  张鑫-开发总监 中金支付  
   
没用mq，因为mq不能返回会计系统的响应结果，或者mq还得弄2个队列来处理，比较麻烦。微服务的设计上，还是将账务会计分开，也是根据账务系统的定位做了取舍。  
   
> 19:51:34  张鑫-开发总监 中金支付  
   
9 顺便说下会计系统，会计核算体系里设计了三级会计科目结构；但是会计系统并未包含非支付业务的资金活动，那个不是会计系统的考虑范畴，只包含备付金变化的资金活动，。比如说公司今天采购了100w的服务器设备且已经付款，借：固定资产 100w，贷：银行存款 100w，会计系统不管这个，因为和支付业务无关。  
   
> 19:52:05  张鑫-开发总监 中金支付  
   
二、再说下账务系统的具体功能  
   
> 19:52:31  张鑫-开发总监 中金支付  
   
其实总体思路是最重要的，定好了之后，后续都是细节上的具体实现了。  
   
> 19:53:55  张鑫-开发总监 中金支付  
   
1 系统目标 为客户提供电子货币的支付结算服务、支撑内部核算、提供充值，提现，转账，冻结，解冻，开户等原子交易及少量非原子操作、 提供对账系统数据来源，并有日切功能……等等吧，但最重要的就是上述功能  
   
> 19:55:36  张鑫-开发总监 中金支付  
   
2 账务系统记录的关键信息包括： 账户信息：账号、账户类型、余额、币种、状态、开户时间、操作员、冻结金额等 账户流水：交易时间、期初余额、发生额、余额、日切点等  
   
> 19:56:35  张鑫-开发总监 中金支付  
   
3 账户本身的开户销户冻结解冻就不说了，根据自身的业务规则来设计这几个的逻辑，比如说可用余额不为0，是否允许销户  
   
> 19:57:38  张鑫-开发总监 中金支付  
   
一般的功能就不说了，主要是说下我觉得比较重点的功能：  
   
> 19:58:29  张鑫-开发总监 中金支付  
   
4 转账：比如账户A向账户B转账，我们的做法是将A与B账户用悲观锁锁行，然后分别更新两个账户的金额。  
   
> 20:01:16  张鑫-开发总监 中金支付  
   
5 组合记账：比如说账户先解冻，再支付，是个组合的操作。由于这个操作都是在一个系统里，连接的是一个数据库，直接是数据库事务了，不用考虑分布式事务或柔性处理等。  
   
> 20:03:15  张鑫-开发总监 中金支付  
   
6 热点账户：基本上解决办法有2种，缓冲记账法、二级子账户法。我们采用缓冲。对于入金类的交易，有热点账户的用缓冲记账是没问题的；对于出金类的交易，就要慎重了，可能会造成资金损失。  
   
> 20:05:06  张鑫-开发总监 中金支付  
   
那么如果某个商户信用度较好，出金的缓冲超出额度，后续商户户会补回来，或者在商户信用度范围内，那么出金缓冲也没问题。我们现在出金，比如代付类交易，没用缓冲记账，就还是采用悲观锁来做。  
   
> 20:07:50  张鑫-开发总监 中金支付  
   
7 账务日切：每天日终，日切job按日切日统计系统所有账户的流水，根据流水分别算出每个账户的期初余额与期末余额。主要思想就是A账户T日的期初余额=A账户T-1日的期末余额  
   
> 20:08:51  张鑫-开发总监 中金支付  
   
差不多了，我的分享就到此结束，比较粗浅，还请包涵。  
   
> 20:09:21  李伟锋  
   
[玫瑰]  
   
> 20:09:32  郭芬-中央结算公司  
   
[强]  
   
> 20:09:34  李奔-富友-支付PM  
   
[强]  
   
> 20:09:40  煜-易物网-技术总监  
   
[玫瑰]  
   
> 20:09:43  车睿??  
   
[强]  
   
> 20:09:54  刘毅  
   
谢谢！分享的很好，老师什么时候分享会计系统  
   
> 20:09:55  atom-汇付-产品-上海  
   
[玫瑰]  
   
> 20:10:00  方祜桔  
   
[强]  
   
> 20:10:10  牙印儿-新浪支付产品经理  
   
[强]听到很多陌生词，能解释下悲观锁是什么意思吗，求教  
   
> 20:10:18  我  
   
谢谢，[玫瑰]， 以下是QA时间。   
   
> 20:10:19  张嘉杰  
   
[玫瑰]  
   
> 20:10:20  龚伏兰  
   
[玫瑰]  
   
> 20:10:28  郭芬-中央结算公司  
   
我也对会计系统感兴趣  
   
> 20:10:31  豆角茄子-卡友支付-PM  
   
[强]  
   
> 20:10:50  郭芬-中央结算公司  
   
求分享  
   
> 20:11:00  煜-易物网-技术总监  
   
转账那个，有多少几率会死锁？？  
   
> 20:11:15  蘑菇街_陈宗  
   
[强]学习了  
   
> 20:11:25  李钦珑-深圳优讯-PM  
   
[强]  
   
> 20:12:03  张鑫-开发总监 中金支付  
   
我们自己测试过，采用悲观锁锁行记录，其实性能还可以，但是测试报告的具体指标我不记得了，不用太担心。  
   
> 20:12:04  蘑菇街_陈宗  
   
6 热点账户：二级子账户法 这种方式能说下吗？  
   
> 20:12:34  刘毅  
   
转账功能能否出账账户采用悲观锁，入金账户采用缓冲入账呢  
   
> 20:13:06  付生廷-为源信息  
   
[强]  
   
> 20:13:48  路杨 嘉联支付产品  
   
感谢分享  
   
> 20:14:00  王晓韡-通联支付-PM  
   
今天讲的很不错  
   
> 20:14:02  王晓韡-通联支付-PM  
   
谢谢  
   
> 20:14:07  李伟锋  
   
问下 为什么账务报会计分录还要通过回调知道结果呢，这样给账务增加了不少负担， 假如通过异步消息  可以通过多种手段来核实分录是否都落成功的，并且到日切时候才需要校验分录 也不需要很及时？  
   
> 20:14:34  张鑫-开发总监 中金支付  
   
二级子账户，比如把一个主账户，分解为10个小的子账户，那可用余额也分为10份。并发访问的时候，把并发分散到每个小的子账户去处理。但是余额就比较难以控制。  
   
> 20:15:07  郭芬-中央结算公司  
   
请问发散是随机发散么  
   
> 20:15:21  Josebruce  
   
单笔入账处理时长大约多久  
   
> 20:15:28  郭芬-中央结算公司  
   
10个子账户有区别么  
   
> 20:15:29  蘑菇街_陈宗  
   
好的，谢谢回答，我觉得总额是在会计科目上来体现  
   
> 20:16:16  张鑫-开发总监 中金支付  
   
10个子账户的账户结构就是一样的，没有区别。  
   
> 20:16:25  郭芬-中央结算公司  
   
哦哦  
   
> 20:16:52  郭芬-中央结算公司  
   
会计和账务系统分开是出于什么考虑  
   
> 20:16:53  张鑫-开发总监 中金支付  
   
至于分散压力的方式，就可以根据业务来设计，比如随机也可以吧。  
   
> 20:17:28  蘑菇街_陈宗  
   
这块，是需要和商户签订协议的吗？  
   
> 20:17:29  蘑菇街_陈宗  
   
![2017-05-26 20:17:29](http://static.cocolian.cn/img/20170526_201729.png) 
   
> 20:17:42  蘑菇街_陈宗  
   
商户缓冲出账和缓冲入账  
   
> 20:18:25  张鑫-开发总监 中金支付  
   
账务的响应时间得设计是毫秒级的，起码要小于100毫秒。  
   
> 20:18:39  WillYang-嘉联支付-架构师  
   
账务系统到会计系统，会计系统产生得记账凭证会不会出现多借多贷的情况？  
   
> 20:18:46  方祜桔  
   
那么如果某个商户信用度较好，出金的缓冲超出额度，后续商户户会补回来，或者在商户信用度范围内，那么出金缓冲也没问题 这种做法需要提前跟商家签约的吧？ 你们现在有使用这种方式吗？  
   
> 20:18:55  张鑫-开发总监 中金支付  
   
账务就是快和稳定。两者分开，主要是定位不同。这个是仁者见仁智者见智的问题。  
   
> 20:20:13  张鑫-开发总监 中金支付  
   
会计系统面向财务，能够反映资金在途，通过会计稽核起到资金的监控作用。还可以为备付金报送提供支持。央行的备付金报送的报表，和会计科目挺像的。  
   
> 20:20:16  张泽雄-民生金服 项目总监  
   
账务是业务记账，会计是经营核算，没有会计，业务照样转  
   
> 20:20:39  张鑫-开发总监 中金支付  
   
出金缓冲那个，要签协议。  
   
> 20:20:49  Josebruce  
   
想知道你们压测的结果及单笔耗时时长，  
   
> 20:21:04  freewolf-天津金融资产交易所技术  
   
nice  
   
> 20:21:05  张鑫-开发总监 中金支付  
   
不过我是建议，毕竟也这么做。  
   
> 20:21:14  方祜桔  
   
哦  
   
> 20:21:22  郭芬-中央结算公司  
   
嗯嗯  
   
> 20:21:24  李伟锋  
   
账务就是快和稳定，为什么还要感知会计的处理结果呢？  
   
> 20:21:47  张鑫-开发总监 中金支付  
   
泽雄兄总结的很到位[强]  
   
> 20:21:59  张泽雄-民生金服 项目总监  
   
出金缓冲？是因为D0么？  
   
> 20:22:41  张鑫-开发总监 中金支付  
   
我们没出金缓冲，这种业务不多。  
   
> 20:22:54  方祜桔  
   
哦哦  
   
> 20:22:55  郭芬-中央结算公司  
   
客户的资金账户在会计系统里头有体现么  
   
> 20:23:26  张鑫-开发总监 中金支付  
   
有，负债类科目  
   
> 20:24:26  张泽雄-民生金服 项目总监  
   
每个客户的资金在账务里是分开的，叫分户账，在会计里就合一块。分户说的也是这个意思  
   
> 20:24:53  刘毅  
   
懂了  
   
> 20:25:15  武伟会-国家电网新能源-PM  
   
分户账是有额度限制的吧  
   
> 20:25:18  张鑫-开发总监 中金支付  
   
问下 为什么账务报会计分录还要通过回调知道结果呢，这样给账务增加了不少负担。其实我觉得这2种方式都行。@李伟锋-蘑菇街金融-杭州   
   
> 20:25:23  郭芬-中央结算公司  
   
账务系统记的是客户的账，会计系统记的是公司本身的账  
   
> 20:25:26  郭芬-中央结算公司  
   
这么理解对吧  
   
> 20:25:27  郭芬-中央结算公司  
   
客户的资产，对公司平台来说就是负债  
   
> 20:25:49  张泽雄-民生金服 项目总监  
   
对  
   
> 20:26:23  Alive-借贷宝-PL  
   
@张鑫-中金支付-开发-北京?请教下热点账户的问题，热点账户是账务系统的，还是会计系统 ？  
   
> 20:26:24  张鑫-开发总监 中金支付  
   
嗯理解的对  
   
> 20:26:30  李伟锋  
   
会计的主体是机构总账  
   
> 20:26:36  张鑫-开发总监 中金支付  
   
账务系统的热点账户。  
   
> 20:26:47  郭芬-中央结算公司  
   
10个客户每个1万，在会计系统里记一笔10万就行了吧  
   
> 20:26:56  张泽雄-民生金服 项目总监  
   
这位兄弟也说了，我们说的会计，并不是企业会计，而是运营会计，企业会计一般是ERP  
   
> 20:27:13  郭芬-中央结算公司  
   
记在负债类科目  
   
> 20:27:23  郭芬-中央结算公司  
   
嗯嗯  
   
> 20:27:52  郭芬-中央结算公司  
   
还是把10笔负债分开记  
   
> 20:28:12  张鑫-开发总监 中金支付  
   
悲观锁，我的理解是，认为任何时间内，这个资源都会有其他的线程来抢夺我的资源。所以，我就先占用这个资源，把资源给锁住，这样别人就抢不走了。我用完这个资源，再释放。  
   
> 20:28:23  Alive-借贷宝-PL  
   
@郭芬-中央结算（中债登）-北京?会计系统，内部户余额更新，是通过账务明细做为一批一次更新   
   
> 20:28:26  张鑫-开发总监 中金支付  
   
刚才谁问的来着，我忘回复了。  
   
> 20:28:41  李伟锋  
   
记账加锁  A—> B ? ?B—>C ? ?C—>A  这种情况的死锁呢？  
   
> 20:29:13  郭芬-中央结算公司  
   
嗯嗯  
   
> 20:29:54  Alive-借贷宝-PL  
   
@李伟锋-蘑菇街金融-杭州?我们现在对于这种情况，做了锁粒度的拆分   
   
> 20:30:10  Alive-借贷宝-PL  
   
这样搞肯定会死锁的   
   
> 20:30:41  龚正-滴滴-支付金融  
   
其实那样的情况  可以用排序来做不会死锁  
   
> 20:30:50  张泽雄-民生金服 项目总监  
   
?死锁是尽量要辟免的，加锁顺序  
   
> 20:31:13  龚正-滴滴-支付金融  
   
锁力度拆分会引入复杂度  
   
> 20:31:15  李伟锋  
   
恩 按用户排序  是可以  
   
> 20:31:16  龚正-滴滴-支付金融  
   
[呲牙]  
   
> 20:31:27  张鑫-开发总监 中金支付  
   
[强]是要排序。  
   
> 20:34:15  张泽雄-民生金服 项目总监  
   
我想问下，这种方案性能如何？  
   
> 20:34:39  龚正-滴滴-支付金融  
   
哪种？  
   
> 20:35:34  李伟锋  
   
排序性能不需要考虑的  
   
> 20:36:02  李伟锋  
   
在查询用户时候 先按2个userId排序 再去做处理  
   
> 20:36:54  李伟锋  
   
还有个问题，记账 使用冻结解冻  当遇到  a->b   同时 b->c  你们的事务处理会有失败的吗 ？假如遇到分布式事务 就更不说了  
   
> 20:37:02  Josebruce  
   
并发情况下两个商户来回转帐死锁几率很大，但是业务使用场景上是不会出现的  
   
> 20:37:22  Alive-借贷宝-PL  
   
@李伟锋-蘑菇街金融-杭州?记账加锁  A—> B ? ?B—>C ? ?C—>A  如果注册用户有千万级，建议分布式事务最终一致性解决   
   
> 20:37:56  李伟锋  
   
最终一致会有体验上的不好??  
   
> 20:38:11  龚正-滴滴-支付金融  
   
一般区分业务  
   
> 20:38:22  张泽雄-民生金服 项目总监  
   
我说的是悲观锁方案的性能  
   
> 20:38:28  龚正-滴滴-支付金融  
   
用户端的账户一般立即处理  
   
> 20:38:41  龚正-滴滴-支付金融  
   
商户最终一致的比较多  
   
> 20:38:47  Alive-借贷宝-PL  
   
我们现在线上已经在用了  
   
> 20:38:48  龚正-滴滴-支付金融  
   
还有平台  
   
> 20:39:30  李伟锋  
   
@张泽雄-民生金服-研发-北京   哦  同问[呲牙]  
   
> 20:39:37  龚正-滴滴-支付金融  
   
这东西各种方法都能实现  我一般都用最简单的  
   
> 20:40:10  龚正-滴滴-支付金融  
   
悲观锁性能确实会有瓶颈[呲牙]  
   
> 20:41:09  Alive-借贷宝-PL  
   
@ark-滴滴-开发?如果是千万级注册用户的量呢  
   
> 20:41:56  Alive-借贷宝-PL  
   
A-B转账的问题   
   
> 20:45:45  龚正-滴滴-支付金融  
   
千万级是没问题的  
   
> 20:46:00  张泽雄-民生金服 项目总监  
   
最终一致性方案简单，按用户分组是没问题的  
   
> 20:46:30  龚正-滴滴-支付金融  
   
扣减先做  增加后做  
   
> 20:47:33  张泽雄-民生金服 项目总监  
   
是的，不垫款财务上是允许的  
   
> 20:48:39  袁军-架构师-快捷通  
   
商户账户减钱的都实时，加钱的都可以缓冲，同一笔会计分录也可以。中间账户加减都可以缓冲，延迟不超过1分钟。  
   
> 20:49:46  蘑菇街_陈宗  
   
涉及商户的缓冲记账，都要签订协议。  
   
> 20:50:51  Alive-借贷宝-PL  
   
@张泽雄-民生金服-研发-北京?按用户分组？如果用户不在一个库呢   
   
> 20:51:57  Alive-借贷宝-PL  
   
@雪鹰-快捷通-架构?会计缓冲是可以的，如果是账务 对于商户这种热点账户怎么解决？  
   
> 20:52:18  张泽雄-民生金服 项目总监  
   
最终一致性，也就是柔性事务，就是为了解决分布式数据  
   
> 20:52:55  韩财光  
   
二级子账号 数值拆分思路很新颖 只是一个帐号上产生并发的机会很小吧？即使并发也不会很大吧？  
   
> 20:53:29  张泽雄-民生金服 项目总监  
   
抢标就会了  
   
> 20:53:42  Alive-借贷宝-PL  
   
子账号这个方法不错  
   
> 20:54:22  袁军-架构师-快捷通  
   
热点账户  只有出款的情况，比如  for update wait 3 , 系统自动重试。出款就需要削峰填谷。。   
   
> 20:54:25  蘑菇街_陈宗  
   
看拆分的粒度  
   
> 20:55:03  蘑菇街_陈宗  
   
可以使用缓冲记账+二级子账号，如果账务系统做分库分表拆分的话  
   
> 20:55:15  Alive-借贷宝-PL  
   
@雪鹰-快捷通-架构?拿不到锁 不成功就不出款吗  
   
> 20:55:27  张泽雄-民生金服 项目总监  
   
子账号按业务切是可以的，否则会带来管理复杂度，我们也在用  
   
> 20:55:50  袁军-架构师-快捷通  
   
拿不到锁过一段时间在重试啊，会计分录不变就没事。  
   
> 20:56:08  袁军-架构师-快捷通  
   
实时转账的话，就直接失败  
   
> 20:56:30  袁军-架构师-快捷通  
   
出款没必要保证100%实时返回结果吧？  
   
> 20:56:42  Alive-借贷宝-PL  
   
@雪鹰-快捷通-架构?实时转账这样体验不好吧   
   
> 20:56:59  Alive-借贷宝-PL  
   
而且一般不是实时的   
   
> 20:57:12  蘑菇街_陈宗  
   
出款要100%保证实时返回结果，否则有可能会造成资损吧  
   
> 20:57:22  Alive-借贷宝-PL  
   
@雪鹰-快捷通-架构?跟会计分录是两码事   
   
> 20:57:57  袁军-架构师-快捷通  
   
资金变动 不要会计分录？  
   
> 20:58:40  蘑菇街_陈宗  
   
账务和会计分开，账务实时记账，会计异步记分录  
   
> 20:59:42  陈跃泉-苏宁架构师  
   
请问一下客户帐（会员和商家）放在账务系统吧，内部账户或者平台账户是记在账务系统还是会计系统？  
   
> 21:00:57  韩财光  
   
抢标秒杀这种用合并更合理感觉 控制容易 成本也低 数值分级相当于事务控制也跟着分级 太复杂了  
   
> 21:02:15  袁军-架构师-快捷通  
   
理解或设计上不一样吧。 我们是通过会计分录，来变动资金明细的。  
   
> 21:02:53  蘑菇街_陈宗  
   
恩，这样设计上是不一样  
   
> 21:04:05  袁军-架构师-快捷通  
   
缓冲记账就先落地会计分录，1分钟批处理一次。  
   
> 21:04:29  龚正-滴滴-支付金融  
   
[呲牙]  
   
> 21:04:30  龚正-滴滴-支付金融  
   
嗯  我也是这么做的  
   
> 21:04:40  蘑菇街_陈宗  
   
那如何保证出账是一定成功的呢？  
   
> 21:06:31  yuesheng.yin  
   
[玫瑰]好分享  
   
> 21:09:01  袁军-架构师-快捷通  
   
@铁手_蘑菇街_技术_杭州  你说的出账是指 生成资金变动明细？  
   
> 21:09:48  蘑菇街_陈宗  
   
对的   
   
> 21:09:53  陈跃泉-苏宁架构师  
   
@张鑫-中金支付-开发-北京?，请问内部账户或者平台账户是放在账务系统，还是会计系统，还是独立的系统，能否分享一下相关优缺点吗，谢谢  
   
> 21:13:16  蘑菇街_陈宗  
   
@雪鹰-快捷通-架构?你那边架构不一样 可能我们理解会有偏差   
   
> 21:13:25  郭芬-中央结算公司  
   
话说我们的账务系统是先分录再记资金变动明细  
   
> 21:14:07  张泽雄-民生金服 项目总监  
   
那兄弟可能吃饭去了，会说一下吧，放会计账户  
   
> 21:14:29  龚正-滴滴-支付金融  
   
内部账户如果有业务方主动变动  是在账务  
   
> 21:14:56  龚正-滴滴-支付金融  
   
如果只是统计类的账务 会计里面就行  
   
> 21:15:04  龚正-滴滴-支付金融  
   
比如预算户  
   
> 21:15:08  张鑫-开发总监 中金支付  
   
内部账户如果参与了支付业务的话，是要放账务系统的。这是我的理解。然后再归属到某类会计科目上。  
   
> 21:15:20  龚正-滴滴-支付金融  
   
[呲牙]  
   
> 21:15:23  袁军-架构师-快捷通  
   
会计分录没问题，就不会有问题的。商户帐只有+钱缓冲，不会有问题的，顶多系统中间过渡户可能会有问题 ，因为加减都缓冲的。  
   
> 21:17:13  蘑菇街_陈宗  
   
商户账出款还是实时的   
   
> 21:17:17  陈跃泉-苏宁架构师  
   
比如担保账户理论上是涉及到业务，那种账户是放在账务系统了？  
   
> 21:17:21  蘑菇街_陈宗  
   
那理解一致  
   
> 21:17:53  风姿  
   
u  
   
> 21:19:31  张鑫-开发总监 中金支付  
   
是的  
   
> 21:20:26  蘑菇街_陈宗  
   
收获颇多 [强]  
   
> 21:20:47  龚正-滴滴-支付金融  
   
赞  
   
> 21:21:40  龚正-滴滴-支付金融  
   
谢谢分享  
   
> 21:21:59  扫地僧  
   
谢谢分享  
   
> 21:22:34  文奇  
   
谢谢分享 [强]  
   
> 21:23:18  陈跃泉-苏宁架构师  
   
谢谢分享  
   
> 21:24:27  袁军-架构师-快捷通  
   
有遇到过资金明细按时间、序号排序错乱的么……oracle RAC多节点写数据[捂脸]  
   
> 21:28:08  Alive-借贷宝-PL  
   
@雪鹰-快捷通-架构?缓冲记账就先落地会计分录，1分钟批处理一次。 我们也是这样的  
   
> 21:29:48  吝亮-联动优势  
   
曾经见过某银行对账单格式更换，变化后数据有错乱的， 也只是遇见过，但为什么出现这种情况就不太清楚了  
   
> 21:36:45  张鑫-开发总监 中金支付  
   
oracle排序不稳定的问题我遇到过  
   
> 21:37:13  张鑫-开发总监 中金支付  
   
最后我们的解决办法是再加上主键来排序，排序就稳定了。  
   
> 21:37:30  张鑫-开发总监 中金支付  
   
order by  业务字段1、业务字段2、主键。  
   
> 21:50:56  袁军-架构师-快捷通  
   
oracle RAC多节点写数据取的是各节点的时间，不是写入数据文件时的时间…   
   
> 21:51:54  李玉福  
   
账户的数据要不要发生业务有效性的验证？  
   
> 21:54:22  张彦龙  
   
谢谢分享[强][抱拳]  
   
> 21:56:13  袁军-架构师-快捷通  
   
使用中间过渡户，看过渡户余额就知道有无交易有问题了。  
   
> 21:57:05  李玉福  
   
结算中吗？  
   
> 21:57:19  李玉福  
   
结算的时候再与业务数据对？  
   
> 22:09:30  袁军-架构师-快捷通  
   
你指的是给商户结算打款时？  
   
> 22:16:56  李玉福  
   
比如A给B转账，B余额收入的这条单子的有效检验  
   
> 22:21:15  肖勇  
   
这里的会计系统感觉称为会计支撑系统更为准确吧，[微笑]  
   
> 22:22:29  袁军-架构师-快捷通  
   
A-C，C-B  看C就行了  
   
> 22:23:28  袁军-架构师-快捷通  
   
有问题C会挂账的，否则没问题。  
   
> 23:01:04  李玉福  
   
C是平台？  
   
> 23:11:47  韩财光  
   
感觉通过这个平台的交流分享会整体抬升整个支付行业的业务水平和软件质量 很多[OK]  
   
