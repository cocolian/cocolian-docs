---
layout:     source 
title:      "2018-11-28-WeChat"
date:       2018-11-28 12:00:00
author:     None
lines:      108 
tag:       [chat]
---
> 09:58:48  右军-蚂蚁金服-成都  
   
风控说得稍微细点的不多，我找到一篇  
   
> 09:58:51  右军-蚂蚁金服-成都  
   
[干货 | 携程在线风控系统架构
](http://mp.weixin.qq.com/s?__biz=MzIxMzEzMjM5NQ==&amp;amp;amp;mid=2651030701&amp;amp;amp;idx=2&amp;amp;amp;sn=f736a7163fcf850ebb02d1da5ab9eec8&amp;amp;amp;chksm=8c4c51a9bb3bd8bf32eef14f4918e582c43bdc109cd3ad688dbca8fc830b897755f9baddea85&amp;amp;amp;mpshare=1&amp;amp;amp;scene=1&amp;amp;amp;srcid=1128dhpN7LttKpy3QwQo4Y14#rd)  
   
> 10:24:29  Linzr 兴业 支付  
   
@右军-蚂蚁金服-成都 赞  
   
> 10:25:59  崔鹏-gomepay-产品  
   
[强]  
   
> 10:28:26  罗志威－深圳－以太零  
   
@右军-蚂蚁金服-成都 赞  
   
> 20:04:20  Elva-支付产品经理-北京  
   
今天请到一位朋友，@蓝蝶-优络-技术-深圳  给大家做分享，主题是 “支付系统之对账处理优化” 开始时间为【20:30】；欢迎欢迎[鼓掌][鼓掌][鼓掌]！（注： 1.嘉宾分享期间其他人不要发言打断嘉宾分享。2.分享完成后请大家积极补充和提问；3.烦请打“签到”，做签到，谢谢！)  
   
> 20:04:24  Elva-支付产品经理-北京  
   
欢迎欢迎  
   
> 20:04:36  Elva-支付产品经理-北京  
   
签到  
   
> 20:04:49  彬-捷银-架构师  
   
签到  
   
> 20:04:51  亮-中信信用卡-开发岗  
   
签到  
   
> 20:04:54  追梦－拉卡拉－北京－技术经理  
   
签到  
   
> 20:05:00  DON-通联-研发  
   
签到  
   
> 20:05:07  银盛支付-产品-郭霄  
   
签到  
   
> 20:05:17  David - Topode - PM  
   
签到  
   
> 20:05:22  杨杰-康城投资-开发-上海  
   
签到  
   
> 20:05:35  SP-ctcf-架构  
   
签到  
   
> 20:05:56  曾卓-长丰集团-架构师-长沙  
   
签到  
   
> 20:06:10  郭耀武-华海技术  
   
签到  
   
> 20:06:47  张杨-航天电子-研发-北京  
   
签到  
   
> 20:07:10  张震南-信雅达-互联网支付-杭州  
   
签到  
   
> 20:07:22  李小胖-优讯-打杂  
   
签到  
   
> 20:07:42  王月卿～华胜～产品经理～北京  
   
签到  
   
> 20:08:01  张学鸿-北京-研发-民金所  
   
问个问题哈 mysql的联合索引B+树是张这个样子吗 非叶子节点只有最左那个索引列 叶子节点是索引列加主健key或加data  
   
> 20:08:01  张学鸿-北京-研发-民金所  
   
![2018-11-28 20:08:01](http://static.cocolian.cn/img/20181128_200801.png) 
   
> 20:08:23  Sunick-酷派支付-技术  
   
签到  
   
> 20:08:37  聚合支付_程昱  
   
签到  
   
> 20:08:55  mouse-xn-开发-深圳  
   
签到  
   
> 20:09:06  奥法-青芒数据-产品  
   
签到  
   
> 20:09:29  吕波-融投世界科技-技术总监-沈阳  
   
签到  
   
> 20:09:45  双乾支付韩伟  
   
签到  
   
> 20:10:06  dexter-xib-研发  
   
签到  
   
> 20:10:55  涂智明-科蓝-开发主管  
   
签到  
   
> 20:11:37  黄健-产品-众安-上海  
   
签到  
   
> 20:11:59  DouW-贝络-Pa  
   
签到  
   
> 20:12:03  胡文刚_卓健_产品经理_杭州  
   
签到  
   
> 20:12:18  Nancy-京东-产品-北京  
   
签到  
   
> 20:12:27  丹凤-现在支付-产品  
   
签到  
   
> 20:12:36  夏志强~快付通~技术经理  
   
签到  
   
> 20:12:42  Cc老曹-英之泰-技术  
   
签到  
   
> 20:14:11  吴杰棣 首展科技 产品经理  
   
签到  
   
> 20:14:36  翔远-中金支付-产品  
   
签到  
   
> 20:14:51  Ying-小米支付-合规-北京  
   
签到  
   
> 20:16:12  泰康程惠仙  
   
签到  
   
> 20:16:40  玖富-架构师  
   
签到  
   
> 20:17:04  程琳Wa-杉德支付-产品-上海  
   
签到  
   
> 20:17:29  李杰-研发-北京  
   
签到  
   
> 20:17:29  海-开科-市场交付-成都  
   
签到  
   
> 20:17:55  中金支付 刘敏蔚  
   
签到  
   
> 20:18:07  李伟 聚合 开发  
   
签到  
   
> 20:18:16  XZ-中金-产品  
   
签到  
   
> 20:19:20  李胜勇-永乐-G  
   
签到  
   
> 20:19:34  吴杰棣 首展科技 产品经理  
   
签到  
   
> 20:19:37  梁文辉-中科软-需求-北京  
   
签到  
   
> 20:21:33  利平--KD银企直连--攻城狮  
   
签到  
   
> 20:25:48  武亚斌-投哪网-产品-深圳  
   
签到  
   
> 20:27:18  hgwym-传化支付-技术经理  
   
签到  
   
> 20:28:48  java-开科-成都  
   
签到  
   
> 20:29:13  秦红胜-共致开源-架构师  
   
签到  
   
> 20:29:44  蓝蝶-优络-技术-深圳  
   
大家好，今天分享支付系统中的对账处理模块，对账业务就不细讲了，大家可以去看群主的“支付系统设计：对账处理”那篇文章，里面详细介绍了对账的业务处理。 今天主要讲百万级别以上交易笔数的对账如何在30分钟之内对账完成，以满足快速清算的目的。 我们先来梳理下对账中有哪些环节，有渠道账单下载、账单数据标准化、系统对账、长短款处理、输出清分数据；整个环节中就是系统对账模块是最耗时的，因为需要逐笔进行勾兑来找出双方差异的单来进行长短款处理和对平账数据的清算处理。 我先讲下背景环境。 公司支付系统对接了微信、支付宝、QQ钱包等主流移动支付通道。每天9天上游才提供对账单，10:20要完成所有通道的商户清算。 如何优化这块的对账处理时间，我总结了一下几点， 1、&amp;#160; 渠道对账单数据清洗 2、&amp;#160; 存储IO优化 3、&amp;#160; 数据库查询优化  
   
> 20:29:57  蓝蝶-优络-技术-深圳  
   
我们先来说对账单数据清洗，数据清洗比较简单，难的是清洗完成之后怎么存储，然后在后续的勾兑中能快速的可以查询出来进行比对。我们这里选择的kv数据库ssdb来进行数据存储，为什么选择ssdb？因为其高性能的存储和查询速度。处理程序上根据不同的渠道采用多线程来进行账单下载和数据清洗之后然后存储在ssdb中，这个过程中500W的数据基本在5分钟之内都可以处理完成。  
   
> 20:30:01  蓝蝶-优络-技术-深圳  
   
接着来说第二个点，存储IO优化，这点是最重要的，因为这里对第一点和第三点的优化起着很重要的作用，我们选择的ssd的固态硬盘来进行清洗数据的存储和数据库数据的存储，以及ssdb数据文件的存储。 特别是ssdb专门是对ssd进过优化的，更加提高了ssdb的性能，这个也是为什么选择ssdb来存储勾兑数据的原因之一。这里如果公司成本控制有限的话可以选择数据库还是采用机械硬盘来存储，因为对整个优化影响不大，我们这里数据库采用ssd来存储是因为成本上公司能支持，算是锦上添花的效果。但是ssdb一定要安装在ssd上。  
   
> 20:30:07  蓝蝶-优络-技术-深圳  
   
最后来说数据库查询的优化，先说查询语句的优化，索引很重要，因为支付的特性，主要关心的是根据订单、渠道、时间来进行查询，所以这些字段就一定要建立索引，这里建议大家建立复合索引，尽量减少索引来提高存储的速度。所以我一般会建立订单索引、渠道+时间的复合索引；其他的sql优化方案根据大家各自的系统进行优化设计。但是sql优化还是不够，因为还是满足不了在很短的时间之内把数据查询出来并进行勾兑处理，所以有两个解决方案，一个是在时间上去优化，一个是在空间上去优化，我这里选择用空间来换时间。因为数据库系统需要查询的是T日的交易数据在T+1日来进行对账，所以我选在T日日切之后，将T日的数据全部查询出来写到ssdb数据库中，这样一来我可以在9点下渠道对账单之前就将我方订单数据全部处理完成，在渠道数据清洗成功之后就可以马上进行数据勾兑，500W笔的数据量在20分钟之内就可以全部处理完成。  
   
> 20:30:27  蓝蝶-优络-技术-深圳  
   
好的，今天的分享就到这里了，欢迎大家拍砖。  
   
> 20:31:16  Elva-支付产品经理-北京  
   
[强]第一段还没看完呐！[捂脸]这是神速啊！先消化消化。  
   
> 20:36:18  北京佳付通-李宏涛（产品技术）  
   
[强][强][强]  
   
> 20:37:37  dreamup-平安-产品  
   
[强][强][强]  
   
> 20:44:37  李胜勇-永乐-G  
   
[强][强]  
   
> 20:50:51  王月卿～华胜～产品经理～北京  
   
[强]  
   
> 20:52:07  双乾支付韩伟  
   
[强][强][强]  
   
> 21:06:36  上海-上海中钢银联通-董路-技术  
   
基于sql的对账？  
   
> 21:34:24  蓝蝶-优络-技术-深圳  
   
不是，基于nosql的的对账  
   
> 21:35:03  永明-云账户-开发-北京  
   
迁到  
   
> 21:35:08  永明-云账户-开发-北京  
   
签到  
   
> 21:35:28  蓝蝶-优络-技术-深圳  
   
订单在关系型数据库，日终把订单数据数据同步到ssdb中用来对账  
   
> 21:35:28  孙建志-首采联合-开发  
   
请问渠道单的下载是分块下载嘛？  
   
> 21:36:39  孙建志-首采联合-开发  
   
渠道单下载 之后清洗 再写入ssdb 这个过程可以详细说一下嘛？  
   
> 21:37:32  蓝蝶-优络-技术-深圳  
   
不用分块下载，渠道侧会提供压缩之后的账单  
   
> 21:38:17  孙建志-首采联合-开发  
   
那需要再代码中进行解压啦？  
   
> 21:38:18  刘耀文-华宝基金-技术开发  
   
ssdb对完后再回写数据库么  
   
> 21:38:28  孙建志-首采联合-开发  
   
还是怎么处理  
   
> 21:39:18  孙建志-首采联合-开发  
   
百万的数据也不是一次性加载到内存的吧？  
   
> 21:39:50  蓝蝶-优络-技术-深圳  
   
@孙建志-开发-北京 数据清洗之后，按渠道号做做为key，把订单组装成hashmap作为value存进去  
   
> 21:40:22  王伟-万向  
   
[【培训】复旦大学主办：区块链技术管理（区块链 ）研修班
](http://mp.weixin.qq.com/s?__biz=MjM5ODI4NDE1Mw==&amp;amp;amp;mid=2649246501&amp;amp;amp;idx=3&amp;amp;amp;sn=1e75929da6448d55539c3899520e003b&amp;amp;amp;chksm=bed1f53389a67c25f7bc9f3243368be621de60e03dfab4633678a7dc75dd0e5992b9a1413fe9&amp;amp;amp;mpshare=1&amp;amp;amp;scene=1&amp;amp;amp;srcid=1128ViJrAMY7WG71jRIemRSc#rd)  
   
> 21:40:27  蓝蝶-优络-技术-深圳  
   
不是一次性的，循环去遍历渠道对应的ssdb  
   
> 21:41:40  孙建志-首采联合-开发  
   
渠道单下载之后是用什么工具解析的 ？  
   
> 21:42:49  蓝蝶-优络-技术-深圳  
   
对账单只是文件IO读写  
   
> 21:45:14  蓝蝶-优络-技术-深圳  
   
对账单下载之后进行解压，然后一行行的读取文件内容写入到ssdb中  
   
> 21:45:19  孙建志-首采联合-开发  
   
如果对账单很大的话 你们怎么处理的  
   
> 21:46:24  蓝蝶-优络-技术-深圳  
   
你说的很大，大概是多大？  
   
> 21:47:31  孙建志-首采联合-开发  
   
文件几百兆或是上G  
   
> 21:47:47  上海睿民-陈帅康-项目经理  
   
不会有太大的，如果太大的话，比如每天上亿笔交易，这就是另外一种架构处理了  
   
> 21:48:20  上海睿民-陈帅康-项目经理  
   
都是用csv或者txt不会有几百兆的  
   
> 21:48:30  孙建志-首采联合-开发  
   
比如说啥架构  
   
> 21:49:00  蓝蝶-优络-技术-深圳  
   
1G的文件读取和解析入ssdb也就3分钟处理完了  
   
> 21:49:37  蓝蝶-优络-技术-深圳  
   
但是这个解析过程不要做别的业务处理，单纯只做数据清洗  
   
> 21:49:49  孙建志-首采联合-开发  
   
[强][强]  
   
> 21:50:29  孙建志-首采联合-开发  
   
回去试试 我这刚做完对账系统  
   
> 21:50:55  蓝蝶-优络-技术-深圳  
   
[抱拳]  
   
> 21:51:16  孙建志-首采联合-开发  
   
多谢多谢啦  
   
> 22:20:39  hgwym-传化支付-技术经理  
   
没有数据处理的导入其实可以做到很快的  
   
> 22:21:34  hgwym-传化支付-技术经理  
   
但这样的话岂不是每个渠道都要建立一个导入模型？  
   
> 22:22:38  hgwym-传化支付-技术经理  
   
还是说清洗的时候已经做了数据处理？  
   
> 22:27:03    
   
> 22:28:30  蓝蝶-优络-技术-深圳  
   
数据清洗就是为了把不同渠道的数据转换成统一的数据格式  
   
> 22:45:54  夜月沉星-国通星驿-产品  
   
请教一下各位，某地卫计委开发了一个app，使用当地银行收单，用户可以往app里充钱，用户在某家医院看病后，钱从app里扣，后面卫计委把这笔钱请给医院。这种情况算二清吗？  
   
> 23:31:22  hgwym-传化支付-技术经理  
   
我的理解是算  
   
> 23:33:16  程宏峰-项目-杭州  
   
二清  
   
> 23:34:54  程宏峰-项目-杭州  
   
卫计委应该在合作银行开户，医院在任意银行开户，由合作银行结算给医院所在银行账户  
   
