---
layout:     source 
title:      "2018-09-23-WeChat"
date:       2018-09-23 12:00:00
author:     邵阳_京东商城_Java
lines:      81 
tag:       [chat]
---
> 06:39:20  支付产品开发交流群  
   
[6367551827@chatroom:
](&amp;lt;sysmsg type=&amp;quot;sysmsgtemplate&amp;quot;&amp;gt;)  
   
> 06:39:20    
   
> 10:49:12  姜桥-摩拜单车-技术  
   
[码农不按规范写代码，被同事枪击！文末附代码规范！
](http://mp.weixin.qq.com/s?__biz=MzU3NDY4NzQwNQ==&amp;amp;amp;mid=2247483869&amp;amp;amp;idx=1&amp;amp;amp;sn=1e31b4743c3e24946e91fcd8bf3ebc29&amp;amp;amp;chksm=fd2fd01fca58590978161c935da0d0095db80c9a0c4e6be1270cd4f77e973513dfe2c069587d&amp;amp;amp;mpshare=1&amp;amp;amp;scene=1&amp;amp;amp;srcid=0923pmzRVgydOxQV1rTlA831#rd)  
   
> 11:36:13  右军-蚂蚁金服-成都  
   
[程序员为什么要持续学习（升级版）
](http://mp.weixin.qq.com/s?__biz=MzIxMzEzMjM5NQ==&amp;amp;amp;mid=2651030262&amp;amp;amp;idx=1&amp;amp;amp;sn=b4639ce12ef8a80f6c742162fbc6e35b&amp;amp;amp;chksm=8c4c57f2bb3bdee4a9021a05bb9ef16eff6b78f4b8dadd5125ce9569b3046482ac93d669bec3&amp;amp;amp;mpshare=1&amp;amp;amp;scene=1&amp;amp;amp;srcid=0923EHUthnkhgQArqKBMxsrw#rd)  
   
> 18:40:33  丁丁-群管理  
   
今天请到一位朋友，@邵阳_京东商城_Java?   给大家做分享，主题是 “京东全球售购物车架构” 开始时间为【19:00】；欢迎欢迎[鼓掌][鼓掌][鼓掌]！（注： 1.嘉宾分享期间其他人不要发言打断嘉宾分享。2.分享完成后请大家积极补充和提问；3.烦请打“签到”，做签到，谢谢！)  
   
> 18:40:42  丁丁-群管理  
   
签到  
   
> 18:40:42  丁丁-群管理  
   
欢迎????  
   
> 18:40:53  振效+神码+北京  
   
欢迎  
   
> 18:41:07  辉_风控研发_上海  
   
欢迎 签到  
   
> 18:41:23  赵八卷 SUNMI 上海  
   
签到  
   
> 18:41:35  刘耀文-华宝基金-技术开发  
   
签到  
   
> 18:42:42  澜柯-快钱-研发  
   
签到  
   
> 18:43:05  姚磊-麦子-开发  
   
签到  
   
> 18:43:34  王月卿-群管理  
   
签到  
   
> 18:44:49  梁子龙-维恩贝特-开发  
   
签到  
   
> 18:44:52  大圣-黄金钱包-开发  
   
签到  
   
> 18:45:05  盛-中科金服-研发  
   
签到  
   
> 18:45:31  银盛支付-产品-郭霄  
   
签到  
   
> 18:46:04  卢章-联逸科技-创始人-北京  
   
签到  
   
> 18:46:04  dreamup-平安-产品  
   
签到  
   
> 18:48:08  曾卓-长丰集团-架构师-长沙  
   
签到  
   
> 18:48:56  yongjian-沃支付-产品  
   
签到  
   
> 18:51:05  csp-架构-深圳  
   
签到  
   
> 18:51:40  Cc老曹-英之泰-技术  
   
签到  
   
> 18:53:19  通联支付-产品-符音-深圳  
   
签到  
   
> 18:53:32  武亚斌-投哪网-产品-深圳  
   
签到  
   
> 18:54:01  姜桥-摩拜单车-技术  
   
签到  
   
> 18:54:41    
   
> 18:54:52  张杨-航天电子-研发-北京  
   
签到  
   
> 18:55:24  林安迪-商务-电商分账宝  
   
签到  
   
> 18:56:44  奋斗琵箁  
   
大家好，我是来自京东商城的邵阳，我架构的《京东全球售》“购物车系统”和“结算页系统”两个系统已经于上周五9月21号正式上线，也是我的第二件架构作品。正好借这个机会回顾总结一下，今天我主要讲一些“购物车系统”的架构内容，咱们相互探讨下。   
   
> 18:57:21  奋斗琵箁  
   
一、网站背景 《京东全球售》是京东海外跨境电商网站，是把祖国的商品卖给全世界，类似于阿里速卖通。目前我们有三个站点分别是英文站www.joybuy.com/俄语站站www.jd.ru/西班牙站www.joybuy.es。我们的业务涉及全球上百个国家，涉及多种语言，十几个币种，所以我们的网站最基本的要求和特点就是同一套代码要支持多站点、多语言、多币种，大家可以登录www.joybuy.com/www.jd.ru/www.joybuy.es先体验下。  
   
> 18:58:17  邵阳_京东商城_Java  
   
二、购物车系统特点 购物车和结算页为用户做出购物车决策必经的两个界面，也是黄金流程中的核心界面，上游承接商品详情页，下游承接收银台，承担着提升用户购买转化率指标的重要角色： 1.&amp;#160;购物车系统承担了用户90%以上的常用操作，用户未登录和登录时，加入购物车、一键购、选中不选中、批量选中、修改数量、更改促销活动、删除、批量删除清空购物车等。 2.&amp;#160;购物车系统展示的内容非常多，有商品信息、商家信息、价格、促销价格、总价、套装、总价促销、跨店铺总价促销、赠品、优惠券、库存、承运商、以及商品和赠品的各种展示状态下架、无库存、不可以送达等等（购物车价格一定要计算准确）；同时展示的以上内容，要按照某种排序后进行分组展示。 业务上购物车系统是一个非常复杂的系统，同时又是一个直接面向全球用户的电商最核心的前端系统，所以这个系统要求就非常高： 1.&amp;#160;稳定，就是所谓的高可用，代码层面不能出bug，及时除bug了，也要内部消化不能吐给用户，对代码质量要求高。 2.&amp;#160;快，就是所谓的性能高，用户看到的界面展示越快越好。目前我们的核心接口一台服务器20个商品20个并发压测持续10分钟平均时间90ms。  
   
> 18:59:32  邵阳_京东商城_Java  
   
看下目前线上的购物车界面  
   
> 18:59:36  邵阳_京东商城_Java  
   
![2018-09-23 18:59:36](http://static.cocolian.cn/img/20180923_185936.png) 
   
> 19:00:11  邵阳_京东商城_Java  
   
图片能看清楚吗？  
   
> 19:00:26  辉_风控研发_上海  
   
不能  
   
> 19:00:27  永明-云账户-开发-北京  
   
不太清楚  
   
> 19:00:35  姚磊-麦子-开发  
   
看不清  
   
> 19:00:54  邵阳_京东商城_Java  
   
![2018-09-23 19:00:54](http://static.cocolian.cn/img/20180923_190054.png) 
   
> 19:01:08  邵阳_京东商城_Java  
   
这个里  
   
> 19:01:30  辉_风控研发_上海  
   
可以  
   
> 19:01:48  邵阳_京东商城_Java  
   
看起来没什么规律，我再发一张  
   
> 19:02:14  邵阳_京东商城_Java  
   
![2018-09-23 19:02:14](http://static.cocolian.cn/img/20180923_190214.png) 
   
> 19:02:48  邵阳_京东商城_Java  
   
购物车列表主要的展示规则  
   
> 19:03:34  邵阳_京东商城_Java  
   
wxid_gwi9nauthffd22: 三、名词解释 普通商品：spu和sku概念，晨光圆珠笔有三种颜色分别是红色、白色、蓝色，该描述中有三个sku属于一组spu。购物车是sku级别，你买白色的圆珠笔和红色的圆珠笔会展示两个记录 套装：大于等于两个的普通商品可以组成套装，套装比单买要便宜，有节省价格。普通商品A和B和C可以组成四种套装分别是ABC、AB、AC、BC，那么购物车中就会存在普通商品A和套装ABC同时存在的场景。套装概念的引入导致购物车系统复杂度增加了一个量级 总价促销：一件或者多件普通商品价格之和超过某个金额，则会有优惠。在购物车页面要把参加同一个促销活动的放到一组，一个商品可能会满足多个促销活动，用户在在购物车页可以选择其他活动，也可以不参加，更改会导致界面框架结构更改。总价促销概念的引入导致购物车系统复杂度又增加了一个量级 跨店铺总价促销：顾名思义多个店铺的商品参加总价促销，属于特殊的总价促销，系统复杂度再度升级 直降促销：一个商品满足某个价格或者买到某个件数会有优惠 优惠券：不解释，都懂 赠品：不解释，都懂，套装无赠品  
   
> 19:04:14  邵阳_京东商城_Java  
   
四、总体架构 架构思想： 1.&amp;#160;用户最关心的商品名称、属性、图片和价格、促销价、总价同步输出，输出这些内容已经可以保证用户可以下单了，同时调用的jsf接口越少，可用性和性能越高。 2.&amp;#160;大型互联网系统都有降级和熔断机制，所以对于其他其他如商家名称、优惠券、赠品库存、是否可达等接口，在大促期间是可以降级熔断的，所以把这些作为一个异步接口，异步渲染，及时报错了，用户也无感知，不影响下单。 购物车会因为删除、批量删除、更改促销活动或者不参加促销导致页面分组结构更改，前端js是无法进行分组的（因为太复杂），为了最好的客户体验，异步吐出源码html，然后进行渲染  
   
> 19:04:29  邵阳_京东商城_Java  
   
具体细节如下：  
   
> 19:04:35  邵阳_京东商城_Java  
   
![2018-09-23 19:04:35](http://static.cocolian.cn/img/20180923_190435.png) 
   
> 19:04:53  邵阳_京东商城_Java  
   
这个图片能看清楚吗？  
   
> 19:05:42  邵阳_京东商城_Java  
   
wxid_gwi9nauthffd22: 五、单台服务器性能提升明显的优化点 1.购物车基础数据全部存储Redis内存数据库,使用到了redis两种数据结构，sorted set和Hash,无需序列化和反序列化开销，批量操作使用管道流pipeline，减少socke链接和传输时间&amp;#160; 2.购物车分组很多、嵌套层级很多，如果一层层循环设置对象值，时间复杂度就是几何级增加，可以通过java8新特性stream流，把list转成外部map，内部循环直接获取赋值，两种循环结果对比10x10x10X10x10x10和10+10+10+10+10+10是1000000和60的区别List.stream().collect(Collectors.toMap())。（Java8的lamda表达式循环也很方便，但是性能有待考证，而且有个非常不好的地方是不能对局部成员变量进行赋值）  3.使用java8新特性CompletableFuture进行线程编排，多个后端jsf接口（京东自研的微服务框架，类似Dubbo）多线程编排输出，自定义线程池ThreadPoolExecutor，线程池大小压测后得到最优值。如果没有线程编排的经验，也可以使用闭锁CountDownLatch，也可达到相同的效果，但是没有CompletableFuture强大。 4.Nginx页面gzip压缩级别调整 5.Tomcat服务器JVM虚拟机参数调整-Xms2048m -Xmx2048m -XX:MaxPermSize=512m 6.（技巧）使用ThreadLocal保存每次请求客户端信息，通过get方法获取副本  
   
> 19:05:43  永明-云账户-开发-北京  
   
可以  
   
> 19:06:46  奋斗琵箁  
   
六、其他 关于影响架构外非技术性的一个很重要因素人，表达一个观点技术本身并不是最重要的，一定是工作态度。  
   
> 19:07:32  邵阳_京东商城_Java  
   
分享结束，谢谢大家，大家先消化一下。  
   
> 19:11:17  韩财光  
   
> 19:11:50  丁丁-群管理  
   
> 19:11:59  李小胖-优讯-打杂  
   
[强]  
   
> 19:12:14  班纳睿-RRD-Java开发-北京  
   
[强]  
   
> 19:15:53  杜雷-生物认证支付-技术  
   
[强]  
   
> 19:19:48  邓晓杰～阿里巴巴～java  
   
[强]  
   
> 19:20:38  洛叶-GD聚合支付-项管  
   
[强][强][强]  
   
> 19:22:02  李杜-长沙万权集团-技术部经理  
   
[强][强][强]  
   
> 19:27:57  李胜勇-永乐-G-北京  
   
[强][强][强]  
   
> 19:28:52  朱海申-爱贝-研发  
   
jdk 8记得好像不设置perm.size了吧，还是我记错了  
   
> 19:30:42  smartwave-开科支付-成都  
   
@邵阳_京东商城_Java? [强][强] 谢谢分享  
   
> 19:31:54  徐凌云-JD-架构师  
   
[强][强]  
   
> 19:31:58  徐凌云-JD-架构师  
   
赞  
   
> 19:32:50  邵阳_京东商城_Java  
   
对大家有帮助就行，都是总结的经验  
   
> 19:38:39  王成龙-新浪跨境-研发-上海  
   
学习了[强][强][强]  
   
> 19:42:30  上海-上海中钢银联通-董路-技术  
   
签到  
   
> 19:42:45  邵阳_京东商城_Java  
   
以上是购物车比较核心的点，有些没有涉及到的，大家可以直接微信我了解  
   
> 19:42:47  Eric-Silot-SG  
   
签到  
   
> 19:58:44  lance-货拉拉-开发  
   
签到  
   
> 20:04:58  风兮-Java技术-上海  
   
签到  
   
> 20:12:56  蔡章正-mt-结算系统  
   
[强]  
   
> 20:17:54  冯建熙—差旅天下—产品经理  
   
感谢??分享  
   
> 20:18:02  张震南-信雅达-互联网支付-杭州  
   
签到  
   
> 20:19:13  冯建熙—差旅天下—产品经理  
   
问下购物车支持积分，优惠券多种组合优惠活动吧？这个后续对账方便简单说下么  
   
> 20:26:48  鱼筱雨–来米发–研发部  
   
[强][强]  
   
> 20:28:34  邵阳_京东商城_Java  
   
这个据我了解，下单后会把优惠券的总额分摊到每个商品，退款的话，就是分摊后的价格。至于对账不是太清楚，应该处理情况跟退款相似  
   
> 21:06:00  北京一张泽雄  
   
这个看产品策略，有的为了简单，退款不退优惠券，对账按券，现金分别对  
   
