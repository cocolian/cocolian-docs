---
layout:     source 
title:      "2018-07-31-WeChat"
date:       2018-07-31 12:00:00
author:     杨宽-京东金融-鼓励师
lines:      513 
tag:       [chat]
---
> 00:36:55  雷小光-分润云联合创始人  
   
请教一下，扫码支付，如何采集手机的MAC信息，最终实现会员信息和MAC信息的绑定  
   
> 00:52:22  雷小光-分润云联合创始人  
   
我有一个基本思路，利用室内WIFI定位，3-5个WIFI探针专门定位收银台正在付款的那个人，但是排队的场景就不精确了  
   
> 00:52:29  广州银典-张伯伦-BOSS  
   
@雷小光-分润云联合创始人?找硬件类厂家  
   
> 00:52:36  广州银典-张伯伦-BOSS  
   
他们会比较专业  
   
> 00:52:57  广州银典-张伯伦-BOSS  
   
但是你这个思路非常好  
   
> 00:53:13  广州银典-张伯伦-BOSS  
   
若是研发出来了，非常不错  
   
> 00:54:30  雷小光-分润云联合创始人  
   
我一晚上在琢磨这个事  
   
> 09:19:32  泽西-趋恒-架构师  
   
签到  
   
> 10:03:11  sophia-教育-产品-北京  
   
签到  
   
> 10:07:20  陈琼-开课啦-产品-杭州  
   
钉钉可以通过wifi打卡  
   
> 10:07:42  陈琼-开课啦-产品-杭州  
   
@雷小光-分润云联合创始人  
   
> 10:09:08  陈琼-开课啦-产品-杭州  
   
用户可以通过连接固定的WiFi，与系统进行交互  
   
> 10:09:33  陈琼-开课啦-产品-杭州  
   
那么你的想法应该是成立的  
   
> 10:11:56  颜小刚-爱贝-架构开发-深圳  
   
用户到店里买个东西，必须要连接一个固定的wifi，这个体验会不会不好？  
   
> 10:14:18  陈琼-开课啦-产品-杭州  
   
应该还要再加上扫码  
   
> 10:14:36  陈琼-开课啦-产品-杭州  
   
通过固定wifi定位是哪家店  
   
> 10:14:48  陈琼-开课啦-产品-杭州  
   
然后通过扫码完成自主支付  
   
> 10:15:37  陈琼-开课啦-产品-杭州  
   
如果很多人排队的话，我宁愿自己连wifi自己付  
   
> 10:17:19  hobbit-待业-广州  
   
?这个只要他能连接你的wifi，就可以解决。先在发射wifi信号路由器那边架设一个服务器，专门来抓取http包，然后实时对抓取到的包进行解析。用户扫码支付的时候，先进去你们的支付页面。就可以抓取到用户的mac地址和对应的订单信息  
   
> 10:18:09  陈琼-开课啦-产品-杭州  
   
wifi连的好处是，比GPS定位准确，我之前出差在飞机场的麦当劳吃饭，结果通过GPS定位发现买到另一家店了，很坑爹的  
   
> 10:21:18  雷小光-分润云联合创始人  
   
WIFI探针不是真实的WIFI，对于用户来说是无感的  
   
> 10:22:27  地平线-文思-产品  
   
wifi探针是啥？  
   
> 10:28:53  陈琼-开课啦-产品-杭州  
   
只要手机开着wifi，就可以通过wifi探针获取手机的mac地址  
   
> 10:30:10  雷小光-分润云联合创始人  
   
当一个设备给另外一个设备通过无线传输技术发送信息时，周围的其他同类设备都是能够收到无线信息，WiFi探针技术基于此原理。具体说，当WiFi设备在WiFi探针的侦听范围内，WiFi设备（无论是终端、路由器或者其他WiFi设备）发送任何一帧（Frame）时，不管是发给谁，探针都能截获，并分析出此帧MAC层与物理层的一些信息，比如发送与接收设备的MAC地址、帧类型、信号强度等。WiFi探针不需要与周围的设备有任何交互，其本身不发出任何WiFi信号，即实现了无感知获取MAC信息。  
   
> 10:32:04  地平线-文思-产品  
   
那这个属于流氓软件吧  
   
> 10:32:28  shawn孔-不待业了-CEO  
   
哈哈哈  
   
> 10:32:30  雷小光-分润云联合创始人  
   
硬件  
   
> 10:33:14  雷小光-分润云联合创始人  
   
很多大公司把未来新零售的希望寄托在 WIFI探针上了  
   
> 10:34:56  陈琼-开课啦-产品-杭州  
   
看了一下，不违法的  
   
> 10:35:30  颜小刚-爱贝-架构开发-深圳  
   
貌似IOS对于wifi探针，发出的mac是随机的  
   
> 10:36:03  雷小光-分润云联合创始人  
   
不会吧  
   
> 10:36:26  陈琼-开课啦-产品-杭州  
   
手机mac地址是唯一的  
   
> 10:36:33  颜小刚-爱贝-架构开发-深圳  
   
刚刚google到的一篇文章：http://southpeak.github.io/2014/09/18/random-mac-in-ios8/  
   
> 10:36:39  雷小光-分润云联合创始人  
   
探针获取到的MAC和路由器获取到的MAC是一致的  
   
> 10:38:04  陈琼-开课啦-产品-杭州  
   
https://www.jb51.net/article/52484.htm扫码可以获取到mac地址  
   
> 10:39:25  颜小刚-爱贝-架构开发-深圳  
   
这个链接对应的系统好久远  
   
> 10:39:36  雷小光-分润云联合创始人  
   
这方面 阿里系 的 友盟 做的很厉害  
   
> 10:40:07  雷小光-分润云联合创始人  
   
然后就是 壁合科技、ZTM众盟等等  
   
> 10:40:53  颜小刚-爱贝-架构开发-深圳  
   
现在app要获取mac地址在IOS基本上好难，都是用其他做代替  
   
> 12:00:22  凤凰牌老熊-群管理  
   
进群的同学注意修改下昵称，做一个自我介绍以便大家相互了解，并说明下可以分享的主题和时间，谢谢！     1. 本群建设目标是为从事互联网支付的产品经理、资深工程师、架构师、管理人员提供交流平台。鼓励大家在交流中学习。 入群的同学必须明确可以提供分享的时间、主题后才可成为群成员。 拒绝配合群管理人员做分享的同学，管理人员有权将其移除出本群。   2. 群中禁止发表政治言论、广告以及和支付无关的话题。 禁止灌水行为，禁止谩骂，禁止发表人身攻击言论。 有上述违规行为，群主有权将该账号移出本群。  3. 本群所有人员必须将昵称修改为 姓名-公司-岗位-地区。对不合规人员，经2次提醒后，仍未修改者， 群主有权将该账号移出本群。  4. 群主会不定期对群成员的活跃情况进行统计， 移除超过2个月没有发言的成员，以便让更有需要的人入群。   5. 每天群里19:15 之前 为自由讨论时间， 19:15~19:30为签到时间， 19:30为专题讨论时间。本群讨论内容每天归结到http://doc.cocolian.cn/。如有保密问题，请及时反馈给群主做修改。  6. 本群里的包括各种形式的分享在内聊天记录，未经群主和分享嘉宾许可，不得对外发布。  
   
> 12:01:03  泽西-趋恒-架构师  
   
嗯  
   
> 12:01:05  追梦-区块链金融-北京-技术经理  
   
收到  
   
> 12:01:35  micheal 简米 开发  
   
收到  
   
> 12:01:48  地平线-文思-产品  
   
收到，  
   
> 12:02:00  郭旭东-产品-上海  
   
收到  
   
> 12:02:13  罗志威－深圳－以太零  
   
收到  
   
> 12:02:14  Daniel-快钱-架构  
   
??  
   
> 12:02:35  张宗君-开课啦-技术总监  
   
??  
   
> 12:02:40  夏斌-优赋-技术经理-北京  
   
嗯  
   
> 12:02:42  旺达的鱼-efupay-RD  
   
收到  
   
> 12:02:46  张杨-航天电子-研发  
   
??  
   
> 12:02:47  广州银典-张伯伦-BOSS  
   
收到  
   
> 12:02:58  北京-中投科信产品-张冠杰  
   
OK  
   
> 12:03:00  【信融集团】·王瑞  
   
[奋斗]  
   
> 12:03:17  博小白-reapal-研发-北京  
   
get  
   
> 12:03:30  刘耀文-华宝基金-技术开发  
   
[OK]  
   
> 12:03:35  顾逸晖-维金-技术-上海  
   
[OK]  
   
> 12:03:42  无缺-数心-开发  
   
[偷笑]  
   
> 12:03:43  丁爱民-58-开发  
   
签到  
   
> 12:03:44  星枫-一下科技-研发经理-北京  
   
[OK]  
   
> 12:03:46  曾卓-长丰集团-架构师-长沙  
   
收到  
   
> 12:03:47  hgwym-传化支付-技术经理  
   
[OK]  
   
> 12:03:50  李治-文思-开发-西安  
   
[OK]  
   
> 12:03:58  胡倩颖-渠道-北京  
   
[OK]  
   
> 12:04:06  刘金霖-宝付-开发-上海  
   
[OK]  
   
> 12:04:20  阿茂-百联（离职）-研发  
   
+1  
   
> 12:04:27  亮-中信信用卡-开发岗  
   
收到  
   
> 12:04:29  振效+神码+西安  
   
收到  
   
> 12:04:49  张问平安付产品上海  
   
[OK]  
   
> 12:04:54  赵业招-JD-技术  
   
收到  
   
> 12:04:55  许佳伟-产品/市场-深圳  
   
收到  
   
> 12:05:06  木子清-苏宁-产品-南京  
   
收到，看我的标准吧  
   
> 12:05:19  Fred_KY_联合创始人  
   
[OK]  
   
> 12:05:49  smartwave-开科支付-成都  
   
[OK]  
   
> 12:06:03  小七-研发~深圳  
   
[OK]  
   
> 12:06:32  陈琼-开课啦-产品-杭州  
   
收到  
   
> 12:06:58  吉信科技-紫君-产品  
   
收到  
   
> 12:07:00  熊是老熊-架构+风控-杭州  
   
收到  
   
> 12:09:43  澜柯-快钱-研发  
   
收到  
   
> 12:10:13  徐凌龙-众安-Java  
   
收到  
   
> 12:10:36  Jerry-BOCS  
   
收到  
   
> 12:11:56  shrek.wu  
   
收到  
   
> 12:11:57  黄健-产品-众安-上海  
   
收到  
   
> 12:12:37  王亮-收银家-研发  
   
收到  
   
> 12:12:53  张岩-华恒科技-商务-吉林  
   
收到  
   
> 12:13:05  弋碎-国美-产品  
   
??  
   
> 12:13:53  雪飞-万年草-产品-北京  
   
[鼓掌]  
   
> 12:14:38  黄福祥-ETC车宝-鼓励师-广州  
   
收到  
   
> 12:18:35  林安迪-商务-电商分账宝  
   
收到  
   
> 12:19:33  senvon-华腾-架构师  
   
收到  
   
> 12:19:46  DouWei-贝络-PA-北京  
   
收到  
   
> 12:20:49  陈军峰，宜信，研发主管  
   
[握手]  
   
> 12:21:11  军波－开发－北京  
   
收到  
   
> 12:21:29  芦苇-开发-杭州  
   
收到  
   
> 12:22:18  大圣-黄金钱包-开发  
   
收到  
   
> 12:22:37  Simi-腾讯-产品  
   
收到  
   
> 12:23:03  通联支付-产品-符音  
   
收到  
   
> 12:23:07  Nancy-京东-产品-北京  
   
收到  
   
> 12:23:23  李玉洁-双乾支付-开发  
   
收到  
   
> 12:24:23  FLD-三全-TD  
   
[OK]  
   
> 12:25:42  志明-平安普惠-PM-深圳  
   
收到  
   
> 12:25:48  夜月沉星-gtxy-产品  
   
收到  
   
> 12:26:47  Yang-联拓-研发-北京  
   
收到  
   
> 12:29:38  永明-云账户-开发-北京  
   
get  
   
> 12:30:05  郭耀武-华海-技术  
   
[OK]  
   
> 12:31:29  焕生-支付产品  
   
收到  
   
> 12:32:55  李杰-钱包-研发-北京  
   
收到  
   
> 12:34:41  十年砍柴-元年-产品-上海  
   
收到  
   
> 12:36:57  张修瑜-乾元大通-研发  
   
[OK]  
   
> 12:37:29  Summer 梁夏  
   
收到  
   
> 12:41:22  王成龙-新浪跨境支付-研发  
   
收到  
   
> 12:43:42  京东金融 支付 齐志杰  
   
收到  
   
> 12:44:11  平安银行南京王子豪  
   
收到  
   
> 12:45:18  sophia-教育-产品-北京  
   
收到  
   
> 12:45:26  秦红胜-共致开源-架构师  
   
收到  
   
> 12:45:54  Garry-小米金融-产品  
   
收到  
   
> 12:46:09  Toby-qianduan-系统重构-gz  
   
[OK]  
   
> 12:46:53  csp-架构-深圳  
   
收到  
   
> 12:48:55  忠俊-美团-支付-北京  
   
收到  
   
> 12:49:41  郭峻宏-盒子支付-攻城狮  
   
收到  
   
> 12:53:55  晓波-乐信-开发-深圳  
   
收到  
   
> 12:59:02  lance-货拉拉-开发  
   
收到  
   
> 12:59:15  张天辉-饿了么-产品-上海  
   
收到  
   
> 12:59:32  蒋招司-产品-杭州  
   
收到  
   
> 13:00:20  立地成佛-点芯在线-开发  
   
收  
   
> 13:00:41  Jane-盈盈理财-产品经理  
   
收到  
   
> 13:04:57  李胜勇-永乐-G-北京  
   
收到  
   
> 13:06:51  Ying-小米支付-合规-北京  
   
收到  
   
> 13:14:10  双乾支付-技术总监-韩伟  
   
收到  
   
> 13:16:25  小孙-58-研发  
   
收到  
   
> 13:20:16  张戈-联动优势-DD  
   
好热闹，这段时间休假…  
   
> 13:20:22  黎明-金投-项目-杭州  
   
收到  
   
> 13:32:39  bingye-滴滴-国际化-北京  
   
收到  
   
> 13:53:19  杜雷-生物认证支付-技术  
   
收到  
   
> 14:19:37  张文-支付-技术  
   
收到  
   
> 14:20:31  亨元金融 Zero 研发  
   
[OK]  
   
> 14:20:56  张冀～众信～需要通道～福建  
   
[OK]  
   
> 14:21:43  老王-阿尔法-鼓励师-湖南  
   
[OK]  
   
> 14:24:00  张磊-信美-研发-北京  
   
[OK]  
   
> 14:30:29  班纳睿-RRD-开发  
   
收到  
   
> 14:30:47  罗志威－深圳－以太零  
   
收到  
   
> 14:40:53  Adun-爱云-研发-南京  
   
收到  
   
> 14:41:00  刘华伟-陌陌-开发  
   
收到  
   
> 14:42:56  哈哈贷-王信威  
   
收到  
   
> 14:47:13  王子硕-爱农支付-技术  
   
收到  
   
> 15:16:33  wenwen-Bellotec-开发-北京  
   
[OK]  
   
> 15:34:35  sophia-教育-产品-北京  
   
亲们，发一个招聘信息，如有打扰请见谅。某教育集团（已上市）紧急招聘支付、结算平台高级开发人员。有兴趣私聊。  
   
> 15:35:51  sophia-教育-产品-北京  
   
[Best wishes](&lt;tr style='mso-height-source:userset;height:25.00pt'&gt;&lt;td class=xl24  style='border-bottom:.5pt solid black;border-top:none;' x:str&gt;6367551827@chatroom)  
   
> 15:37:04  陆训-51信用卡-开发  
   
@zhuzhu_51信用卡?你也在  
   
> 15:40:06  david~圈存~技术  
   
教育集团也拿支付牌照？  
   
> 15:41:09  sophia-教育-产品-北京  
   
不差钱儿[偷笑]  
   
> 16:21:13  吴杰棣 首展科技 产品经理  
   
各位，有靠谱的对公对私四要素鉴权通道介绍吗？  
   
> 16:21:36  两碗面  
   
银联无卡业务关闭信用卡的，有了解的吗，或者有相关文档的  
   
> 16:21:59  吉信科技-紫君-产品  
   
@吴杰棣 首展科技 产品经理 有  
   
> 16:22:48  吴杰棣 首展科技 产品经理  
   
好的。我们私聊～  
   
> 16:23:17  wood-通联-技术  
   
有  
   
> 16:23:41  wood-通联-技术  
   
@吴杰棣 首展科技 产品经理?  
   
> 16:24:02  郑宇贤-惠丰-支付产品-广州  
   
可否说出来，学习学习[捂脸]  
   
> 16:24:51  蒋招司-产品-杭州  
   
@吉信科技-紫君-产品 他们公司“吉信科技”就是提供这个服务的[机智]  
   
> 16:26:51  吉信科技-紫君-产品  
   
@蒋招司-产品-杭州 看来蒋经理对我们公司挺了解的[呲牙]  
   
> 16:27:03  蒋招司-产品-杭州  
   
我们是客户啊  
   
> 16:27:19  周晓波-拉卡拉-产品  
   
大家好，请教个问题，第三方支付机构清结算这块，是分为交易对账和资金对账么？若是，资金对账是如何处理的？是人工对的还是系统自动处理，若都有系统参与，会更改某个状态么？  
   
> 16:28:00  吉信科技-紫君-产品  
   
@蒋招司-产品-杭州 您是哪家公司的呢？杭州确实有多家企业与我们有合作关系  
   
> 16:30:33  wood-通联-技术  
   
对账分为信息流对账和资金流对账  
   
> 16:30:44  蒋招司-产品-杭州  
   
@周晓波-拉卡拉-产品  应该是都对的。 我们对账是和渠道核对交易，取渠道的对账单文件核对。 资金和银行做应收款的核销，取银行的流水文件，渠道应收变备付金银存。 只作为参考  
   
> 16:31:17  wood-通联-技术  
   
信息流指的是确认交易状态，一般是以银行端的状态为主  
   
> 16:31:34  wood-通联-技术  
   
通过对账文件，程序自动核对  
   
> 16:32:17  wood-通联-技术  
   
资金对账指的是银行结算资金是否与信息流匹配  
   
> 16:33:09  wood-通联-技术  
   
有账务系统的，是通过账务系统中的金额与实际银行账户金额比较  
   
> 16:33:34  wood-通联-技术  
   
没有账务系统的，只能通过跑交易流水进行比较  
   
> 16:33:48  wood-通联-技术  
   
也就是清结算过程  
   
> 16:34:00  风兮-Java技术-上海  
   
@wood-通联-技术 你们资金核实是财务去核实还是银企直接取流水核对啊？  
   
> 16:34:25  wood-通联-技术  
   
都有  
   
> 16:34:28  wood-通联-技术  
   
有人工的  
   
> 16:34:41  风兮-Java技术-上海  
   
哦哦，谢谢  
   
> 16:34:42  wood-通联-技术  
   
不同银行不同的做法  
   
> 16:34:48  风兮-Java技术-上海  
   
也是  
   
> 16:34:57  周晓波-拉卡拉-产品  
   
感谢，我还不是太理解。 我举个例子，如果以银联作为渠道，银联会发送流水文件、ERR文件、和报表，并会在工作时间划款到支付机构。  
   
> 16:35:23  wood-通联-技术  
   
很简单，很多交易没有状态  
   
> 16:35:33  wood-通联-技术  
   
比如当时你没有获取到最终状态  
   
> 16:35:37  周晓波-拉卡拉-产品  
   
那这里如何去理解信息流对账、资金流对账呢？  
   
> 16:35:49  wood-通联-技术  
   
这种就需要通过下载对账文件，确认交易状态  
   
> 16:36:10  周晓波-拉卡拉-产品  
   
与渠道对账文件的勾兑，是否只是信息流的对账  
   
> 16:36:11  wood-通联-技术  
   
另外，还要看看有没有缺少交易  
   
> 16:36:18  wood-通联-技术  
   
是  
   
> 16:36:29  周晓波-拉卡拉-产品  
   
那么资金流的对账呢，如何去理解  
   
> 16:36:57  wood-通联-技术  
   
资金流的对账，是这笔钱什么时候到公司的账户  
   
> 16:37:13  wood-通联-技术  
   
实际中的哪些交易到账  
   
> 16:37:28  周晓波-拉卡拉-产品  
   
那这是人工确定的么？、  
   
> 16:37:32  wood-通联-技术  
   
到的钱是不是和应该到的一致  
   
> 16:37:42  wood-通联-技术  
   
这个是资金流的确认  
   
> 16:37:46  周晓波-拉卡拉-产品  
   
由清结算的运营人工查账？  
   
> 16:37:51  wood-通联-技术  
   
不同银行不同做法  
   
> 16:37:55  wood-通联-技术  
   
有人工查的  
   
> 16:38:00  wood-通联-技术  
   
有半自动的  
   
> 16:38:35  wood-通联-技术  
   
技术越好，应该做的人工参与的越少  
   
> 16:40:18  tonny-csii-pl-北京  
   
通联支付很喜欢资金流的对账[奸笑]  
   
> 16:40:51  周晓波-拉卡拉-产品  
   
我举个例子，万一对账文件对账后确认无误，但渠道划账资金少了。   这种情况是否只有人工处理？   
   
> 16:41:09  周晓波-拉卡拉-产品  
   
当然这种情况很少发生  
   
> 16:41:25  wood-通联-技术  
   
这种很多  
   
> 16:41:34  wood-通联-技术  
   
不是很少  
   
> 16:41:41  wood-通联-技术  
   
首先要确认是不是自己的问题  
   
> 16:41:53  wood-通联-技术  
   
然后让银行确认  
   
> 16:41:55  蒋招司-产品-杭州  
   
资金需要对账的另一个原因是资金核算，因为很多渠道的手续费是内扣的，你的结算款和交易款并不一致  
   
> 16:41:58  wood-通联-技术  
   
就是两边确认的过程  
   
> 16:41:59  风兮-Java技术-上海  
   
交易对账是防止机构与银行之间的交易信息不对等，例如银行成功机构失败、银行交易金额与机构不等。资金核对主要是防止银行结算资金入备付金账户不等，造成长短款的情况，例如机构请求银行一笔成功交易100元，银行实际结算到机构备付金账户金额为0  
   
> 16:42:30  wood-通联-技术  
   
如果是自己短款了，比如银行确认  
   
> 16:42:35  wood-通联-技术  
   
让银行补  
   
> 16:42:44  wood-通联-技术  
   
如果是自己长款了  
   
> 16:42:51  wood-通联-技术  
   
也让银行确认  
   
> 16:42:59  wood-通联-技术  
   
总之，钱原则上不能少  
   
> 16:43:09  风兮-Java技术-上海  
   
不管长短款都是银行去处理的  
   
> 16:43:39  天庭银行-看门的  
   
可以做余额的总分对账，然后监控提示  
   
> 16:43:51  风兮-Java技术-上海  
   
@周晓波-拉卡拉-产品 建议你参与你们公司网联项目，做完后你都理解了  
   
> 16:44:17  周晓波-拉卡拉-产品  
   
十分感谢，其实我的核心问题是，资金对账是否有系统参与，还是由人工处理？ 系统参与的话，是怎么处理的？  你刚刚有说到很多人工，也有半自动的。    
   
> 16:44:50  天庭银行-看门的  
   
如果是银行内的网联系统就可以自己调账了，当然程序要授权  
   
> 16:45:41  天庭银行-看门的  
   
@周晓波-拉卡拉-产品?网联有差错交易啊  
   
> 16:46:08  周晓波-拉卡拉-产品  
   
这种差错交易的发现，是在信息流对账时就发现的吧？  
   
> 16:46:34  风兮-Java技术-上海  
   
信息对账只是交易记录  
   
> 16:47:11  天庭银行-看门的  
   
你可以增加资金流的对账，只要你的备付金行给你开余额查询接口就行  
   
> 16:47:17  天庭银行-看门的  
   
@周晓波-拉卡拉-产品?  
   
> 16:47:18  风兮-Java技术-上海  
   
例如你们卡系统，卡充值流水记录100元，但是你账户到账90元。对流水是对不出来的  
   
> 16:47:19  周晓波-拉卡拉-产品  
   
也就是针对对账流水文件COM勾兑时就能发现的吧？  
   
> 16:48:17  天庭银行-看门的  
   
突然发现银行做的网联接入和支付机构做的网联接入角度不一样呢[奸笑]  
   
> 16:48:43  风兮-Java技术-上海  
   
个人觉得银行复杂很多  
   
> 16:48:52  wood-通联-技术  
   
是  
   
> 16:49:01  wood-通联-技术  
   
有的银行是收支两条线的  
   
> 16:49:05  风兮-Java技术-上海  
   
@乔广-开科维识-吉祥物 网联接口都不一样，角色都不一致  
   
> 16:49:07  wood-通联-技术  
   
有的银行是轧差的  
   
> 16:49:18  wood-通联-技术  
   
银行的要复杂的多  
   
> 16:49:23  风兮-Java技术-上海  
   
银行参与资金结算的，机构只有流水  
   
> 16:49:34  天庭银行-看门的  
   
@周晓波-拉卡拉-产品?理论上你只能做信息对账，如果资金有差错，你要通过网联的接口来调账  
   
> 16:49:36  wood-通联-技术  
   
接入网联后，应该会简单的多了  
   
> 16:49:48  风兮-Java技术-上海  
   
机构简单了  
   
> 16:49:55  wood-通联-技术  
   
应该是逐步简单了  
   
> 16:50:00  天庭银行-看门的  
   
我去看下支付机构的接口文档有没有差错  
   
> 16:50:05  天庭银行-看门的  
   
交易  
   
> 16:50:10  wood-通联-技术  
   
当然有  
   
> 16:50:14  wood-通联-技术  
   
怎么可能没有  
   
> 16:50:22  风兮-Java技术-上海  
   
网联接口文档分版本的把  
   
> 16:50:26  天庭银行-看门的  
   
那就只能走网联来调账  
   
> 16:50:30  wood-通联-技术  
   
差错是可以提交网联或者银联处理的  
   
> 16:50:31  周晓波-拉卡拉-产品  
   
@乔广-开科维识-吉祥物 感谢  
   
> 16:50:45  蒋招司-产品-杭州  
   
网联有差错接口的，只是很多机构用的差错平台，这些接口没开发  
   
> 16:50:57  天庭银行-看门的  
   
@周晓波-拉卡拉-产品?备付金行就是给你开了余额查询，你也不能自己调账  
   
> 16:51:23  蒋招司-产品-杭州  
   
给你个对账的流程图参考：   
   
> 16:51:24  蒋招司-产品-杭州  
   
![2018-07-31 16:51:24](http://static.cocolian.cn/img/201807/20180731_165124.png) 
   
> 16:51:25  天庭银行-看门的  
   
你只能对出上日余额不对  
   
> 16:51:57  天庭银行-看门的  
   
这不是网联的吧  
   
> 16:52:09  天庭银行-看门的  
   
这个对账流程  
   
> 16:52:36  蒋招司-产品-杭州  
   
网联哪有对账流程图  
   
> 16:52:41  天庭银行-看门的  
   
@周晓波-拉卡拉-产品?我做的是银行的网联，角度不同，不过咱俩可以沟通  
   
> 16:53:18  周晓波-拉卡拉-产品  
   
我主要是想了解支付机构一般清结算这块的对账处理流程  
   
> 16:53:22  周晓波-拉卡拉-产品  
   
感谢各位  
   
> 16:53:34  天庭银行-看门的  
   
……  
   
> 16:54:44  追梦-区块链金融-北京-技术经理  
   
[偷笑]  
   
> 16:55:07  周晓波-拉卡拉-产品  
   
了解下来，一般从系统角度处理的都时信息流对账（交易对账），或者说是针对通道的对账文件的处理；   而资金对账，估计就是看下应划款到账的金额是否有误（在交易对账已经处理的情况下）  
   
> 16:55:13  风兮-Java技术-上海  
   
@乔广-开科维识-吉祥物 你们银行端的做差错接口开发吗？还是用网联的平台啊  
   
> 16:55:40  天庭银行-看门的  
   
在开发，1.3的版本  
   
> 16:55:51  天庭银行-看门的  
   
用的网联的  
   
> 16:56:24  蒋招司-产品-杭州  
   
@周晓波-拉卡拉-产品  这两个是外部核对，有的还要在这之前完成内部系统的一致性核对  
   
> 16:56:25  风兮-Java技术-上海  
   
哦哦。好的，我也不希望开发他们差错接口  
   
> 16:56:40  天庭银行-看门的  
   
银行端单独做差错接口没意义，交易都是过网联的，不走清算平台，这个差错调账开放给支付机构也没用不是  
   
> 16:57:33  风兮-Java技术-上海  
   
差错开发也是做一套单独的差错平台和网联差不多，只是一个是内部一个外部的  
   
> 16:57:55  天庭银行-看门的  
   
系统内部的差错调账是有的  
   
> 16:58:00  风兮-Java技术-上海  
   
支付机构也有差错接口  
   
> 16:58:23  风兮-Java技术-上海  
   
差错调账目前好像都是银行单边账吗？  
   
> 16:58:28  天庭银行-看门的  
   
这个感觉好奇妙。。。突然发现自己做的系统，对接角色不同，关注点也不同。。。  
   
> 16:59:37  蒋招司-产品-杭州  
   
角色--&amp;gt;场景--&amp;gt;系统[机智]  
   
> 17:00:02  天庭银行-看门的  
   
咱俩先统一下名词，银行单边指的是支付机构记成功，银行记不成功？  
   
> 17:01:20  天庭银行-看门的  
   
网联和大小额一样，支付机构和银行都是参与者，单边问题是清算平台本身在处理，如果出现单边，意味着自己业务逻辑有问题吧  
   
> 17:01:57  天庭银行-看门的  
   
支付机构也对接网联，银行也对接网联，支付机构又不直接对接银行  
   
> 17:02:33  风兮-Java技术-上海  
   
我的意思是差错处理好像现在都是单边账  
   
> 17:03:03  风兮-Java技术-上海  
   
支付机构现在都是向银行发起核查，核查确认问题，银行做调账  
   
> 17:03:40  风兮-Java技术-上海  
   
不知道我的理解是否有问题，当初他们差错处理我搞了很久都不是特别理解  
   
> 17:05:21  天庭银行-看门的  
   
差错提交申请是由支付机构发起的  
   
> 17:06:09  天庭银行-看门的  
   
长短款调账又分成了贷记和借记  
   
> 17:06:32  天庭银行-看门的  
   
主要是网联那个差错调账申请的交易描述写的有点绕  
   
> 17:07:58  风兮-Java技术-上海  
   
银行也是可以单独差错申请吧  
   
> 17:07:59  天庭银行-看门的  
   
255报文得几个字几个字的扣。。。。  
   
> 17:08:58  天庭银行-看门的  
   
银行不用申请差错。。。  
   
> 17:09:37  风兮-Java技术-上海  
   
![2018-07-31 17:09:37](http://static.cocolian.cn/img/201807/20180731_170937.png) 
   
> 17:10:21  天庭银行-看门的  
   
你指第一步吗？  
   
> 17:11:10  风兮-Java技术-上海  
   
嗯，第一步你们应该要做的  
   
> 17:11:25  天庭银行-看门的  
   
银行可以发差错调账申请走贷记来调账  
   
> 17:12:09  风兮-Java技术-上海  
   
其实就是255接口，好像现在支付机构用不到  
   
> 17:12:14  风兮-Java技术-上海  
   
我理解的情况是这样  
   
> 17:13:01  风兮-Java技术-上海  
   
![2018-07-31 17:13:01](http://static.cocolian.cn/img/201807/20180731_171301.png) 
   
> 17:13:41  风兮-Java技术-上海  
   
就这三个差错类别，是不是都是银行发起调账申请处理的呢？  
   
> 17:14:37  天庭银行-看门的  
   
支付机构可以发起例外长款调账  
   
> 17:15:22  风兮-Java技术-上海  
   
场景呢？  
   
> 17:15:25  天庭银行-看门的  
   
这个调账得套着交易说，又不容易乱  
   
> 17:15:29  风兮-Java技术-上海  
   
其实我就是这块没明白  
   
> 17:16:27  天庭银行-看门的  
   
这样，以协议支付交易举例吧  
   
> 17:16:43  风兮-Java技术-上海  
   
OK，感谢[玫瑰]  
   
> 17:17:24  天庭银行-看门的  
   
收款行是你的备付金行对吧  
   
> 17:17:34  天庭银行-看门的  
   
付款行比如是工商银行  
   
> 17:17:40  风兮-Java技术-上海  
   
是的  
   
> 17:18:04  天庭银行-看门的  
   
在原交易的收款行作为差错调账的发起方、原交易的付款行作为差错调账的接收方时，发起方通 过此报文向平台发起贷记调整。  
   
> 17:18:09  天庭银行-看门的  
   
替换一下  
   
> 17:18:25  天庭银行-看门的  
   
备付金行比如是建行  
   
> 17:19:57  天庭银行-看门的  
   
贷记调整就是建行给工行钱  
   
> 17:20:20  天庭银行-看门的  
   
建行作为差错调账的发起方、工行作为差错调账的接收方时，发起方通 过此报文向平台发起贷记调整。  
   
> 17:22:08  天庭银行-看门的  
   
然后倒推差错的原因，工行自己内部交易处理失败，然后通知网联付款成功，然后网联通知建行付款成功，建行备付金记一笔账，会计分录就不说了啊，太麻烦了，就简单一点  
   
> 17:24:09  天庭银行-看门的  
   
借记调账就反过来了，差错原因也可以倒推  
   
> 17:25:08  风兮-Java技术-上海  
   
嗯嗯，这个是银行之间发起的，这俩了解了  
   
> 17:25:20  天庭银行-看门的  
   
![2018-07-31 17:25:20](http://static.cocolian.cn/img/201807/20180731_172520.png) 
   
> 17:25:35  天庭银行-看门的  
   
其实就是把这一堆描述里的套进去  
   
> 17:27:24  风兮-Java技术-上海  
   
![2018-07-31 17:27:24](http://static.cocolian.cn/img/201807/20180731_172724.png) 
   
> 17:28:35  风兮-Java技术-上海  
   
这里的例外描述，但是调账失误也是银行端的问题，也是银行做例外发起。机构在这里怎么做的例外交易呢？  
   
> 17:29:03  天庭银行-看门的  
   
相当于催账。。。  
   
> 17:29:18  风兮-Java技术-上海  
   
[惊讶]  
   
> 17:30:55  天庭银行-看门的  
   
稍等啊，我也有点乱，我想一下贷记调整失误的原因。。。  
   
> 17:31:18  风兮-Java技术-上海  
   
长款不是备付金的账户金额多余账务金额哇？  
   
> 17:32:40  天庭银行-看门的  
   
嗯，收款行多记了  
   
> 17:35:24  风兮-Java技术-上海  
   
例外长款就是调账后或者直接付款行平账了，收款行多存入备付金账户金额？  
   
> 17:42:51  天庭银行-看门的  
   
@风兮-Java技术-上海 例外长款返回的是通用应答报文，所以这个差错调账申请对于支付机构来说就是一个催账的功能。。。  
   
> 17:43:49  天庭银行-看门的  
   
或者叫通知备付金行有长款了。。。  
   
> 17:44:47  tonny-csii-pl-北京  
   
资金流对账貌似可以用入账结果查询来代替  
   
> 18:33:54  风兮-Java技术-上海  
   
@乔广-开科维识-吉祥物?好像有点明白了，感谢[握手]  
   
> 18:34:22  天庭银行-看门的  
   
我开始写文档了。。。@风兮-Java技术-上海  
   
> 18:34:52  天庭银行-看门的  
   
不过得出来的结论是差错调账申请报文没卵用。。。  
   
> 18:34:54  风兮-Java技术-上海  
   
啥文档  
   
> 18:35:04  风兮-Java技术-上海  
   
哈哈??   
   
> 18:35:14  天庭银行-看门的  
   
就是一个通知类的报文，解决不了问题  
   
> 18:35:26  天庭银行-看门的  
   
差错交易的梳理文档  
   
> 18:35:29  风兮-Java技术-上海  
   
实际对于银行有用  
   
> 18:35:37  天庭银行-看门的  
   
银行也没有。。。  
   
> 18:35:59  风兮-Java技术-上海  
   
不会吧，银行出差错很正常  
   
> 18:36:15  天庭银行-看门的  
   
返回的是一个通用应答，现在系统的处理是收到这个报文就做提示，人工介入  
   
> 18:36:51  风兮-Java技术-上海  
   
:)  
   
> 18:37:23  风兮-Java技术-上海  
   
差错就是人工干预，系统实际无法自动处理  
   
> 18:38:03  风兮-Java技术-上海  
   
网联实现的太细腻了，一个夹角都不放过  
   
> 18:39:19  天庭银行-看门的  
   
嗯  
   
> 18:39:23  天庭银行-看门的  
   
等我写完的。。。  
   
> 18:39:33  风兮-Java技术-上海  
   
??   
   
> 18:39:40  天庭银行-看门的  
   
结论有了，但就想把这个事缕清楚  
   
> 19:00:38  丁丁-群管理  
   
今天请到一位嘉宾，@杨宽-京东金融-鼓励师    给大家做分享，主题是 “单元测试利器：自研pmock框架” 开始时间为【20:00】；欢迎欢迎[鼓掌][鼓掌][鼓掌]！（注： 1.嘉宾分享期间其他人不要发言打断嘉宾分享。2.分享完成后请大家积极补充和提问；3.烦请打“签到”，做签到，谢谢！)  
   
> 19:00:55  丁丁-群管理  
   
欢迎欢迎[鼓掌][鼓掌][鼓掌]  
   
> 19:00:58  韩国才-软通动力-java开发  
   
签到  
   
> 19:01:16  追梦-区块链金融-北京-技术经理  
   
签到  
   
> 19:02:35  北京-中投科信产品-张冠杰  
   
签到  
   
> 19:03:15  班纳睿-RRD-开发  
   
签到  
   
> 19:03:18  地平线-文思-产品  
   
[耶][耶][耶][耶][耶]  
   
> 19:03:41  周晓波-拉卡拉-产品  
   
签到  
   
> 19:05:50  徐敏-传化  
   
签到  
   
> 19:05:51  csp-架构-深圳  
   
签到  
   
> 19:06:10  【信融集团】·王瑞  
   
我来了  
   
> 19:06:18  十年砍柴-元年-产品-上海  
   
签到  
   
> 19:06:29  蒋招司-产品-杭州  
   
签到  
   
> 19:06:49  郭旭东-产品-上海  
   
签到  
   
> 19:07:17  风兮-Java技术-上海  
   
签到  
   
> 19:07:27  申彬彬-随行付-PM-北京  
   
签到  
   
> 19:07:37  上海-陆金所-蒋晓峰  
   
签到  
   
> 19:08:27  辉_数尊_研发_上海  
   
签到  
   
> 19:09:31  卢章-联逸科技-创始人  
   
签到  
   
> 19:10:45  深圳-平安-产品-黄朋英  
   
签到  
   
> 19:12:03  张璐璐-NUCC-北京  
   
签到  
   
> 19:14:08  zz-工行-架构  
   
签到  
   
> 19:14:25  文刚_卓健_产品经理_杭州  
   
签到  
   
> 19:15:11  荣耀-随手科技-技术-深圳  
   
签到  
   
> 19:15:49  Jerry-BOCS  
   
签到  
   
> 19:16:03  杨杰-康城投资-开发-上海  
   
签到  
   
> 19:16:10  李伟 聚合 开发  
   
签到  
   
> 19:16:49  Toby-qianduan-系统重构-gz  
   
签到  
   
> 19:17:06  鹏-东银-Java后端  
   
签到  
   
> 19:20:40  DouWei-贝络-PA-北京  
   
签到  
   
> 19:21:00  XZ-中金-产品  
   
签到  
   
> 19:21:07  王成龙-新浪跨境支付-研发  
   
签到  
   
> 19:21:28  蔡郑豪-统统付-开发  
   
签到  
   
> 19:21:32  刘易坤-vnion-研发  
   
签到  
   
> 19:22:14  杨海华-汇桔网-研发-广州  
   
签到  
   
> 19:22:22  振效+神码+西安  
   
签到  
   
> 19:23:38  雪飞-万年草-产品-北京  
   
签到  
   
> 19:24:41  盒子先生-ABW-架构  
   
签到  
   
> 19:25:06  Simi-腾讯-产品  
   
签到  
   
> 19:25:13  袁增辉-易联汇华-技术-北京  
   
签到  
   
> 19:25:23  张杨-航天电子-研发  
   
签到  
   
> 19:25:35  王晓强-绿地金控-技术-上海  
   
签到  
   
> 19:25:38  王洪悦-优付全球-开发-北京  
   
签到  
   
> 19:25:48  吕波-融投世界科技-技术总监-沈阳  
   
签到  
   
> 19:26:30  王子硕-爱农支付-技术  
   
签到  
   
> 19:27:41  刘小龙~金融工场~技术经理～北京  
   
签到  
   
> 19:27:42  李胜勇-永乐-G-北京  
   
签到  
   
> 19:28:43  张磊-信美-研发-北京  
   
签到  
   
> 19:28:48  百联-田浩沛  
   
宽叔呀！签到！  
   
> 19:31:45  hgwym-传化支付-技术经理  
   
签到  
   
> 19:31:57  刘飞-云闪科技-程序员-北京  
   
签到  
   
> 19:32:58  程琳_群管理  
   
签到  
   
> 19:33:22  成都-千山  
   
签到  
   
> 19:33:57  澜柯-快钱-研发  
   
签到]  
   
> 19:34:22  吉信科技-紫君-产品  
   
签到  
   
> 19:34:51  江冬勤+天天开工+技术总监  
   
签到  
   
> 19:35:54  陈琼-开课啦-产品-杭州  
   
签到  
   
> 19:36:47  支付产品-林敏  
   
签到  
   
> 19:36:49  Daniel-快钱-架构  
   
签到  
   
> 19:36:52  泽西-趋恒-架构师  
   
签到  
   
> 19:36:55  泽西-趋恒-架构师  
   
签了  
   
> 19:37:01  未来酱 群管理  
   
签到  
   
> 19:39:54  果立橙-supernova-dataer  
   
签到  
   
> 19:40:25  弋碎-国美-产品  
   
签到  
   
> 19:42:18  曾卓-长丰集团-架构师-长沙  
   
签到  
   
> 19:42:24  盛-中科金服-研发  
   
签到  
   
> 19:52:04  王同学-汇付-研发  
   
签到  
   
> 19:52:08  平安银行南京王子豪  
   
签到  
   
> 19:54:05  陈秋彬-科蓝  
   
签到  
   
> 19:54:58  许佳伟-产品/市场-深圳  
   
签到  
   
> 19:56:27  张岩-华恒科技-商务-吉林  
   
签到  
   
> 19:56:57  杨宽-京东金融-鼓励师  
   
[sinpina:](&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;)  
   
> 19:57:20  杨宽-京东金融-鼓励师  
   
8点开始讲，大家流量够，可以先看看ppt  
   
> 19:57:28  博小白-reapal-研发-北京  
   
签到  
   
> 19:58:10  刘鸿亮  
   
签到  
   
> 19:59:35  杨宽-京东金融-鼓励师  
   
分享主要面向java语言的开发和测试开发同学，先说单元测试、mock测试的定义，再比较几个主流的用于单元测试的mock框架。后面再说我遇到的痛点，根据我的痛点，设计了产品思路，然后快速用代码实现了一个mock框架，右面迭代了几个版本，添加了好几个特性  
   
> 20:00:15  杨宽-京东金融-鼓励师  
   
[pmock介绍](http://note.youdao.com/noteshare?id=89b4d90d6aa233d154fceda80e50778f)  
   
> 20:00:28  杨宽-京东金融-鼓励师  
   
这是文章介绍。  
   
> 20:01:08  杨宽-京东金融-鼓励师  
   
我准备开始了，图片和文字结合分享，流量不够的童鞋，对不住了。[呲牙]  
   
> 20:01:28  杨宽-京东金融-鼓励师  
   
先不免俗套，介绍下单元测试定义  
   
> 20:01:49  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:01:49](http://static.cocolian.cn/img/201807/20180731_200149.png) 
   
> 20:01:55  杨宽-京东金融-鼓励师  
   
单元测试 定义:为检查某个方法是否如预期工作，而写的测试代码 单元:代码中可度量的最小单元，方法或者函数 结果:不同的case输入对应的输出是否与预期一致  
   
> 20:02:23  杨宽-京东金融-鼓励师  
   
测试层次: 微基准测试、单元测试、功能测试、集成联调测试。如下图，应该还有一些，我没列出来  
   
> 20:02:50  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:02:50](http://static.cocolian.cn/img/201807/20180731_200250.png) 
   
> 20:03:41  杨宽-京东金融-鼓励师  
   
下面说下单元测试的例子。例子很简单，但是现实中的代码很复杂，相互依赖多。就引发了mock造假数据进行测试。  
   
> 20:03:49  杨宽-京东金融-鼓励师  
   
public int sum(int a,int b){         return  a + b;     }     @Test     public void sumTest(){          int sum = sum(1,2);         assertTrue(sum==3);     }  
   
> 20:04:04  杨宽-京东金融-鼓励师  
   
现实中很少这样简单的代码  
   
> 20:04:31  杨宽-京东金融-鼓励师  
   
mock测试的简介 定义:用来虚拟制造对象及数据的，被虚拟制造的对象 作用:辅助单元测试快速进行的主要手段 原因:被测试的方法里，依赖的对象，需要被快速被虚拟制造  
   
> 20:04:44  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:04:44](http://static.cocolian.cn/img/201807/20180731_200444.png) 
   
> 20:05:28  杨宽-京东金融-鼓励师  
   
mockc测试的好处，主要是隔离系统或者模块，快速并行开发测试和演示  
   
> 20:05:30  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:05:30](http://static.cocolian.cn/img/201807/20180731_200530.png) 
   
> 20:06:22  杨宽-京东金融-鼓励师  
   
当然单元测试本身也会倒逼你进行代码抽象和简洁。通常进行codereview，从单元测试入手，是比较鸡贼的好方法  
   
> 20:06:33  Jane-盈盈理财-产品经理  
   
签到  
   
> 20:06:56  杨宽-京东金融-鼓励师  
   
被测试方法的示例 public List  saveStudent(Student student){       List&amp;lt;Student&amp;gt; studentList = studentDao.query(student);       。。。。。       studentDao.save(student); } 省略了很多代码。mock对象:studentDao,mock方法:query、save 用例case:输入参数student，mock的返回值，示例里没有展示。  
   
> 20:07:08  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:07:08](http://static.cocolian.cn/img/201807/20180731_200708.png) 
   
> 20:07:22  杨宽-京东金融-鼓励师  
   
这示例里，case做的不太好。篇幅限制  
   
> 20:08:18  杨宽-京东金融-鼓励师  
   
java用于单元测试的主流mock框架:easymock、mockito、powermock、spock。  
   
> 20:09:54  杨宽-京东金融-鼓励师  
   
这些框架要学习的关键词包括：given、and、when、 then、 thenReturn 、andReturn、 verify、 where、 times、 expect、 replay等......  
   
> 20:10:31  杨宽-京东金融-鼓励师  
   
底层实现原理：无非是对被mock的类、接口、方法，进行动态代理或者字节码增强  
   
> 20:10:48  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:10:48](http://static.cocolian.cn/img/201807/20180731_201048.png) 
   
> 20:12:18  杨宽-京东金融-鼓励师  
   
上面图片左边图片是被测试的方法，里面调用几个外部对象，包括dao、rpc，然后根据返回的数据进行过滤、处理  
   
> 20:12:19  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:12:19](http://static.cocolian.cn/img/201807/20180731_201219.png) 
   
> 20:13:58  杨宽-京东金融-鼓励师  
   
右边是mockito框架进行mock测试，可以看出用了刚才提到的很多关键词。这些都是高阶函数，目前jdk8也支持了函数式编程。函数编程用户体验好  
   
> 20:15:04  杨宽-京东金融-鼓励师  
   
import static org.mockito.Mockito.mock; import static org.mockito.Mockito.when; 可以通过import static 引入让高阶函数达到最简易  
   
> 20:16:24  杨宽-京东金融-鼓励师  
   
下面说下另一个mock框架，它使用groovy脚本编写。groovy另一个杀手级应用是gradle，代替maven的  
   
> 20:17:20  杨宽-京东金融-鼓励师  
   
groovy最大程度兼容了java语法，同时也能用自己的胶水语言风格，也能和java所用框架轻易结合起来，比容spring  
   
> 20:18:23  杨宽-京东金融-鼓励师  
   
左边图不变，是被测试方法内容。右边是groovy的mock测试，坐过BDD开发的，应该感到很亲切。  
   
> 20:18:24  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:18:24](http://static.cocolian.cn/img/201807/20180731_201824.png) 
   
> 20:19:25  杨宽-京东金融-鼓励师  
   
以上介绍了两款mock测试框架，熟悉java开发的同学，应该看出来了，有些缺点  
   
> 20:19:40  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:19:40](http://static.cocolian.cn/img/201807/20180731_201940.png) 
   
> 20:20:26  杨宽-京东金融-鼓励师  
   
主流mock框架缺点: 学些成本高、case硬编码&amp;amp;分散、单独维护mock的单元测试  
   
> 20:21:15  杨宽-京东金融-鼓励师  
   
应对需求变化也不足。基于以上问题，我根据痛点出发，琢磨了自己的产品思路  
   
> 20:21:49  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:21:49](http://static.cocolian.cn/img/201807/20180731_202149.png) 
   
> 20:22:52  杨宽-京东金融-鼓励师  
   
我做的这个产品，取名pmock。主要特点:集中管理case、cese支持多种jvm脚本编写、0学习成本、无侵入兼容springjunit测试。  
   
> 20:24:22  杨宽-京东金融-鼓励师  
   
我对比了下，很少同学进行单元测试，即使做单元测试，java开发童鞋也是使用springjunit。springjunit实际上要启动整个spring框架，相当于基于联通、联调式的单元测试了  
   
> 20:25:45  杨宽-京东金融-鼓励师  
   
pmock支持无侵入让springjunit的单元测试，切换到mock测试里，springjunit和mock测试合二为一  
   
> 20:26:47  杨宽-京东金融-鼓励师  
   
pmock代码学习成本:如上图的mockTarget、mockObject、mockField、target四个词  
   
> 20:27:19  杨宽-京东金融-鼓励师  
   
原理：是通过对被mock的类、方法，绑定case脚本文件，进行代理或者代码增强  
   
> 20:27:33  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:27:33](http://static.cocolian.cn/img/201807/20180731_202733.png) 
   
> 20:28:47  杨宽-京东金融-鼓励师  
   
如图。被mock的类和caseConfig目录下的脚本文件一 一映射。可以支持js、groovy、ruby、python等脚本  
   
> 20:28:55  京东-David-EPT  
   
@杨宽-京东金融-鼓励师  pmock 是那么搞的?  
   
> 20:29:09  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:29:09](http://static.cocolian.cn/img/201807/20180731_202909.png) 
   
> 20:30:07  杨宽-京东金融-鼓励师  
   
PersonBusinessDao.java里有queryPersonList方法，所以需要对PersonBusinessDao的方法queryPersonList进行mock，那么如上图脚本文件里也有  
   
> 20:31:07  杨宽-京东金融-鼓励师  
   
上图可以认为就是某个被mock方法的case管理，case无非就是一堆if else，根据输入参数，返回预期想要的数据。  
   
> 20:32:30  杨宽-京东金融-鼓励师  
   
输入参数由pmock框架对输入对象序列化成json字符串，然后返回的json串有pmock反序列化成对象。当然如果是基本类型，pmock也会自动识别  
   
> 20:33:15  杨宽-京东金融-鼓励师  
   
另外，如果要返回异常、设置超时、设置响应时间，都可以在脚本的方法里，根据脚本语言特性自己编写  
   
> 20:34:19  杨宽-京东金融-鼓励师  
   
下面再详细介绍下pmock优点的几个特性，按照迭代版本从最新开始讲  
   
> 20:34:50  杨宽-京东金融-鼓励师  
   
为了以前基于springjunit同学能方便快速用，加了模块  
   
> 20:34:53  夏其燕 交行软开 架构师  
   
在那直播？  
   
> 20:34:56  夏其燕 交行软开 架构师  
   
哪  
   
> 20:35:03  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:35:03](http://static.cocolian.cn/img/201807/20180731_203503.png) 
   
> 20:36:34  杨宽-京东金融-鼓励师  
   
特性1：兼容springjunit测试，零侵入。即启动spring容器进行单元测试  原理:通过BeanPostProcessor过滤bean的注入;重写时，调用pmock底层组件  缺点:要启动spring容器;要解析特殊bean的toString  不小心创造的好处:单元测试之外的mock  
   
> 20:37:23  杨宽-京东金融-鼓励师  
   
最后一个特点，可以方便让基于spring框架的微服务之间快速进行各种case的mock测试。不用跨网络，在本机调用就可以。  
   
> 20:37:45  杨宽-京东金融-鼓励师  
   
强调一点：一定要对spring容器启动进行优化，不该注入别注入  
   
> 20:37:59  杨宽-京东金融-鼓励师  
   
后面有时间话，讲讲如何优化spring容器启动  
   
> 20:38:32  杨宽-京东金融-鼓励师  
   
特性2：显式使用pmock方法，侵入性极简 原理：Mock对象通过case脚本，生成动态代理  优点：快速启动  
   
> 20:38:52  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:38:52](http://static.cocolian.cn/img/201807/20180731_203852.png) 
   
> 20:39:38  杨宽-京东金融-鼓励师  
   
特性3也是最早的版本：使用探针javaagent无侵入 原理：Javaagent使用premain进行方法级别的代码增强 优点：代码0侵入 缺点：需配置探针;不能mock接口  
   
> 20:39:59  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:39:59](http://static.cocolian.cn/img/201807/20180731_203959.png) 
   
> 20:40:22  杨宽-京东金融-鼓励师  
   
红框里即是通过探针进行代码增强的  
   
> 20:41:08  杨宽-京东金融-鼓励师  
   
特性4：case在线配置，让case配置彻底脱离工程，这个配置中心一个原理  
   
> 20:41:24  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:41:24](http://static.cocolian.cn/img/201807/20180731_204124.png) 
   
> 20:42:17  杨宽-京东金融-鼓励师  
   
右图和左图在一个页面。右图可以在线运行你配置的case，在线输入参数，然后返回你预期的数值  
   
> 20:43:00  杨宽-京东金融-鼓励师  
   
最后说下单元测试的倒逼代码设计好处  
   
> 20:43:02  杨宽-京东金融-鼓励师  
   
![2018-07-31 20:43:02](http://static.cocolian.cn/img/201807/20180731_204302.png) 
   
> 20:43:42  杨宽-京东金融-鼓励师  
   
在开发代码时，要考虑如果单元测试；在写单元测试，也考虑怎么方便codeview。  
   
> 20:45:02  杨宽-京东金融-鼓励师  
   
如果被测试的方法和类，不够简洁，太复杂，依赖的对象太多。是对mock测试最大的伤害，因为需要依赖3个以上的mock对象，再方便的case管理，也很难维护内部的逻辑了  
   
> 20:45:31  杨宽-京东金融-鼓励师  
   
今天，先到这里吧。后面还有部分springjunit的优化，大家感兴趣，可以看看ppt  
   
> 20:45:54  杨宽-京东金融-鼓励师  
   
大家对单元测试感兴趣的，可以提问  
   
> 20:46:13  杨宽-京东金融-鼓励师  
   
[玫瑰][玫瑰][玫瑰][玫瑰]  
   
> 20:46:59  杨宽-京东金融-鼓励师  
   
[sinpina:](&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;)  
   
> 20:47:25  杨宽-京东金融-鼓励师  
   
大家有时间看看ppt，github源码链接在里面。有问题，群里随时沟通  
   
> 20:47:58  杨宽-京东金融-鼓励师  
   
如果对我的产品思路，觉得完全没必要，也可以指摘  
   
> 20:48:20  杨宽-京东金融-鼓励师  
   
[pmock介绍](http://note.youdao.com/noteshare?id=89b4d90d6aa233d154fceda80e50778f)  
   
> 20:48:25  杨宽-京东金融-鼓励师  
   
详细文章  
   
> 20:50:32  双乾支付-技术总监-韩伟  
   
谢谢  
   
> 20:50:33  地平线-文思-产品  
   
[红包][红包][红包][红包][红包]  
   
> 20:52:28  秋水-阿里云-鼓励师  
   
给力，写的好  
   
> 20:55:28  杨宽-京东金融-鼓励师  
   
目前还没有实现自动化配置。我理解你说的自动化配置，要和持续集成、持续部署在一起？  
   
> 20:55:43  永明-云账户-开发-北京  
   
是的  
   
> 20:56:10  永明-云账户-开发-北京  
   
因为金融产品业务复杂，如果持续添加case，会太麻烦  
   
> 20:56:26  杨宽-京东金融-鼓励师  
   
这块是后面考虑要做的。目前没啥思路  
   
> 20:57:30  杨宽-京东金融-鼓励师  
   
「永明-云账户-开发-北京：因为金融产品业务复杂，如果持续添加case，会太麻烦」 - - - - - - - - - - - - - - - 对，金融case复杂，更要单元测试。且最好优化方法，每个方法最好最到依赖mock对象少一点  
   
> 20:58:07  杨宽-京东金融-鼓励师  
   
单元测试是个很好的倒逼代码抽象、简洁的方式，所以才有TDD开发  
   
> 20:58:20  韩国才-软通动力-java开发  
   
你们部门在用吗？  
   
> 20:58:42  杨宽-京东金融-鼓励师  
   
简单来说，如果一个人没有做过单元测试，最好不要和他谈TDD、BDD，哈哈哈~  
   
> 20:58:47  杨宽-京东金融-鼓励师  
   
我们组里在用  
   
> 20:59:15  地平线-文思-产品  
   
小白提问：mock和挡板有啥区别啊[奸笑]  
   
> 20:59:30  杨宽-京东金融-鼓励师  
   
mock就是挡板，不好意思，我没有提  
   
> 21:00:14  杨宽-京东金融-鼓励师  
   
我曾经连续两天一直编写单元测试，是编写别人工程的。对质量、快速联调帮助很大。后面需求部分变更了，也能快速进行回归测试，收益费钱  
   
> 21:00:29  杨宽-京东金融-鼓励师  
   
![2018-07-31 21:00:29](http://static.cocolian.cn/img/201807/20180731_210029.png) 
   
> 21:00:59  杨宽-京东金融-鼓励师  
   
这是我们根据新规，和p2p的托管行打交道的部分接口组装测试  
   
> 21:01:27  韩国才-软通动力-java开发  
   
接口，类的mock，都需要-javaagent:realpath\pmock-agent.jar这种方式配置好吗  
   
> 21:02:17  杨宽-京东金融-鼓励师  
   
不是。探针javaagent只是pmock的一种方式，可以完全不使用  
   
> 21:02:26  杨宽-京东金融-鼓励师  
   
直接用显示的声明  
   
> 21:02:33  韩国才-软通动力-java开发  
   
哦。   
   
> 21:02:50  杨宽-京东金融-鼓励师  
   
![2018-07-31 21:02:50](http://static.cocolian.cn/img/201807/20180731_210250.png) 
   
> 21:02:54  杨宽-京东金融-鼓励师  
   
mockTarget(PersonBusinessServiceImpl.class).                     mockObject(PersonBusinessDao.class).                             mockObject(PlayRpc.class).                             mockField(&amp;quot;playRpc&amp;quot;).                             mockField(&amp;quot;personBusinessDao&amp;quot;).target();  
   
> 21:02:58  杨宽-京东金融-鼓励师  
   
这种  
   
> 21:03:26  杨宽-京东金融-鼓励师  
   
探针javaagent，不能mock接口，且需要配置  
   
> 21:03:43  杨宽-京东金融-鼓励师  
   
源码工程  
   
> 21:03:44  杨宽-京东金融-鼓励师  
   
![2018-07-31 21:03:44](http://static.cocolian.cn/img/201807/20180731_210344.png) 
   
> 21:03:55  韩国才-软通动力-java开发  
   
嗯    
   
> 21:04:12  杨宽-京东金融-鼓励师  
   
依赖pmock-agent就好了。再根据demo里示例学习下  
   
> 21:04:24  杨宽-京东金融-鼓励师  
   
要求在线配置的，可以部署pmock-server  
   
> 21:05:18  杨宽-京东金融-鼓励师  
   
大家有兴趣的，也可以自己修改源码，添加自己的特性，每个工程都做了自己的单元测试。  
   
> 21:06:03  李勇~易极付~PL  
   
[强]  
   
> 21:08:17  杨宽-京东金融-鼓励师  
   
大家有什么问题，私聊我或者群里问都可以，我先去下健身房  
   
> 21:08:32  韩国才-软通动力-java开发  
   
target这个方法是干什么的  
   
> 21:09:44  杨宽-京东金融-鼓励师  
   
返回被测试的类  
   
> 21:10:08  杨宽-京东金融-鼓励师  
   
前面需要将mock的对象，赋给被测试的类  
   
> 21:11:00  杨宽-京东金融-鼓励师  
   
mockTarget(PersonBusinessServiceImpl.class)这是初始化被测试的类  
   
> 21:11:15  杨宽-京东金融-鼓励师  
   
几个关键词，都用了高阶函数风格  
   
> 21:14:13  右军-蚂蚁金服-成都  
   
手动点赞宽哥  
   
> 21:14:42  右军-蚂蚁金服-成都  
   
我们大团队也有一套测试框架 现在通过科技服务对外输出  
   
> 21:16:12  夏其燕 交行软开 架构师  
   
啥测试框架？  
   
> 21:20:10  地平线-文思-产品  
   
[强]  
   
> 21:20:18  地平线-文思-产品  
   
啥测试框架？  
   
> 22:13:29  韩国才-软通动力-java开发  
   
jackson-all这个jar包哪来的  
   
> 22:14:14  杨宽-京东金融-鼓励师  
   
Pmock吗？  
   
> 22:14:57  韩国才-软通动力-java开发  
   
pmock-server里  
   
> 22:16:00  韩国才-软通动力-java开发  
   
还有agent里javassist没有，但是org.javassist有  
   
> 22:16:12  杨宽-京东金融-鼓励师  
   
Pom里的，我依赖的仓库是我司的。你用的仓库里没有么？  
   
> 22:17:24  韩国才-软通动力-java开发  
   
hamcrest-all 有1.3,没有1.2.我网上没找到  
   
> 22:18:42  杨宽-京东金融-鼓励师  
   
你弄成1.3应该没问题  
   
> 22:19:41  韩国才-软通动力-java开发  
   
是。  
   
