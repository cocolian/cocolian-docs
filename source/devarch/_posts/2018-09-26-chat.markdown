---
layout:     source 
title:      "2018-09-26-WeChat"
date:       2018-09-26 12:00:00
author:     夏其燕-交行-系统架构师-上海
lines:      164 
tag:       [chat]
---
> 12:09:13  支付产品开发交流群  
   
[6367551827@chatroom:
](&amp;lt;sysmsg type=&amp;quot;sysmsgtemplate&amp;quot;&amp;gt;)  
   
> 12:09:13    
   
> 13:43:57  丁丁-群管理  
   
今天请到一位朋友，@夏其燕-交行-系统架构师-上海   给大家做分享，主题是 “网联支付线上压测过后的架构漫谈” 开始时间为【16:00】；欢迎欢迎[鼓掌][鼓掌][鼓掌]！（注： 1.嘉宾分享期间其他人不要发言打断嘉宾分享。2.分享完成后请大家积极补充和提问；3.烦请打“签到”，做签到，谢谢！)  
   
> 13:44:00  丁丁-群管理  
   
欢迎欢迎  
   
> 13:44:02  丁丁-群管理  
   
签到  
   
> 13:44:14  吕波-融投世界科技-技术总监-沈阳  
   
签到  
   
> 13:44:19  蒋招司-产品-杭州  
   
签到  
   
> 13:44:19  王成龙-新浪跨境-研发-上海  
   
签到  
   
> 13:44:26  洋洋-点融-开发  
   
签到  
   
> 13:44:28  黎明-金投-项目-杭州  
   
欢迎  
   
> 13:44:32  Seven~乾道~产品~北京  
   
签到  
   
> 13:44:44  杨杰-康城投资-开发-上海  
   
签到  
   
> 13:44:47  朱劲飞-创新支付-SA  
   
签到  
   
> 13:44:54  杜雷-生物认证支付-技术  
   
签到  
   
> 13:44:57  wxid_wtjag9bub6rs22  
   
签到  
   
> 13:44:59  海建-xtransfer-反洗钱合规  
   
签到  
   
> 13:45:04  胡倩颖-渠道-北京  
   
签到  
   
> 13:45:04  王兵-北京梧桐树-技术  
   
签到  
   
> 13:45:05  邓杰-移联-Java-深圳  
   
签到  
   
> 13:45:07  上海-上海中钢银联通-董路-技术  
   
签到  
   
> 13:45:18  中金支付～开发～翔远  
   
签到  
   
> 13:45:21  弋碎-国美-产品  
   
签到  
   
> 13:45:37  姜桥-摩拜单车-技术  
   
签到  
   
> 13:46:12  邹刘名-百联-研发-上海  
   
签到   
   
> 13:46:46  Ying-小米支付-合规-北京  
   
16:00开始，晚会再签到  
   
> 13:47:20  风兮-Java技术-上海  
   
签到  
   
> 13:48:54  孙建志-开发-北京  
   
签到  
   
> 13:49:20  地平线-文思-产品  
   
16:00开始，晚会再签到  
   
> 13:49:34  yifeng-首付通-开发  
   
签到  
   
> 13:49:50  yifeng-首付通-开发  
   
@孙建志-开发-北京 哦吼  
   
> 13:50:12  孙建志-开发-北京  
   
[捂脸]  
   
> 13:52:02  张震南-信雅达-互联网支付-杭州  
   
签到  
   
> 13:52:37  澜柯-快钱-研发  
   
签到  
   
> 13:55:25  雷小光-分润云联合创始人  
   
签到  
   
> 13:59:44  卢章-联逸科技-创始人-北京  
   
签到  
   
> 14:02:35  Cc老曹-英之泰-技术  
   
签到  
   
> 14:12:35  黄福祥-ETC车宝-鼓励师-广州  
   
签到  
   
> 14:12:56  通联支付-产品-符音-深圳  
   
签到  
   
> 14:13:24  周胜-贝络-产品-北京  
   
签到  
   
> 14:15:29  dreamup-平安-产品  
   
签到  
   
> 14:16:00  DON-通联-研发  
   
签到  
   
> 14:16:04  曾卓-长丰集团-架构师-长沙  
   
签到  
   
> 14:16:36  李伟 聚合 开发  
   
签到  
   
> 14:16:46  罗志威－深圳－以太零  
   
签到  
   
> 14:18:36  smartwave-开科支付-成都  
   
签到  
   
> 14:18:39  涂智明-科蓝-开发-北京  
   
签到  
   
> 14:18:40  陈健-HFB-CTO-北京  
   
签到  
   
> 14:20:38  申彬彬-随行付-PM-北京  
   
签到  
   
> 14:20:46  夜月沉星-gtxy-产品-福州  
   
签到  
   
> 14:27:27  csp-架构-深圳  
   
签到  
   
> 14:30:55  XZ-中金-产品  
   
签到  
   
> 14:34:22  杨海华-汇桔网-研发-广州  
   
签到  
   
> 14:39:42  Elin-昊链-产品经理-广州  
   
签到  
   
> 14:39:44  Nancy-京东-产品-北京  
   
签到  
   
> 15:14:18  陈节明-在途-技术  
   
签到  
   
> 15:17:47  李胜勇-永乐-G-北京  
   
签到  
   
> 15:22:52  志明-平安普惠-PM-深圳  
   
签到  
   
> 15:46:39  梁考拉-博时-资金清算-北京  
   
拿好小板凳  
   
> 15:47:27  冷兴孜-渠道支付-研发  
   
签到  
   
> 15:53:17  Eagle-兴业-技术  
   
签到  
   
> 15:59:26    
   
> 15:59:43  上海-上海中钢银联通-董路-技术  
   
四点了  
   
> 15:59:58  李杜-长沙万权集团-技术部经理  
   
签到  
   
> 16:00:22  hgwym-传化支付-技术经理  
   
签到  
   
> 16:00:27  lance-货拉拉-开发  
   
签到  
   
> 16:00:49  夏其燕-交行-系统架构师-上海  
   
大家好 我今天分享一下某国有银行对接网联后 压测结果的架构漫谈  
   
> 16:01:13  梁子龙-维恩贝特-开发  
   
签到  
   
> 16:01:31  夏其燕-交行-系统架构师-上海  
   
根据央行规定，支付结构和银行直接通道将被切断，就是通俗的断直联  
   
> 16:02:17  夏其燕-交行-系统架构师-上海  
   
所有银行将对接网联，举例，支付宝发起到网联，网联到银行，日粗  
   
> 16:02:21  夏其燕-交行-系统架构师-上海  
   
如此  
   
> 16:02:46  夏其燕-交行-系统架构师-上海  
   
测试架构图  
   
> 16:02:48  夏其燕-交行-系统架构师-上海  
   
![2018-09-26 16:02:48](http://static.cocolian.cn/img/20180926_160248.png) 
   
> 16:03:11  夏其燕-交行-系统架构师-上海  
   
这里压力源模拟网联过来的请求  
   
> 16:03:46  郑增远—WIND—攻城狮—上海  
   
签到  
   
> 16:05:24  夏其燕-交行-系统架构师-上海  
   
真实的请求是 请求1到f5,f5到https加速器，返回后到第二层f5，第二层f5到对接epcc应用websphere集群，对接epcc应用再到贷授权处理系统，其中epcc对接系统，和贷授权处理系统各自拥有分布式数据库cbase，cbase是基于淘宝occeanbase开发  
   
> 16:07:19  夏其燕-交行-系统架构师-上海  
   
https加密属于第一层最外面加密，根据网联规范，请求发送的是xml报文，报文带有签名信息，签名信息来自于军工级加密机处理的返回结果，属于硬加密  
   
> 16:08:12  夏其燕-交行-系统架构师-上海  
   
除签名报文，对于关键字段，如账号，金额，或者密码会另外再做加密处理  
   
> 16:09:00  夏其燕-交行-系统架构师-上海  
   
因此，网联送过来的报文实际上已经是加签报文，银行拿到报文时除了https转http还要解签  
   
> 16:10:25  夏其燕-交行-系统架构师-上海  
   
加密机的处理能力非常高，单台加密机外加前置系统对外能提供8000tps的处理能力，支持横向扩展  
   
> 16:11:14  夏其燕-交行-系统架构师-上海  
   
https加速器处理效率也很高，基本上都是几个毫秒的处理，支持几万tps  
   
> 16:11:43  夏其燕-交行-系统架构师-上海  
   
因此大部分消耗都会在网联对接处理系统和贷授权系统  
   
> 16:13:35  夏其燕-交行-系统架构师-上海  
   
网联对接系统简称epcc，对应网络清算支付公司的epcc，使用was集群，只要是银联支付，协议支付，退款，签约，查询，差错提交等常用功能，和通俗意义上的支付系统别无二差，epcc会落地报文  
   
> 16:15:08  夏其燕-交行-系统架构师-上海  
   
贷授权是新一代分布式式核心记账处理系统，传统的主机因为资源mips问题和成本问题逐渐会被开放式架构所替代，作为开发系统，贷授权的核心在于分布式数据库  
   
> 16:17:07  夏其燕-交行-系统架构师-上海  
   
因此通过多轮比较，对比，逐步进行epcc和贷授权的系统进行优化，提升网联支付系统处理能力，从500tps到2000tps，到6500tps，到1万tps  
   
> 16:20:36  夏其燕-交行-系统架构师-上海  
   
优化核心点，1.日志处理从logback单机落盘转为kafka数据集中处理 2.对分布式数据库多表join的sql转为按主键查询避免使用分布式数据库不擅长功能 3.对多个并发锁从应用代码层进行分化处理 以上分别能在原基础上提高30%到50%不等的性能提升  
   
> 16:21:09  夏其燕-交行-系统架构师-上海  
   
这里还涉及到批量清算问题  
   
> 16:22:38  夏其燕-交行-系统架构师-上海  
   
cbase会定时异步将数据同步到关系数据库db2上，在db2上使用传统关系型sql，多表join操作进行清算，钆差操作，避免去出发cbase的弱项  
   
> 16:25:32  夏其燕-交行-系统架构师-上海  
   
当前的架构很多依靠异步批量和纯分布式架构去处理支付请求  
   
> 16:25:50  夏其燕-交行-系统架构师-上海  
   
并未融合进主机资源  
   
> 16:26:05  夏其燕-交行-系统架构师-上海  
   
传统四大行已经在讨论异构的方式  
   
> 16:26:27  夏其燕-交行-系统架构师-上海  
   
所谓异构就是核心系统拥有主机和开放两种核心  
   
> 16:26:38  夏其燕-交行-系统架构师-上海  
   
同时提供对外联机服务  
   
> 16:28:19    
   
> 16:28:44  夏其燕-交行-系统架构师-上海  
   
主机拥有主机的优势，稳定，基本不用过多考虑优化的方案，只要关注账务类业务逻辑，开放横向扩展能力强，但对开发能力要求更高，尤其是作为核心系统  
   
> 16:29:23  夏其燕-交行-系统架构师-上海  
   
如何同时提供对外联机功能，让适合主机的业务到主机，适合开放的业务到开放  
   
> 16:30:51  夏其燕-交行-系统架构师-上海  
   
有一种方案是通过智能路由，内存数据库对比，通过类似账号+version的方式判断进行路由是到主机还是开放  
   
> 16:31:22  夏其燕-交行-系统架构师-上海  
   
这样的话就成了3个核心，内存db+主机+开放3节点  
   
> 16:32:26  夏其燕-交行-系统架构师-上海  
   
当路由到开放后，开放处理完继续发送异步mq消息到主机去同步状态信息，同理对于主机优先处理情况  
   
> 16:32:51  夏其燕-交行-系统架构师-上海  
   
这样一个3节点，对于异常交易，异常通讯需要考虑很多，因为你是核心系统  
   
> 16:33:31  夏其燕-交行-系统架构师-上海  
   
所以你必须还要有智能监控系统 通过智能监控系统去对错帐进行冲正，补偿操作  
   
> 16:34:03  夏其燕-交行-系统架构师-上海  
   
这个架构是有点三角形节点部署，每个顶点支持横向扩张  
   
> 16:34:57  夏其燕-交行-系统架构师-上海  
   
三角形前面可以是微服务或者soa企业级总线  
   
> 16:36:15  夏其燕-交行-系统架构师-上海  
   
以上，是一种思路，不代表最佳方案，还有的方案是作为一前一后的处理，个人觉得两种方案各有利弊  
   
> 16:36:24  夏其燕-交行-系统架构师-上海  
   
我今天的分享就到这里，谢谢大家  
   
> 16:36:40  李小胖-优讯-打杂  
   
[强]  
   
> 16:38:16  蔡章正-mt-结算系统  
   
[强]  
   
> 16:38:51  wxid_wtjag9bub6rs22  
   
[强][强][强]  
   
> 16:39:42  志明-平安普惠-PM-深圳  
   
所谓异构就是核心系统拥有主机和开放两种核心，等于把传统的核心拆成两个？  
   
> 16:40:29  hgwym-传化支付-技术经理  
   
[强]  
   
> 16:41:07  达达-消金-开发  
   
能发个清晰点的图片吗  谢谢  
   
> 16:42:30  吕波-融投世界科技-技术总监-沈阳  
   
请问一下各位大咖，我们网站要开通微信支付，需要申请网文么，需要什么网文？  
   
> 16:49:55  smartwave-开科支付-成都  
   
@夏其燕-交行-系统架构师-上海?谢谢分享  
   
> 16:54:13  海爷爷  
   
@夏其燕-某银行-系统架构师 谢谢分享  
   
> 16:55:20  老熊-头条-技术  
   
@海爷爷?请按群规修改下昵称，??  
   
> 16:55:51  海爷爷  
   
@老熊-头条-技术 好的  
   
> 16:57:33  王子硕-爱农支付-技术  
   
@夏其燕-某银行-系统架构师 谢谢分享  
   
> 16:57:43  盛-中科金服-研发  
   
> 16:59:27  刘耀文-华宝基金-技术开发  
   
@夏其燕-某银行-系统架构师?谢谢  
   
> 16:59:37  刘耀文-华宝基金-技术开发  
   
> 17:15:34  Daniel-快钱-架构  
   
cbase支持跨分片分布式事务？  
   
> 17:16:23  Daniel-快钱-架构  
   
db2在面对海量数据对帐性能怎样？  
   
> 17:16:56  Daniel-快钱-架构  
   
@夏其燕-某银行-系统架构师?  
   
> 17:17:14  邓晓杰～阿里巴巴～java  
   
[强]  
   
> 17:22:26  夏其燕-交行-系统架构师-上海  
   
cb不是直接到落盘处理 他会有merger server对分片数据去做多节点合并操作   
   
> 17:23:10  夏其燕-交行-系统架构师-上海  
   
所以你的事务应该是在单节点内存内内先完成   
   
> 17:23:49    
   
> 17:25:20  夏其燕-交行-系统架构师-上海  
   
db2不会去做海量数据的处理 更多是当日内批次间的处理操作 数据会按批次或会计日迁移走 避免海量数据 去挑战数据库极限  
   
> 17:27:13  Daniel-快钱-架构  
   
没有直接落地磁盘，只保存在内存的话，如何避免crush导致的数据丢失？  
   
> 17:30:02  夏其燕-交行-系统架构师-上海  
   
cb有完整的日志追踪机制 具体要另外展开  
   
> 17:52:30  地平线-文思-产品  
   
大佬们，有作为银行服务商断AT直连接入网联的吗？  
   
> 17:53:31  wood-通联-技术  
   
啥意思？@地平线-文思-产品?  
   
> 17:53:43  wood-通联-技术  
   
啥叫银行服务商  
   
> 17:54:38  地平线-文思-产品  
   
差不多是银行作为收单机构的样子发展商户，再接入AT  
   
> 17:54:48  达达-消金-开发  
   
他的意思是 XX外包公司 给银行改造断直连后与网联对接系统吧  
   
> 17:55:11  地平线-文思-产品  
   
@达达-CYWB-开发 [强]  
   
> 17:58:34  wood-通联-技术  
   
网联只能对接支付机构吧  
   
> 17:58:52  wood-通联-技术  
   
目前肯定没有  
   
> 18:36:27  姜桥-摩拜单车-技术  
   
cbase  
   
> 18:36:45  姜桥-摩拜单车-技术  
   
这是一种开源数据库吗，还是自研的  
   
> 18:36:47  姜桥-摩拜单车-技术  
   
？  
   
> 18:38:08  达达-消金-开发  
   
扩展的ob  
   
> 18:52:30  盛付通—侯哥  
   
![2018-09-26 18:52:30](http://static.cocolian.cn/img/20180926_185230.png) 
   
> 18:53:02  盛付通—侯哥  
   
支付大牛们来看看这个回单有没有问题  
   
> 19:11:09  双乾支付-技术总监-韩伟  
   
假的  
   
> 19:11:18  双乾支付-技术总监-韩伟  
   
凭证号不会是0000000吧  
   
> 19:12:27  阿茂-百联（离职）-研发  
   
开业第一比交易。[呲牙]  
   
> 19:18:16  盛付通—侯哥  
   
关键是农行有“明细回单专用章”么？  
   
> 19:18:59  盛付通—侯哥  
   
没有见过这个类型的回单章子  
   
> 19:19:01  王志华_待业_产品  
   
@盛付通—侯哥?电子签章  
   
> 19:19:22  王志华_待业_产品  
   
与柜面业务章子可以不一样  
   
> 19:19:42  王志华_待业_产品  
   
这个凭证是加过签的  
   
> 19:20:26  盛付通—侯哥  
   
是的，电子签章也没见过这个类型“明细回单专用章”，一般都是“回单专用章”  
   
> 19:21:24  盛付通—侯哥  
   
![2018-09-26 19:21:24](http://static.cocolian.cn/img/20180926_192124.png) 
   
> 19:21:37  王志华_待业_产品  
   
@盛付通—侯哥?名字可以随便定义，包括形状  
   
> 19:21:40  盛付通—侯哥  
   
比如这个样子的章[偷笑]  
   
> 19:21:50  王志华_待业_产品  
   
不影响  
   
> 19:22:36  盛付通—侯哥  
   
每个银行对电子签章应该统一标准吧[偷笑]  
   
> 19:24:09  双乾支付-技术总监-韩伟  
   
凭证号是需要查询的  
   
> 19:24:17  双乾支付-技术总监-韩伟  
   
第一个序列也是00000001  
   
> 19:24:21  双乾支付-技术总监-韩伟  
   
不会都是0  
   
> 19:25:29  盛付通—侯哥  
   
他那张有个日志号  
   
> 19:26:24  盛付通—侯哥  
   
我对那章子持怀疑态度  
   
> 19:27:58  盛付通—侯哥  
   
农行总行肯定对所有电子签章有统一标准，不可能每个分行随意搞个电子签章。  
   
> 19:34:48  王志华_待业_产品  
   
同意你的观点，电子章不需要报备的。  
   
