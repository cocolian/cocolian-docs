---
layout:     source 
title:      "2017-12-30-WeChat"
date:       2017-12-30 12:00:00
author:     西纳
lines:      102 
tag:       [chat]
---
> 00:04:52  林鹏云  
   
[央行特急248号文，支付机构备付金交存比例最高至54%！](http://mp.weixin.qq.com/s?__biz=MzIwOTUyNzc0OQ==&amp;amp;amp;mid=2247484432&amp;amp;amp;idx=1&amp;amp;amp;sn=cc658d9a61d7951988310f63a0593103&amp;amp;amp;chksm=977332baa004bbac5fedfa3874d6bb2e71a294ffeb87225ae7266bb82c1641ac9ee5ddb5456c&amp;amp;amp;mpshare=1&amp;amp;amp;scene=1&amp;amp;amp;srcid=1230SnW6l2US5wHaoLSZXh3S#rd)  
   
> 00:06:23  槑旭旭 ?微信超級會員  
   
[[动画表情]](&lt;tr style='mso-height-source:userset;height:25.00pt'&gt;&lt;td class=xl24  style='border-bottom:.5pt solid black;border-top:none;' x:str&gt;9761939087@chatroom)  
   
> 00:06:27  槑旭旭 ?微信超級會員  
   
[[动画表情]](&lt;tr style='mso-height-source:userset;height:25.00pt'&gt;&lt;td class=xl24  style='border-bottom:.5pt solid black;border-top:none;' x:str&gt;9761939087@chatroom)  
   
> 00:14:47  王向东-卡联科技-PM  
   
@聚合支付_程昱?辛苦  
   
> 00:16:31  槑旭旭 ?微信超級會員  
   
[抱拳]没有，顺带学习整理下来  
   
> 09:20:22  Jos  
   
@聚合支付_程昱?厉害??  
   
> 12:08:49  Tom Gui  
   
[强]  
   
> 12:25:39  Tom Gui  
   
@胥刚-华夏银行-项目经理-北京?商户各大厂商收银机在集成卡和扫码业务时是无缝对接还是收银机SI也要开发？收银机集成方案怎样的？  
   
> 13:07:28  胥刚  
   
收银机和智能pos不一样，得自己按照联机接口开发  
   
> 18:31:19  程琳-杉德支付-PM  
   
今天请到一位朋友，@王新-笑脸金融-架构-北京 给大家做分享，主题是“分享支付系统曾经遇到的坑和解决方案”开始时间为【18:35】；欢迎欢迎[鼓掌][鼓掌][鼓掌]！（注： 1.嘉宾分享期间其他人不要发言打断嘉宾分享。2.分享完成后请大家积极补充和提问；3.烦请领取红包签到，谢谢！  
   
> 18:31:55  程琳-杉德支付-PM  
   
[微信红包](https://wxapp.tenpay.com/mmpayhb/wxhb_personalreceive?showwxpaytitle=1&amp;amp;msgtype=1&amp;amp;channelid=1&amp;amp;sendid=1000039501201712307022783927043&amp;amp;ver=6&amp;amp;sign=e4822a646f770959b1bda808db210465cd516bdbb6b976edc69eb619db22b83039fbdc45459dba9c497c40cc18f8cd026e77f23bede444f2c5bcefed6c1e4c5ce9ad8200533b4668b391711842aa57ce)  
   
> 18:32:16  MyCity  
   
签到  
   
> 18:32:17  sea  
   
[玫瑰][玫瑰][玫瑰]  
   
> 18:34:28  梁庆忠  
   
签到  
   
> 18:35:01  只是个昵称  
   
签到  
   
> 18:35:58  只是个昵称  
   
感谢利用假期休息时间来分享的大神们  
   
> 18:36:34  程琳-杉德支付-PM  
   
停止签到，加班中的王总，准备开始了[玫瑰][玫瑰][玫瑰][强][强][强]  
   
> 18:37:02  西纳  
   
大家好：今天主要给大家分享一下支付方面遇到过的问题，谢谢！  
   
> 18:37:24  西纳  
   
先介绍一下支付平台项目背景：  支付平台主要服务于公司各业务线的支付需求，支付平台主要对接有支付牌照的30多接支付公司， 主要涉及到：快捷支付以及单笔代扣包装的快捷支付，单笔和批量代扣，单笔和批量代付，以及网银，鉴权之类。  ------------各业务----------------------------- 1. 业务系统（很多不同的业务线系统）   -----------支付系统--------------------------------------- 2. 支付前置系统（运行tomcat容器）  3. 支付核心，分了很多服务： 如交易检查，路由，通道，查询，通知.........(没有个服务是一个独立的jar运行)  4. 内部系统2与3，以及3与3之间的服务通信是通过mq来完成,外部系统与支付系统是通过http调用  
   
> 18:38:45  西纳  
   
请大家先看看这个背景下的支付系统  
   
> 18:40:22  西纳  
   
有疑问吗？没有疑问就正式开始了哈  
   
> 18:41:56  西纳  
   
遇到的问题主要这4个方面遇到的问题： 一.流程混乱和沟通问题导致事故 二. 初期经验不足导致事故 三. 依赖服务和外部原因 四. 监控系统功能不全和报警及时  
   
> 18:42:42  西纳  
   
1. 开发人员编写的sql语句让DBA执行，DBA没有经过严格的审核sql的执行目的和正确性，拿着sql语句直接执行导致事故     遇到二种：1. 从oracle中导出数据让dba执行sql插入数据到生产库，导出sql是先删除表在创建表插入数据，本来目的是新增数据结果把以前的数据删除了       2. 修改订单是sql写的不正确，没有经过严格审核导致事故 2. 运维人员没有经过开发同学的确认，自己私下练习调灰度环境，导致生产的mq消息被抢走，引发交易事故 3. 实操人员和用户确认好的异常交易需要手工修改单，转手运营人员给单号让开发人员修改订单状态，运营人员把单号复制错误，技术人员没有审核直接修改导致修改订单错误。 4. 新来的测试人员，还不熟悉流程，接到任务压力测试批量代付功能，没有沟通的清楚的情况下随便挑了测试数据信息，批量压测导致真实交易发生导致交易事故（金额巨大）  
   
> 18:43:41  西纳  
   
以上4点事初期流程比较混乱导致的 一.流程混乱和沟通问题导致事故  
   
> 18:47:43  西纳  
   
二. 初期经验不足导致事故  1. 开发同事在新接入三方支付渠道时，由于经验不足忽视了设置超时时间的重要性，导致这个三方队列所在的交易全部堵塞，同时影响到其他三方支付渠道的交易(队列未拆分)。  2. 系统是分布式部署使用同一个库，并且支持灰度发布，环境和部署模块非常多而且复杂。某次增加了一个新模块，由于存在多个环境，且每个环境都是双节点，新模块上线后导致数据库的连接数不够用，从而影响其他模块功能。  3. 同样是超时问题，一个三方的超时，导致耗尽了当前所配置的所有worker threads，以至于其他交易没有可处理的线程。  4. 数据库序列问题，oracle数据库建立的不是循环序列，当序列使用完后无法创建序列导致交易事故  5. 参数校验问题，必传的参数服务端没有做好校验（默认为业务一定会传），业务线接口问题没有传必要参数，使用mybatis导致数据库全表扫描，更严重的是开发人员还把查询结果打印一个tojson的log导致内存溢出  6. 并发数没有控制好，三方支付渠道的并发限制没有控制，导致交易大时出现大量的交易失败，部分三方支付渠道是对商户的并发有要求的。三方支付渠道给开放几个并发是根据实际交易量来评估的，所以如果不控制并发，大量的交易都发给三方支付渠道，那么三方支付渠道只会回复“请降低提交频率”之类的信息。  7. mq队列拆分不够细，如多个三方渠道共用一个队列，其中一个三方渠道发生异常，会影响其他三方渠道  8. 前置网关使用hibernate，由于开发人员对hibernate的自动更新把控不好导致交易状态异常（影响比较大）  
   
> 18:50:17  西纳  
   
有疑问吗？可能都放假了  
   
> 18:51:03  heping  
   
说吧.在车上看  
   
> 18:52:45  西纳  
   
@段和平-光汇云油-产品-深圳 [握手]  
   
> 18:53:04  西纳  
   
三. 依赖服务和外部原因  1.	短信平台单点的问题： 由于有鉴权和快捷支付(以及包装的快捷支付)，由于大部分的交易快捷是自己平台发短信，当短信平台出问题时，所有依赖短信的交易全部瘫痪 2.	Mq服务单点的问题，遇到某天mq服务器坏掉了所以交易瘫痪 3.	接入渠道单一，当某渠道维护和不出问题整个业务无法进行 4.      支付公司维护和不稳定时解决方案  
   
> 18:53:32  西纳  
   
四.	监控系统功能不全和报警及时 1.	三方渠道不稳定不能及时发现 2.	XX渠道的失败率过高不能及时发现调整 3.	系统内部错误不能及时发现，如，批量代扣由于其中一笔交易数据问题，影响整个批次的发送处于中间状态，需要立即报警发现  
   
> 18:55:26  西纳  
   
已上的问题的确看上去比较简单，但是的确出现过问题，希望对大家有用  
   
> 18:57:33  梁庆忠  
   
能否介绍一下后来的解决方案呢？  
   
> 18:58:04  西纳  
   
当时的解决方案大致：1. 规范流程增加多人审核尤其是代付交易和sql   
   
> 18:59:14  西纳  
   
2.  每个业务线接入的通道不能单一必须二个以上，当一个出现问题或不稳定，路由调整到稳定通道上  
   
> 19:00:22  梁庆忠  
   
调整是人工还是系统自动呢？  
   
> 19:01:06  西纳  
   
自动调整  
   
> 19:02:14  sea  
   
架构复杂。流程复杂。数据没有直接落地  
   
> 19:02:19  西纳  
   
3.  队列尽可以拆分细不同通道一个队列，交易和查询队列分开，不然一个通道有问题导致其他通道不能用  
   
> 19:03:26  西纳  
   
@张海-澳觅-架构师-澳门  数据前置系统通过后接落地的  
   
> 19:03:55  西纳  
   
每个服务之间通过状态来控制  
   
> 19:04:34  sea  
   
什么叫查询队列？  
   
> 19:05:18  sea  
   
这个好奇怪  
   
> 19:07:28  西纳  
   
@张海-澳觅-架构师-澳门 如批量交易，需要做查询，我们会把查询的批次号从查询服务发到通道模块去拼数据发送三方查询，二个服务之间的通信队列就叫查询队列可能名字叫的不是很好  
   
> 19:08:41  sea  
   
异步确认吗？  
   
> 19:08:57  西纳  
   
查询服务只是定时回去查询服务条件数据的批次，发送到通道模块去拼数据发送三方查回结果  
   
> 19:09:02  西纳  
   
异步的  
   
> 19:09:28  西纳  
   
主动查询  
   
> 19:09:43  sea  
   
恩恩  
   
> 19:11:09  西纳  
   
4. 交易监控这块尽量实时性比较要  
   
> 19:11:14  西纳  
   
高  
   
> 19:12:56  sea  
   
批量代扣失败怎么不把出错的。代扣数据存放到另一张表。  
   
> 19:13:09  sea  
   
然后继续执行后面的  
   
> 19:13:26  sea  
   
并发出告警  
   
> 19:13:33  sea  
   
毕竟人工干预没那么即时  
   
> 19:14:15  西纳  
   
继续执行我们有，是根据是否客户原因重发的  
   
> 19:14:44  西纳  
   
如果是客户原因失败重新发送还是会失败  
   
> 19:14:48  sea  
   
不是哈。我是说挑出来。让主流程继续跑。  
   
> 19:15:07  sea  
   
有异常的。等人工确认  
   
> 19:15:59  西纳  
   
我们是只要不是客户原因就立即发送的，还没有你这种方案  
   
> 19:17:02  sea  
   
恩恩。一起探讨哈  
   
> 19:17:47  西纳  
   
哈哈，你这种方案比较清晰点  
   
> 19:18:49  sea  
   
你现在有分库分表不  
   
> 19:19:21  sea  
   
现在是复试记账吗？  
   
> 19:19:41  西纳  
   
目前没有，我们是吧2个月的数据迁移到历史表中去  
   
> 19:20:03  sea  
   
恩恩。现在是记单边帐吗？  
   
> 19:20:16  西纳  
   
真实库就2个月的数据，单边记账  
   
> 19:21:11  西纳  
   
想搞复试记账，还不会等哪天想听听这方面的大佬分享  
   
> 19:22:44  sea  
   
所以现在代码一旦出错就容易出单边帐问题  
   
> 19:23:27  西纳  
   
是的，最近在开始搞对账方面的事  
   
> 19:25:53  付云龙  
   
@王新-笑脸金融-架构-北京?针对第三方支付交易关闭后如何退款的？  
   
> 19:26:51  西纳  
   
@付云-农业-ERP&amp;amp;电商-成都  我没有明白第三方支付交易关闭是指什么  
   
> 19:27:52  付云龙  
   
例如支付宝三个月后为交易关闭不能退款，业务上有押金  
   
> 19:28:34  付云龙  
   
这里指原路退回  
   
> 19:29:35  西纳  
   
我们不是电商没有遇到这种需要哈哈  
   
> 19:31:24  西纳  
   
我们的交易一般当天基本上全回来终态，极少第二天回来终态  
   
> 19:32:00  付云龙  
   
嗯嗯  
   
> 19:32:19  西纳  
   
如果有重复支付这种可以调用三方原路退回接口  
   
> 19:32:43  西纳  
   
5. &amp;#160;&amp;#160; 系统业务监控点 出警类： 网络异常预警； 单笔订单超时未完成预警； 实时交易成功率预警； 异常状态预警； 未回盘预警； 失败通知预警； 异常失败预警； 响应码频发预警； 核对不一致预警； 特殊状态预警；  关注类： 交易量异常预警； 交易额超过xxxW预警； 短信回填超时预警； 非法IP预警；业务监控点都是在日常运行过程中根据自身业务一点一滴总结出来的，分为出警类和关注类两大块  
   
> 19:32:57  西纳  
   
我们的业务监控点大致这些  
   
> 19:34:06  西纳  
   
今天分享大致这些，谢谢大家  
   
> 19:36:16  勤奋(sir)  
   
好细致 ??  
   
> 19:36:52  Chaos  
   
[强]  
   
> 19:38:17  A-XiaoWei  
   
辛苦[抱拳]  
   
> 19:38:35  卫书有道  
   
[强]  
   
> 19:38:40  云  
   
[强]  
   
> 19:38:41  付云龙  
   
监控这块大概是如如何设计的呢？mq异步的么  
   
> 19:40:09  西纳  
   
@付云-农业-ERP&amp;amp;电商-成都?redis埋点  
   
> 19:41:02  西纳  
   
稍等一会还在路上  
   
> 19:48:14  coco  
   
补签  
   
> 19:49:01  巴德妈妈小Gabby  
   
@付云-农业-ERP&amp;amp;电商-成都?第三方支付关闭不能原路退还的，我们走转账  
   
> 19:57:21  付云龙  
   
@周雅雯-途虎养车-支付PM-上海?嗯这只能这么冲了  
   
> 19:57:47  西纳  
   
@付云-农业-ERP&amp;amp;电商-成都?监控这块我们主要是通过redis埋点收集数据，实时统计分析，以及一些订单交易状态统计同直接查库  
   
> 19:58:20  西纳  
   
不不同维度来保证问题及时暴露出来  
   
> 19:59:13  付云龙  
   
嗯，统计分析这块用的什么数据库呢  
   
> 20:01:58  西纳  
   
目前用的MySQL  
   
> 20:06:10  付云龙  
   
@王新-笑脸金融-架构-北京?恩嗯，分享一下用了哪些开源技术栈呢？  
   
> 20:29:10  西纳  
   
@付云-农业-ERP&amp;amp;电商-成都?没有什么特别的，我们现在都是spring cloud体系这套东西  
   
> 20:39:44  七夜  
   
这套体系比较好  
   
> 20:40:52  东方  
   
能吃透就没问题   
   
> 21:27:52  程琳-杉德支付-PM  
   
感谢王总的精彩分享??[玫瑰][强][强][强]  
   
> 21:28:19  happycoral  
   
[强][强]  
   
> 21:31:49  付云龙  
   
感谢分享  
   
> 21:32:21  槑旭旭 ?微信超級會員  
   
感谢分享  
   
> 22:17:08  我  
   
感谢分享  
   
> 22:26:51  丁爱民-JAVA开发工程师-圣亚云鼎支  
   
感谢分享，很细致[抱拳]  
   
> 22:35:56  巴德妈妈小Gabby  
   
假日还分享，非常感谢  
   
