---
layout:     source 
title:      "2017-12-28-WeChat"
date:       2017-12-28 12:00:00
author:     于高禾-一亩田 PL
lines:      251 
tag:       [chat]
---
> 00:26:56  于江宁-银联电子PM  
   
![2017-12-28 00:26:56](http://static.cocolian.cn/img/201712/20171228_002656.png) 
   
> 00:27:47  于江宁-银联电子PM  
   
被扫不能直接支付，还要展示订单信息展示页面？  
   
> 08:03:13  小路。  
   
[一图读懂中国人民银行条码支付业务规范](https://www.ithome.com/html/it/340727.htm)  
   
> 08:28:07  王松-易宝支付-产品经理-北京  
   
@时文-国电-产品-北京?是必填不验项，有的通道会有这种要求  
   
> 08:29:54  一生尤文  
   
@王松-易宝支付-产品经理-北京?是指银行卡要素吗？  
   
> 08:30:41  王松-易宝支付-产品经理-北京  
   
是的  
   
> 08:31:27  一生尤文  
   
[抱拳]受教了，多谢解答  
   
> 08:40:56  王松-易宝支付-产品经理-北京  
   
@渤海银行—福州分行—蔡少杏?银联通道 意思是？  
   
> 09:03:08  邹芳  
   
![2017-12-28 09:03:08](http://static.cocolian.cn/img/201712/20171228_090308.png) 
   
> 09:03:24  邹芳  
   
242号发文的全文，谁有啊？  
   
> 09:32:15  蔡少杏  
   
@王松-易宝支付-产品经理-北京?你们代扣通道[奸笑]  
   
> 11:46:26  季康  
   
【请教】支付公司为什么不支持使用护照开户？  
   
> 11:47:58  张耀贤  
   
歹噶吼，哪位大佬有最全的卡bin表，或者最好使的卡bin查询工具，麻烦告知一下哈。（百度上找到的几个不太好使）  
   
> 11:49:18  季康  
   
@张耀贤-现在支付-产品-北京 http://www.posp.cn/cardbin.jsp 我经常用这个 感觉还不错  
   
> 11:49:38  上协  
   
母鸡啊  
   
> 11:50:17  张耀贤  
   
@季康-小泰科技-产品-杭州 蟹蟹啦  
   
> 11:51:36  管静????  
   
@季康-小泰科技-产品-杭州?没有说不允许啊  
   
> 11:52:15  季康  
   
@管静_传化支付_风控合规 没说不允许 但是实际上都不支持 这才是痛苦的地方 我问过连连、宝付 都只支持身份证  
   
> 11:52:46  管静????  
   
那就是不支持了  
   
> 11:53:30  季康  
   
所以 我想知道的是 为什么他们不支持护照 理论上来说 境外客户在银行可以使用护照开户 那么银行是有客户的护照号码的 可以实现验证的  
   
> 11:54:22  上协  
   
可能护照验证 不方便吧 没有身份证验证接口那么开放  
   
> 11:54:30  管静????  
   
据我了解  银行的像护照这类证件是直接手工登记的   并不能做验证  
   
> 11:54:46  coco  
   
不是每个人都有护照吧  
   
> 11:54:49  管静????  
   
目前只有身份证可以做联网核查  
   
> 11:55:13  管静????  
   
护照主要针对外国公民  
   
> 11:56:21  季康  
   
嗯 因为护照没法做联网核查 所以无法对外提供校验服务？  
   
> 11:56:49  季康  
   
我们现在有一些境外客户想开户投资 但是存管行说支持不了[捂脸]  
   
> 11:57:43  只是个昵称  
   
护照一般需要人工审核，做不到线上实时这样子  
   
> 11:58:29  上协  
   
但是好多支付接口 却写着可以支持护照 等其他证件  
   
> 11:58:46  只是个昵称  
   
写是那样写  
   
> 11:59:15  只是个昵称  
   
大家都预留着，哪天信息联网了就可以用了  
   
> 11:59:23  上协  
   
不过 也可以实现  
   
> 11:59:45  上协  
   
比如用户注册时 或支付时 针对此类用户 可以异步进行 受理-审核-之父  
   
> 11:59:48  上协  
   
支付  
   
> 11:59:58  只是个昵称  
   
嗯，是的  
   
> 12:00:07  上协  
   
增加个审核过程 让此类用户去等待 估计1-2工作日  
   
> 12:01:01  只是个昵称  
   
主要是国内的基本都是针对身份证，有多少人需要用到护照呢？  
   
> 12:01:21  上协  
   
身份证谁都有 就可以了 足矣  
   
> 12:02:09  只是个昵称  
   
要是有几千万的客群的话马就会推出，只有极小的一部分客户的话，大家都懒得去做  
   
> 12:04:40  管静????  
   
身份证是中国公民的唯一有效证件。  
   
> 12:05:03  管静????  
   
一般人拿着护照不能开户的  
   
> 12:05:36  舒俊～产品  
   
护照貌似银行能开户，不过这个很难联网查  
   
> 12:06:26  上协  
   
联网查如果可以 又会养活一批人 护照验证接口服务  
   
> 12:07:02  管静????  
   
我们之前的护照开户业务 走的特事特办流程。人工审核  开户  
   
> 12:07:37  只是个昵称  
   
自份证，护照，港澳通行证这些都可以去银行开户的啊  
   
> 12:07:41  上协  
   
人工审核 去哪查真实性啊？@管静_传化支付_风控合规  
   
> 12:08:55  舒俊～产品  
   
我记得通道貌似可以提供查询，只是基于银行开户时记录的信息  
   
> 12:13:22  上协  
   
算了 还是别开通护照类型了 现在个人隐私已经很糟糕了 。。。。 到时候护照也被盗用了. .....  
   
> 12:16:02  季康  
   
哈哈 主要是相比身份证查询 护照查询的需求太少 支付公司都懒得做  
   
> 12:16:14  季康  
   
而且成本又高 估计银行也不一定愿意提供查询接口  
   
> 12:17:29  上协  
   
1-需求？现在互联网市场 哪是需求主导啊 应该是企业主导用户需求。 2-成本？ 直连银行成本高，接第三方啊。  
   
> 12:18:02  上协  
   
可以做 就看谁先来搞这个噱头了  
   
> 12:28:24  只是个昵称  
   
还不是要看市场需求  
   
> 12:30:22  上协  
   
你没发现中国创业的特点  
   
> 12:30:46  舒俊～产品  
   
中国不是操概念吗，一个PPT拿钱  
   
> 12:33:49  只是个昵称  
   
我的意思是现在客群如果只有几万人，整总人群的十万分之一。这么低的比例没太多动力和后期潜在市场  
   
> 12:34:34  上协  
   
我在想..熊哥要不要创业呢...哈哈哈哈  
   
> 15:29:24  Hurrison 肖  
   
我想搞个 支付、交易的前置系统， 大牛们 有没有这方面 设计的的经验 包括业务、技术[抱拳][抱拳]  
   
> 15:33:36  林鹏云  
   
前置？  
   
> 15:35:34  舒俊～产品  
   
电商啊，杠杠的  
   
> 15:37:11  heping  
   
支付交易的前置   
   
> 15:37:12  heping  
   
啥意思  
   
> 15:37:21  胥刚  
   
啥支付，线上支付还是线下支付，有卡支付还是无卡支付  
   
> 15:56:30  Hurrison 肖  
   
其实是为了简化 现有 交易系统、支付系统 让系统只关注核心功能。 比方说支付系统 就做两步： 落支付订单  调银行网关并处理结果。 把 一些 加解密啊，风控教验，限额限次 商户止入止出等功能移出去  
   
> 15:59:50  balance  
   
@肖若团-商盟商务-技术-杭州?私聊，我们在弄。  
   
> 16:01:49  付云龙  
   
架构上来说，分久必合，合久必分。对业务梳理合理分层即可  
   
> 16:02:08  舒俊～产品  
   
这种其实就是产品分层吧，风控，合规，校验，并发等前置了  
   
> 16:02:25  舒俊～产品  
   
路由应该也在前面  
   
> 16:02:31  付云龙  
   
就拿现在微服务来说，成本也是很大的  
   
> 16:04:22  付云龙  
   
大系统小做类unix思想，前提是团队资源允许，否则心有余而力不足  
   
> 16:17:36  Hurrison 肖  
   
确实 很头疼， 这一块要做好， 业务层面上 就要区分仔细， 给每种类型交易打标， 接下来的 支付、账务会计、清结算 才能做好  
   
> 16:19:24  李宝  
   
@肖若团-商盟商务-技术-杭州 你可以用老熊他们做的开源支付系统  
   
> 16:21:26  Hurrison 肖  
   
@李宝-智慧生活(北京)-支付架构?之前听我同事说过 这套系统， 这套系统 已经搞出来了嘛？   
   
> 16:21:46  李宝  
   
我也不太清楚呢  
   
> 16:25:24  Hurrison 肖  
   
我咨询下我同事， 他们 在另外一个群里， 不知道他们参与了没  
   
> 16:25:57  林鹏云  
   
[跳一跳](https://mp.weixin.qq.com/mp/waerrpage?appid=wx7c8d593b2c3a7703&amp;amp;amp;type=upgrade&amp;amp;amp;upgradetype=3#wechat_redirect)  
   
> 16:58:05  幸福时光  
   
和我们这边的系统差不多，可以加下微信啊@肖若团-商盟商务-技术-杭州?  
   
> 16:59:18  韩涛-快捷通渠道经理  
   
@小马-海尔消金-支付-青岛 组织，我在这里  
   
> 17:02:50  幸福时光  
   
[握手][握手]  
   
> 18:31:00  勤奋(sir)  
   
兄弟姐妹们，根据281号文，就想问下，银联还能跟支付公司的备付金做结算工作不？  
   
> 18:34:02  李宝  
   
银联从来不结算，只负责清算  
   
> 18:40:10  羽琪  
   
然后各个银行自己负责头寸调拨，银联发清算指令  
   
> 18:41:26  舒俊～产品  
   
银联应该是负责银行之间的清结算吧，不负责第三方吧，我记得  
   
> 18:42:22  Chaos  
   
马上要年终决算了，有得忙了。  
   
> 18:42:58  羽琪  
   
银联叫跨行转接清算  
   
> 18:43:16  舒俊～产品  
   
嗯  
   
> 18:43:57  勤奋(sir)  
   
更正下，兄弟姐妹们，根据281号文，就想问下，银联还能跟支付公司的备付金做清算工作不？  
   
> 18:44:58  bane  
   
不能  
   
> 19:15:39  程琳-杉德支付-PM  
   
今天请到一位朋友，@Codefor-一亩田-TechLead-BJ 给大家做分享，主题是“一次支付系统升级过程经验教训分享”开始时间为【19:30】；欢迎欢迎[鼓掌][鼓掌][鼓掌]！（注： 1.嘉宾分享期间其他人不要发言打断嘉宾分享。2.分享完成后请大家积极补充和提问；3.烦请领取红包签到，谢谢！  
   
> 19:15:57  程琳-杉德支付-PM  
   
[微信红包](https://wxapp.tenpay.com/mmpayhb/wxhb_personalreceive?showwxpaytitle=1&amp;amp;msgtype=1&amp;amp;channelid=1&amp;amp;sendid=1000039401201712287023892518262&amp;amp;ver=6&amp;amp;sign=472da1bc8f81a988ed45436e8c0cd3af5dd35fddcf0ae1f78be4b809dae3c154417437ac8d261354693c63d0a48eb27ec66c9f77969b165cee09b690bd0991c644440143ccf5a702b339be788db41b91)  
   
> 19:15:58  邹芳  
   
有盒子科技的同行吗？  
   
> 19:16:33  Summer 梁夏  
   
[鼓掌]   
   
> 19:16:47  只是个昵称  
   
签到  
   
> 19:19:28  Jos  
   
签到  
   
> 19:19:35  王振兴  
   
签到  
   
> 19:19:41  林鹏云  
   
签到  
   
> 19:19:53  ???? 心  
   
签到  
   
> 19:20:06  Chaos  
   
签到  
   
> 19:23:17  舒俊～产品  
   
签到  
   
> 19:23:25  凌锋  
   
签到  
   
> 19:23:45  黄灿  
   
签到  
   
> 19:23:49  ly  
   
签到  
   
> 19:24:00  黑皮老阿姨  
   
签到  
   
> 19:24:19  coco  
   
签到  
   
> 19:27:05  陈宏  
   
签到  
   
> 19:27:26  松松  
   
签到  
   
> 19:27:52  fashioncat  
   
签到  
   
> 19:27:58  蔡少杏  
   
签到  
   
> 19:28:08  w  
   
签到  
   
> 19:28:12  郝维甲  
   
签到  
   
> 19:28:13  陈秋彬??  
   
签到  
   
> 19:28:23  范双  
   
签到  
   
> 19:28:32  Ralf  
   
签到  
   
> 19:28:42  于高禾-一亩田 PL  
   
hello，大家好！我今天讲的不是什么高深的技术或者产品设计，只是前一段时间发生的真实的上线过程。大家就权当我讲一个故事。里面涉及的技术也比较简单，请大家可以不吝赐教~  
   
> 19:28:55  吕彦鹏  
   
签到  
   
> 19:29:05  于高禾-一亩田 PL  
   
因为等会还有个会，我现在就开始了哈  
   
> 19:29:35  于高禾-一亩田 PL  
   
先简单介绍下升级背景： 公司要上线支付系统V3.0，主要增加复式账系统。 新老版本不兼容。即一笔支付交易必须完整走老系统记账或者走新系统记账。  
   
> 19:29:43  于高禾-一亩田 PL  
   
数据库的主要影响是在已有的核心表（3kw）增加若干字段。数据库全部使用MySQL InnoDB引擎。  
   
> 19:30:10  于高禾-一亩田 PL  
   
整个上线的过程非常惨，折腾了一晚上。  
   
> 19:30:26  于高禾-一亩田 PL  
   
升级过程： 凌晨2点到7点，5个小时的上线过程中，经历了无法完全屏蔽流量、数据库导入主键冲突、上线步骤遗漏、隔离的UAT环境和配置更新复杂、MySQL5.5和5.6不兼容等问题。  
   
> 19:30:34  于高禾-一亩田 PL  
   
下面按时间发生顺序介绍整个上线过程。  
   
> 19:31:19  于高禾-一亩田 PL  
   
D-2日 （为了方便叙述，我们假定D日为正式上线日，D-2日是指上线前两天）  
   
> 19:31:34  于高禾-一亩田 PL  
   
RD、QA决定上线，RD开始评审上线CheckList，我们称为CheckList A。 大家一致认为直接在核心表增加字段风险较大，因为表非常大，而且生产机器数据库磁盘不是SSD。  
   
> 19:32:37  于高禾-一亩田 PL  
   
实测，按我们生产环境的机器配置，一个3kw的表，加一个字段，大概需要20分钟，这次上线涉及4个这个量级的表，这个时间显然不能接受。  
   
> 19:33:33  于高禾-一亩田 PL  
   
即使是pt-online-schema-change也非常难用，已经有过教训。不停服升级无法完成kw级大表的schema变更。  pt的问题在于，数据库访问比较频繁，抢锁比较严重，pt抢不到锁反而会加重负担，完全做不到schema-change-free  
   
> 19:34:02  于高禾-一亩田 PL  
   
讨论后的建议方案是： 重新部署一套数据库（磁盘使用SSD），在新数据库上线建好更改后的schema，然后暂停线上流量，将全库数据用mysqldump出来，再load到新数据库中。 暂停线上流量再导出数据库，是为了保证数据一致性。（目前我们没有读写分离，而且保留只读功能意义不大） 在新库上建好更改后的schema再导入，这样性能瓶颈就是数据库的写入INSERT。而不是数据库的ALTER。实测在kw级MySQL表上效率更高。  
   
> 19:35:34  于高禾-一亩田 PL  
   
解决了数据库加字段的问题，后面就是业务验证的问题。  目前公司还没有完善的UAT环境（User Acceptance Test，可以理解是完全和生产环境一致的环境，即连正式的数据，正式的API，但是不对外发布，一般是内部业务验证的最后一步）  
   
> 19:36:47  于高禾-一亩田 PL  
   
由于涉及到记账，这次上线比较重要。 对于业务功能验证，希望完全暂停线上流量后，部署一个隔离的UAT环境，使用真实数据，供QA进行线上验证。  也就是说，我们要针对这次上线手工打造一个UAT环境。（环境的配置是个大坑，也是后面无数问题的缩影）  
   
> 19:36:58  于高禾-一亩田 PL  
   
D-1日  
   
> 19:37:46  于高禾-一亩田 PL  
   
按既定方案，SYS和RD进行了完整的预演，主要是数据库操作。 由于涉及模块多，上线步骤复杂，SYS对RD的上线CheckList从方便操作的角度进行了优化，生成了CheckList B。  注意，这里区别于前面的CheckList A，是SYS又搞了一个上线CheckList  
   
> 19:39:37  于高禾-一亩田 PL  
   
数据库建议方案从实践上看是没问题的，但是由于数据库过大，实际耗时需要1个小时左右。  4个3kw左右的表，一共加二十多个字段，1小时搞定。  
   
> 19:39:59  于高禾-一亩田 PL  
   
QA利用预演环境（区别于UAT环境的点只在于不是真实数据）进行了业务功能验证，无误。  晚上9点开始，给用户推送支付功能升级的大字报。D日凌晨2点到5点停服维护。  
   
> 19:40:21  于高禾-一亩田 PL  
   
D日 凌晨，某会议室，RD负责人，QA负责人，SYS。  
   
> 19:40:59  于高禾-一亩田 PL  
   
0点~1点半。SYS牵头 进行了第二遍预演。过程遇到了数据库导入主键冲突问题，但是重试后解决。当时并没有定位原因，只是感觉很奇怪  
   
> 19:41:23  于高禾-一亩田 PL  
   
凌晨2点，SYS开始按操作步骤摘流量，屏蔽生产环境流量。但是发现按步骤都操作完了，数据库仍然有新的连接进来，即使强制杀了数据库连接，还有新的。完全不符合预期。（后来发现是一些年久失修的离线作业）  
   
> 19:41:48  于高禾-一亩田 PL  
   
为确保数据一致性，祭出大杀器：FLUSH TABLES WITH READ LOCK 见到数据库连接写阻塞的就kill 读链接无所谓  
   
> 19:42:02  于高禾-一亩田 PL  
   
新的数据库已经准备好，新的schema也更新好了。现在开始做数据库导入，执行了半个小时，挂了。导入主键冲突！可是怎么可能会有主键冲突呢？  
   
> 19:42:56  于高禾-一亩田 PL  
   
真是墨菲法则啊。第二遍预演遇到的问题，到正式执行的时候又碰到了！！刚刚从线上库导出来的数据，不应该有主键冲突的啊  
   
> 19:43:23  于高禾-一亩田 PL  
   
这是整个上线的第一步，当头一棒，就挂了  
   
> 19:43:36  于高禾-一亩田 PL  
   
排查了一遍，怀疑是预演过程中，有QA的程序一直在跑自动化Case导致的。断掉QA的连接，重新执行数据库导入，导入成功。  
   
> 19:43:43  于高禾-一亩田 PL  
   
等数据库执行完，已经是4点了。  
   
> 19:44:16  于高禾-一亩田 PL  
   
第一步导库，我们就比预期多花了一个小时。  
   
> 19:44:24  于高禾-一亩田 PL  
   
SYS配置了UAT的APP接入域名，QA开始打APP包进行验证。 包打好了，但是安装后直接crash，无法打开。  
   
> 19:45:04  于高禾-一亩田 PL  
   
这次倒不是大问题，经排查，是因为QA配置Jenkins任务时参数填写错误导致。重新打包后，APP打开正常。  但是发现每一步都不顺的时候，真正的不顺可能才刚刚开始。  
   
> 19:45:51  于高禾-一亩田 PL  
   
这种通宵上线，其实大家是有压力的，发现每一步都不顺时，每个人心里都开始有一些变化，但是当时又不好沟通。  
   
> 19:46:02  于高禾-一亩田 PL  
   
APP ready了，后台服务上完线了，开始进行业务功能验证。此时是凌晨4点半。  
   
> 19:46:11  于高禾-一亩田 PL  
   
尽管在预演过程中，业务验证非常顺利，但是在生产过程中，业务验证非常不顺利。基本上每个场景都走不通。  
   
> 19:46:40  于高禾-一亩田 PL  
   
QA做了冒烟测试，每个场景都不通。但是在预演环境时，都没有问题啊  
   
> 19:46:46  于高禾-一亩田 PL  
   
那么这只有一种解释，环境配置有问题。  
   
> 19:47:39  于高禾-一亩田 PL  
   
RD负责人开始逐个排查问题，由于涉及到网关、业务入口、支付核心、账务等各个模块，即使有LogTrace辅助进行日志排查，仍然非常耗时。 LogTrace是我们自研的一个系统，可以根据一个logid串联起这个请求贯穿所有模块的上下文。  
   
> 19:48:05  于高禾-一亩田 PL  
   
到5点半时，通了一些场景，又卡到一个关键的场景，业务验证不通过。  
   
> 19:50:45  于高禾-一亩田 PL  
   
QA负责人从风险的角度开始打断RD，想要回滚。这时RD负责人压力非常大，觉得验证不顺利和代码没有关系，都是环境配置问题，涉及模块配置太多，很快就能解决。  这个项目组付出的太多了，连续一个多月的加班，每周单休，期间项目组成员还感冒，牙痛。RD负责人知道项目回滚意味着什么，所以想坚持不回滚。  但是QA Leader不依。  
   
> 19:52:30  于高禾-一亩田 PL  
   
连续三次打断后，RD负责人不得不停下来交（chao）涉（jia），“到早上7点，有任何责任我背”。（后来了解到QA负责人已经通过别的途径把情况上报给了领导，这是别的话题，撇开不表）  
   
> 19:52:47  于高禾-一亩田 PL  
   
这个过程中，牵涉最多的其实是环境和配置。  
   
> 19:53:11  于高禾-一亩田 PL  
   
我们有外网的接入网关，内部又有ESB网关，各个模块的调用非常复杂。  
   
> 19:54:08  于高禾-一亩田 PL  
   
诸如：由于CheckListA 和CheckListB不等价，有一些上线步骤被遗留；UAT环境如何管理，新部署的MySQL5.6 mysql.ini和MySQL5.5不一致导致代码不兼容。  每一个点，都是一个大坑。都不是什么技术难点，但是会阻碍场景测试。  
   
> 19:56:01  于高禾-一亩田 PL  
   
为什么在验收的时候没问题呢？一到线上就有问题呢？  因为我们想手工造一个UAT环境出来，又要考虑到回滚方案（一旦决定回滚，如何快速的将所有的配置还原）里面涉及大量手工改配置的地方。  本来配置都有配置服务器管理的，因为我们要手工改这些配置，就会造成生产服务器和配置服务器不一致，要人工在黑板上记住都改动了哪些  
   
> 19:57:05  于高禾-一亩田 PL  
   
![2017-12-28 19:57:05](http://static.cocolian.cn/img/201712/20171228_195705.png) 
   
> 19:57:22  于高禾-一亩田 PL  
   
这是第二块黑板了。。。  
   
> 19:57:30  于高禾-一亩田 PL  
   
6点半的时候主流程都已经没有问题了。 7点正式对外切流量。  
   
> 19:57:36  于高禾-一亩田 PL  
   
后续： 公司对这个项目Review了三遍，从各个角度，项目的角度，开发测试过程，上线过程等。  
   
> 19:57:49  于高禾-一亩田 PL  
   
结论：  
   
> 19:59:03  于高禾-一亩田 PL  
   
1、凌晨上线未必是好的选择。 虽然凌晨是业务流量低峰，但也是人大脑活动的低峰，难以保持兴奋。  像中间漏配置；真实进行UAT验证时，接入网关配置没有打开，这种低级别错误就很难解释。特么这么简单怎么可能忘啊  
   
> 19:59:15  于高禾-一亩田 PL  
   
2、做好充分的停服预告。 整个上线过程，太过仓促，停服时间超过预期，也没有充分评估用户影响。 停服并不说明方案的设计不好，停服并不是什么丢脸的事情。  
   
> 20:00:21  于高禾-一亩田 PL  
   
RD 一开始的上线方案评审想不停服，觉得停服好像非常shame。  但其实不是，保证账务不出乱子，用户能正常完成业务功能才是最重要的。停服没什么大不了的。  
   
> 20:00:36  于高禾-一亩田 PL  
   
3、做好止损红线。 各方提前沟通明确方案和时间点，什么时候冲，什么时候停。 将在外君命有所不受。事先没有约定的约束，在方案执行中不能提，只会增加扯皮的谈资，没有意义。（会上可以随意发表意见，一旦会议打成一致意见，会议纪要一发，就不要再提意见了）  
   
> 20:01:38  于高禾-一亩田 PL  
   
虽然最后项目惊险上线成功了，但是风险还是比较大的。如果7点还解决不了，回滚不但是项目组感情上接受不了的事情，会影响到公司正常业务，才是更大的问题  
   
> 20:02:39  于高禾-一亩田 PL  
   
好了，我这边主要内容就这些，大家拍砖吧。  
   
> 20:07:36  只是个昵称  
   
这么重要的上线没有事先预演一次呀  
   
> 20:08:00  w  
   
没用的  毕竟环境不一样  
   
> 20:08:09  只是个昵称  
   
在第二次出问题时就应该中止了  
   
> 20:08:41  w  
   
而且UAT环境还都是现搭建起来的  
   
> 20:09:03  Chaos  
   
一般都会有同样的模拟环境呀  
   
> 20:09:06  陈伟  
   
新老数据是否可以双写  
   
> 20:09:56  于高禾-一亩田 PL  
   
双写的问题，不要做一致性校验啊，考虑过双写的方案  
   
> 20:11:40  于高禾-一亩田 PL  
   
有预演过，预演的问题在于，预演环境的配置和真实生产环境不一致  
   
> 20:11:42  w  
   
这样的方案有没有考虑过  存量数据迁移到新库  增量数据在一段时间内同步到老库  
   
> 20:12:24  w  
   
待验证没有问题后据情况下掉老库  
   
> 20:12:59  w  
   
避免双写  否则一旦出问题都不知道那个数据是正确的了  
   
> 20:13:37  w  
   
双写方案一般DB也是不建议做的  
   
> 20:14:33  于高禾-一亩田 PL  
   
增加数据同步到老库上，这个一般怎么做？因为新老流程的记账模式都不一样  
   
> 20:15:27  w  
   
我们这边有几个方案  不过一半都是DB支持  
   
> 20:15:36  于高禾-一亩田 PL  
   
主要感觉这次上线时，最大的点在于，新老版本流程不兼容。  又要保证数据强一致，很难有兼容的方案  
   
> 20:15:57  w  
   
比如通过binLOG将增量数据同步到新库  
   
> 20:16:39  w  
   
当然这里边是有一套基于binLOG的数据同步机制的  
   
> 20:17:05  w  
   
?? 生产端和消费端  
   
> 20:17:48  w  
   
生产端就是新库  消费端就是老库  不需要应用处理  
   
> 20:18:00  于高禾-一亩田 PL  
   
这个和主从同步有什么区别？  解析binlog？  
   
> 20:18:01  w  
   
DB层直接搞定  
   
> 20:18:15  w  
   
是的  
   
> 20:18:34  w  
   
刚才你说不是基于MYSQL的对吧  
   
> 20:18:48  于高禾-一亩田 PL  
   
新老库的schema可能不一样啊，你们这个工具也支持？  
   
> 20:19:07  于高禾-一亩田 PL  
   
我们业务库都是MySQL的  
   
> 20:19:28  w  
   
所以刚才我说这是完整的数据同步方案  
   
> 20:20:20  于高禾-一亩田 PL  
   
嗯  
   
> 20:20:34  w  
   
除了相同结构的是可以做到定制化的支持的  
   
> 20:20:50  w  
   
我们叫定制化  这个工具都可以  
   
> 20:21:00  于高禾-一亩田 PL  
   
??  
   
> 20:21:07  w  
   
就看DB的支持成度了  
   
> 20:22:32  于高禾-一亩田 PL  
   
小创业公司就是这样的，没有完整的工具链，各种环境也都比较粗暴  
   
> 20:22:44  w  
   
如果没有现成的数据同步产品  DB写脚本通过MQ发出去在通过脚本消费也是可以的  
   
> 20:23:24  w  
   
这是最简单的可以RUN的方案  
   
> 20:23:54  w  
   
理解  
   
> 20:23:56  于高禾-一亩田 PL  
   
不敢这么搞啊。都是账户余额，错一点就瞎了，上百万个账户呢  
   
> 20:25:43  w  
   
没事的风险再大  该执行还得做  ?? 可靠完整的执行方案就行  
   
> 20:26:12  w  
   
@Codefor-一亩田-TechLead-BJ?你们不也执行完了吗  
   
> 20:28:35  于高禾-一亩田 PL  
   
但是你刚才说写脚本处理，我觉得不够严谨，不敢那么搞。脚本的控制力太差  现在上面执行的方案，虽然遇到不少问题，还是比较严谨的，从理论上，不会错账  
   
> 20:29:23  w  
   
对  我只是说可以run起来的极简方案  细节还有很多  
   
> 20:29:53  w  
   
可靠行  稳定性  性能等等  
   
> 20:30:31  于高禾-一亩田 PL  
   
嗯。现在上了一个多月，复式账跑起来，业务效果还不错[呲牙]  就是运维的环境需要做的事情还很多  
   
> 20:30:44  w  
   
[强]  
   
> 20:43:25  sea  
   
写代码用队列同步啊  
   
> 20:43:58  sea  
   
然后找个时间再对账一下新老系统  
   
> 20:44:13  sea  
   
没问题就可以切换了啊  
   
> 20:44:29  sea  
   
@Codefor-一亩田-TechLead-BJ?  
   
> 20:44:33  西纳  
   
@Codefor-一亩田-TechLead-BJ?那天有时间能分享一下你们的复式记账设计吗？好想学学  
   
> 20:45:08  sea  
   
我之前切换新的订单系统就是这么做  
   
> 20:49:42  desperado  
   
复式记账 是会计系统吧？  
   
> 20:53:34  desperado  
   
异步记的复式账？  
   
> 20:54:28  付云龙  
   
只要没生产制造，电商财务都还好  
   
> 20:55:05  于高禾-一亩田 PL  
   
是会计系统。目前为了架构简单，量也不算大，直接同步记账的  
   
> 20:59:26  于高禾-一亩田 PL  
   
我们记复式账主要就是防止错账，做账户平衡的。因为之前只有单式账，出现过系统bug，导致账户不平，不容易发现。有了复式账，试算平衡很容易发现问题。  
   
> 21:00:10  desperado  
   
我理解 账务系统跟会计系统应该是分开的  不知道你们是咋的做的  
   
> 21:00:51  sea  
   
讲讲你们怎么做复式记账呢  
   
> 21:00:55  sea  
   
可否说说呢  
   
> 21:04:25  于高禾-一亩田 PL  
   
对每一笔资金变动，在一个事务内，先对相关所有账户改余额，记单式账，然后记一笔关联的复式账。每笔账都有对应的记账凭证  
   
> 21:05:01  sea  
   
问下。贵公司有分库分表吗？  
   
> 21:05:05  于高禾-一亩田 PL  
   
资金的变动是由业务来驱动的  
   
> 21:06:43  于高禾-一亩田 PL  
   
可以理解为没有，我们会定期切出来一个表，但是在线服务只会用最新的表  
   
> 21:07:18  sea  
   
那就是一个库。复式对账，主要就是用来检测bug了  
   
> 21:09:17  于高禾-一亩田 PL  
   
一部分吧，按科目分开方便做余额表。不过目前没有对接erp  
   
> 21:13:20  付云龙  
   
erp用的什么  
   
> 21:14:07  付云龙  
   
前几年oracle打得很火  
   
> 21:16:59  于高禾-一亩田 PL  
   
还是用友  
   
> 21:18:37  于高禾-一亩田 PL  
   
oracle实施了一半烂尾了[憨笑]  
   
> 21:19:41  付云龙  
   
嗯搞烂了，之前实施了几年oracle erp，都痛苦  
   
> 21:21:14  付云龙  
   
我们现在搞农业，更痛苦[撇嘴]  
   
> 21:21:50  付云龙  
   
一群外行人跳到坑里来了  
   
> 21:21:53  于高禾-一亩田 PL  
   
我们也是农业啊，一亩田[憨笑]  
   
> 21:22:50  付云龙  
   
[握手]  
   
> 21:23:16  sea  
   
原来是一亩田  
   
> 21:23:17  sea  
   
哈哈  
   
> 21:23:26  sea  
   
我记得我以前爬过你们的数据。哈哈  
   
> 21:23:31  付云龙  
   
你们现在是b2b么  
   
> 21:23:33  sea  
   
农业相关的  
   
> 21:24:42  于高禾-一亩田 PL  
   
小b  
   
> 21:25:18  乔俊翔-爱又米-支付开发  
   
@Codefor-一亩田-TechLead-BJ?关联的复式帐是待清算账户吗？[抱拳]  
   
> 21:25:23  于高禾-一亩田 PL  
   
爬我们数据干嘛，又拿不到啥数据@张海-澳觅-架构师-澳门?  
   
> 21:25:51  sea  
   
以前一个公司搞的  
   
> 21:25:54  sea  
   
我也忘记了  
   
> 21:25:59  sea  
   
反正最后没啥用  
   
> 21:31:42  于高禾-一亩田 PL  
   
账户设计是按业务需求来的，有渠道清算户，还有其他很多账户@乔俊翔-AYM-支付开发?  
   
> 21:32:30  于高禾-一亩田 PL  
   
我们的外网接入网关也是我牵头设计的[呲牙]  
   
> 21:33:52  付云龙  
   
@Codefor-一亩田-TechLead-BJ?你们盈利模式是？分销么  
   
> 21:34:37  付云龙  
   
@Codefor-一亩田-TechLead-BJ?自己建线下基地没  
   
> 22:13:33  M.cc  
   
@Codefor-一亩田-TechLead-BJ?哈哈，你们接过我们随行付代付吧，我记得和你做过联调  
   
> 22:32:38  于高禾-一亩田 PL  
   
这……好嘛，那估计最近还得麻烦你，代付渠道又有需求要改造[呲牙]  
   
