# 主题分享
云闪付广义来说是一个品牌，旗下像最早的手机闪付pay产品、到后来衍生的二维码与云闪付app，包含多个产品条线。这次主要介绍一下传统手机pay产品的相关内容，考虑到整体性与直观性，分享以图片形式为主，文字介绍为辅。
## 1、云闪付pay产品的定位
![20180608_163452](http://static.cocolian.org/img/20180608_163452.png)  
通俗地理解就是 把银行卡放进手机里使用，要点是 手机设备必须支持nfc 功能。
## 2、云闪付pay产品四（三）形态、三特征
![20180608_163604](http://static.cocolian.org/img/20180608_163604.png)  
- 四形态根据安全加密模块（se模块）的形态来区分，包含基于运营商sim卡的（已经被淘汰），手机厂商主导的（applepay、华为pay、小米pay、三星pay等，目前最主流），可穿戴设备（苹果手表、拉卡拉手环、swatch手表等）以及手机软件虚拟的（HCE，非手机厂商但仍想推出闪付pay的，如银行app钱包）。 目前基本只有三形态了。
![20180608_163641](http://static.cocolian.org/img/20180608_163641.png)  
- 三特征，空中发卡指的是实体银行卡如何绑定在手机上，非接支付与在线支付分别就是线下和线上支付的方式，到银行发卡端的话，云闪付pay产品金融交易与实体银行卡金融交易并无差别，个别保留域会区分来源渠道。
## 3、介绍一下空中发卡以及token标记化的相关概念
![20180608_163714](http://static.cocolian.org/img/20180608_163714.png)
简单理解，用户有三台手机，苹果、华为、小米，他拿自己的工资卡去这三台手机里的wallet钱包分别绑定applepay、华为pay和小米pay。 后台就会产生三个不同的token号，也就是虚拟卡号，用来标识同张实体银行卡在不同设备上绑定的虚拟设备卡。
- token映射约束条件  
一张实体银行卡SPAN（具有借记/贷记功能）在一个设备上只能加载一个设备卡MPAN,在不同设备上可以分别加载一张设备卡。  
一个设备上对应多张SPAN可有多张设备卡MPAN,但有且仅可设定一张默认卡。  
设备卡MPAN可以包含以下信息： 一个借记/贷记账户；一个UPCash账户（可选） 
SPAN的借记/贷记账户与实体银行卡关联同一个后台账户，并使用相同的交易密码。

- Token卡的生命周期管理交易  
设备卡的生命周期（主动）  
（1）加载  
（2）挂失与解挂（通过银行或手机厂商渠道  ）
（3）注销   
设备卡的生命周期（被动）  
（1）银行主动发起对设备卡的暂停、恢复、更新、注销等操作  
（2）实体银行卡的挂失与解挂、更新、注销  
（3）移动设备的丢失、找回、抹除内容、完整恢复   
（4）用户账号操作：从设备上注销、移除登录密码或指纹   
目前是支持手机渠道与行内渠道的管理
- Token卡的金融支付交易
![20180608_163842](http://static.cocolian.org/img/20180608_163842.png)
银联侧会对收单上送的token号做映射转换，上送银行卡系统时已是转换后的实体银行卡号，除了个别保留域会有区分来源渠道，与实体卡的金融交易没有大差别。
## 4、闪付pay产品的两种使用方式
### （1） 线下近场非接的pos支付方式
![20180608_163934](http://static.cocolian.org/img/20180608_163934.png)  
线下免密由收单侧与发卡系统共同控制。
### （2）线上app远程支付方式
![20180608_164005](http://static.cocolian.org/img/20180608_164005.png)
目前applepay线上免密的金额限制，是发卡行自行控制，银联负责透传给苹果公司 下发到终端，终端在输入金额时做判别控制是否弹出密码框。
## 5、整体的一个交易系统架构简图
![20180608_164101](http://static.cocolian.org/img/20180608_164101.png)

由于现在云闪付这块涵盖的内容较以往更多，且更新拓展的速度很快，云闪付产品全体系介绍可见：
https://wenku.baidu.com/view/09f1532e53d380eb6294dd88d0d233d4b14e3f86.html

开放平台内容可见：
https://portal.unionpay.com/portal/login.jsp
这里有目前云闪付品牌下各产品的入网资料，包括详细的需求、改造文档，以及具体的入网流程指导

# Q&A
Q1: 请问，如果通过线上APP云闪付支付，未下载云闪付是如果跳转逻辑？通过云闪付支付支付信息的借贷记是否可以返回支付机构？   
A1：目前各类手机pay都是厂商系统自带的wallet应用，不需要单独下载。

Q2：如果是第三方钱包接入云闪付支付那？  
A2：如果是银行app单独做的hce模式的（只针对安卓用户），需要在系统设置里设置支付默认使用的云卡类型（银行hce or 华为pay这种），还有就是线上网关支付那种，那个是银行提供sdk控件 调用即可。

Q3：但是线上网关支付那种，是不回传借贷记的。  
A3：目前第三方要接入，使用的还是类似hce的模式，或者是那种类似京东白条闪付，也有找银行和银联当地分公司借壳的。

Q4：请问京东App 里面的京东闪付，是HCE 的模式吗？   
A4：京东App 里开通闪付，和小米Pay 开通的方式不一样。
京东直接将快捷支付绑定的银行卡默认开通闪付可以支付了，好像这点和标准的银联闪付是不一样的，不清楚这是什么模式.  
A41：京东的模式比较特殊，不是hce.

Q5：能介绍一下京东闪付的这种模式吗？  
A5：hce只针对安卓类手机，而且是针对没有实体se模块，用的是软件加密的方式，加密信息，临时密钥是保存在app内存里的，这个可能有点敏感，那种模式已经被喊停了。

Q6：这个token感觉像 离线生成二维码的玩法 是么？  
A6： token支付标记化比二维码复杂很多哦，虚拟卡都是有对应的个人化数据的，跟实体卡其实没有大差别。所以说pay产品安全性很高。虚拟token卡写到手机se模块里的数据，跟实体银行卡芯片里的数据是一样的。

Q7：问下，美团闪付卡，好像可以添加多张银行卡，那这个闪付卡是一个mpan吗？还是另外的概念啊。  
A7：一个设备上可以绑多张实体卡，一张实体卡在一个设备上对应一个mpan ，也就是设备卡。

Q8：哦，那就一个设备的mpan可以对应多个span是吧  
A8：设备是根据设备id区分的，同个设备是能对应多个mpan

Q9：写到手机se模块 需要嵌入式开发了吧 ?  
A9：据说是以脚本的形式下发到手机上，具体不懂啦。有se模块的，个人化数据下发都是银联给手机厂商，手机厂商下发到用户手机上。hce的话是软加密，银联有sdk，银联直接发到手机。  
A91：恩 软加密不需要手机厂商。Se 估计要和厂商合作。