# 一 清算系统对账处理思路
今天主要跟大家一起交流的是第三方支付的清算系统对账处理这块，广义上来说清算是经济行为引起的货币资金关系应收应付的计算，原来我们团队做的一些清算系统的事情，主要包含所有业务数据与实际资金流水是否相符，含总总核对、总分核对，最终形成各种对账结果，为后续的结算报表、财务报表、备付金报表等提供数据基础。

大体的思路是这样的：
![20180210_163621](http://wechat.lixf.cn/img/20180210_163621.png)

通道对账后进行业务对账再进行资金对账，形成报表后供结算、备付金等系统使用。
# 二 对账流程介绍
【业务流程】通过拉取数据到清算数据中心进行清分核对：
![20180210_163814](http://wechat.lixf.cn/img/20180210_163814.png)

各类对账后一般都会有相应成功、丢单、掉单、时间性差异等情况，根据每种不同的情况分别进行处理。
处理方式，有些是系统能够自动处理的系统自动处理，需要人工介入的，由清结算人员进行核对后处理。

![20180210_164053](http://wechat.lixf.cn/img/20180210_164053.png)

【通道方面对账】如果掉单，可以通过补单或退款方式处理，丢单发现概率很小，需要与银行核对。
业务对账，如果丢单，要么进行追款处理，如果无法追回款项，就会进行坏账处理

不管何种类型的对账、调整，操作后都会进行相应的会计记账，类似：

![20180210_164420](http://wechat.lixf.cn/img/20180210_164420.png)

每个公司的会计科目会稍有不同，这个比较正常。

为了提高系统记账效率，一般都会采取汇总记账方式
资金对账方面，由于不同外部金融机构清算资金的差异性，大致分为以下几类：
整批合计清算、部分合计清算、逐笔清算。

每个支付公司对于不同子系统间的对账叫法可能会有些差异，这里的业务对账不是外部商户的业务概念。

# 三 Q&A
Q：请问清算系统具体都有哪些职责?

A：目前清算系统主要是对账，清分机输出各类报表给结算、备付金系统等等使用。


---
Q：汇总记账，在汇总过程中丢了日志，是怎么解决这问题的？

A1：汇总过程中，有数据对比，也有监控机制，如果有问题，是可以重跑的。

A2：汇总中，原始产生多少条数据，输出多少条数据，应该有谱 吧，感觉内部总量对比一下就可以，知道丢没丢。


---
Q： 怎么判断哪块有问题，这里监控的话，只是知道汇总丢一部分日志。如何快速找出补回这块，不会重复记账？

A1：从技术上讲，要做到可靠，可以做到每一步的跟踪，类似于责任链，每一步生产了多少数据，每条数据最终的输出，原则上是等价。如果每一步都能可靠的记录一下，在异常的时候，及时报警。或者把异常记录汇总出来，这个是可以做到判断那块出问题的。

A2：针对可靠性的问题，需要做每次账务对账每步的跟踪，及时报警，找出相应的错误记录进行重跑。

---
Q：咨询一下，你们的对账有三种：通道对账，业务对账，资金对账，这三种对账各是什么数据跟什么数据对比？ 通道对账我理解是渠道的对账文件和公司支付网关的流水对比，不知道对不对，还有其他两个呢？

A：通道对账是指：通道与通道银行的对账
业务对账是指：第三方支付流水与通道的对账
资金对账是指：上述对账结果与资金文件的对账

Q：不好意思，有点没明白，【业务对账是指：通道与通道银行的对账】，这个通道与通道银行各只的是什么数据

A：第三方支付一般都有通道模块，有相应的流水，通道直接对接的银行、银联或者其他机构，会提供相应的对账文件。

Q：通道指的是支付公司通道模块提供的对账文件，另一方通道银行指的是？
A：通道银行指

![20180210_171640](http://wechat.lixf.cn/img/20180210_171640.png)

Q：这个是指你们在支付平台开的商户绑定的提现银行账户的账单文件？

A：这里的都是第三方支付里面的对账逻辑哦，没有包含外部商户的对账，比如说人人车对接了支付宝，人人车的交易记录与支付宝对账单对账，这个是不在里面的（虽然一般也叫业务对账）。

Q：不好意思，这里的渠道对账是指你们支付平台 和 对接的银行或其他支付公司的平台（支付宝 财付通）的对账是吧？

A：简单来说可以这么理解。

Q：那对账的数据一面是银行或对接的支付平台发过来的对账文件，另一面是？

A：通道模块的流水。

Q：这个通道是指你们平台的通道模块是吧？

A：是的。



