# 主题分享
今天会就XX渠道发起的签约、银行渠道发起的签约，以及整个签约关系核对的过程做一个分享，详细内容如下：

## 一、移动渠道签约
### 1、 业务场景：
用户直接登录网上营业厅，主动选择办理银行签约。

### 2、 流程说明

1. 用户登录移动网上营业厅，输入用户号码，选择办理银行签约，网站展示签约协议，用户勾选同意后进行下一步办理操作；
2. 移动网站调用省CRM进行用户号码签约校验；
3. CRM做签约关系判断
   1. CRM判断该用户是否符合签约条件（主副号签约、预签约关系、状态正常、非签约黑名单用户允许办理），否则拒绝办理；托收用户由省公司自己确定限定条件；
   2. CRM将签约关系检查结果返回网厅，网厅根据返回结果做签约或不允许签约处理；

4. 用户通过网厅做签约处理
   1. 用户选择签约银行，网厅携带签约用户号码将界面跳转到统一支付web系统，统一支付web系统再跳转银行签约系统；
   2. 用户通过银行签约界面录入签约银行卡号等相关信息；
5. 银行系统签约关系处理
   1. 银行系统对输入的银行账户信息进行校验（此部分是否仅支持开通网银或快捷支付的用户以银行业务规则为准），信息校验失败，通知移动网厅终止签约，流程终止；
   2. 银行系统生成正式签约关系；
   3. 银行系统将签约关系通知发送统一支付系统；
   4. 银行系统将签约关系通知网厅（当用户签约建设银行账号时，建行将签约关系通知统一支付web系统，统一支付web系统再通知到网厅），网厅提示用户签约成功；
6. 统一支付系统对签约关系进行处理
   1. 统一支付系统检查是否已经有签约关系，若有则进入人工错误处理流程，若没有，则统一支付系统生成正式签约关系；
   2. 统一支付系统将签约关系生成通知返回银行；
   3. 统一支付系统将签约关系通知号码归属省CRM；
7. 号码归属省CRM进行签约处理
   1. 省CRM收到统一支付系统签约成功信息后，生成签约信息；
   2. 省CRM将签约关系同步结果返回统一支付系统；
   3. 省CRM用户发送签约信息成功的短信通知；  
省CRM将签约信息同步到省BOSS。

## 二、银行渠道签约
### 1、 业务场景
用户可以通过银行渠道（银行网点，网上银行，银行自助终端）将手机号码和银行账户（信用卡，借记卡）进行签约绑定，签约绑定的前提是手机号码状态正常且未办理签约（包括省公司签约业务），银行账户状态正常。

### 2、 流程说明

1. 银行侧做签约检查，包括验证证件（身份证）是否本人，银行账号是否正常状态，是否已有签约，检查不通过则不能办理签约；
2. 银行侧签约检查通过后，携带签约请求信息（签约主号码等信息），向统一支付系统发起签约请求；
3. 统一支付系统收到银行侧签约请求后，向主号码归属地省CRM发起签约校验请求。
4. 省CRM收到统一支付系统签约请求后，分以下情况处理：
   1. 查询本地该主号码是否存在签约关系，如果存在签约关系（正式状态/临时状态），则返回用户已经签约的相关信息；
   2. 如果不存在该主号码的签约关系信息，省CRM查询该号码的状态与签约互斥业务信息，如果号码处于非“正常”状态或者存在签约互斥业务，则返回签约失败信息（包括失败原因）；
   3. 如果主号码处于未签约状态，且可以签约时，省CRM设置签约响应信息：
      1. 设置用户类型（预付费/后付费）；
      2. 如果主号码是预付费用户，则需要设置充值阀值与充值额度；
      3. 如果主号码是后付费用户，省公司根据各省情况确定是否可以开通自动缴费；
      4. 省CRM返回签约响应信息给统一支付系统，统一支付系统收到省CRM签约响应信息后做如下处理：
         - 如果省CRM校验失败，统一支付系统将签约失败信息返回给银行侧；
         - 如果省CRM校验成功，统一支付系统生成签约信息并通知银行；
      5. 统一支付系统返回签约响应信息给银行侧；
      6. 银行侧收到统一支付系统的签约响应后做正式签约处理：
         - 如果移动侧签约失败，则银行侧返回用户签约失败，并告知失败原因；
         - 如果移动侧签约成功，则银行侧生成正式签约关系，并告知用户签约成功；
      7. 银行侧正式签约成功后，向统一支付系统发送签约结果通知（通知移动侧签约成功），携带签约信息（预付费用户确认后的充值阀值、充值额度、是否开通自动缴费）；
      8. 统一支付系统收到银行侧签约结果通知后，先检查是否已经有签约关系，若有则进入人工错误处理流程，若没有，则生成正式签约关系，并向银行侧返回结果信息；
      9. 统一支付系统正式签约成功后，向省CRM发送签约结果通知请求，携带签约信息；
      10. 省CRM收到统一支付系统的签约结果通知后，生成正式签约关系，并向统一支付系统返回结果信息，同时更新签约关系信息（充值阀值、充值额度、是否开通自动缴费）；
      11. 省CRM向省BOSS同步签约关系数据；  
省CRM向主号码用户下发签约成功短信，并告知解约办理方式，流程结束；

## 三、签约核对
### 1、 业务场景
- 银行系统、统一支付系统和省CRM均保存签约关系数据，运营商与银行各渠道办理的签约数据通过文件接口进行同步核对；
- 省CRM把所有签约以及签约变更交易数据放在一个文件中，上传给统一支付系统；省CRM根据统一支付系统下发的差错处理文件调整本地数据。
- 签约交易核对原则：统一支付系统以银行数据为准更新本地数据，省CRM以统一支付系统与银行对平后的交易数据为准更新本地数据；

### 2、 流程说明
1. 统一支付系统提取日增量/月全量签约交易数据；
2. 统一支付系统核对银行侧与本地交易数据，根据签约交易差异处理原则更新本地数据；
3. 省CRM向统一支付系统发送日增量/月全量签约交易数据；
4. 统一支付系统在与银行对平的数据基础上核对省签约交易数据，根据签约交易差异处理原则生成省签约交易差错处理文件；
5. 统一支付系统向省CRM发送签约交易差错处理文件；
6. 省CRM根据交易差错处理文件更新本地签约关系数据；
7. 省CRM向省BOSS同步签约关系数据；
8. 省BOSS更新签约关系数据；
9. 省BOSS返回数据更新结果给省CRM；
10. 省CRM向用户下发签约完成通知短信，流程结束。


# Q&A
**Q:** 现在的4G和5G是不是全国使用的是一套系统？最开始的2G是每个省份有各自的系统？  
**A:** 移动因为历史原因最开始是每个省各有一套系统，现在在持续集中化，今年已经完成了IT组织架构的整体，后续会大力推进系统集中化，比如支付中心，以前各省都是独立的去跟银行接，但是未来都是通过统一支付系统去对接，现在第三方支付已经先收过来了。  
**Q:** 这个统一支付系统是总公司的产品?  
**A:** 对的  
**Q:** 请问你们走的是和包支付还是直连银行？  
**A:** 直连银行  
**Q:** 现在政策不允许直连了吧？银监都下文要求银行拉闸断直连了。  
**A1:** 原系统都是直连，集团跟银行总部直接谈了之后对接的，我们现状也在对接和包去连作为另外的通道，和包找的银联。  
**A2:** 商户直接没毛病，又不是和包连接银行，移动公司作为商户直连银行又没事。  
**A3:** 和包确实不能直连了 移动跟和包不是一个机构。  

# 补充
1. 断直连解读：
![image](http://static.cocolian.cn/img/20181206_193347.png)   
![image](http://static.cocolian.cn/img/20181206_193422.png)