# 主题分享
大家好，下面我进行分享，今天的主题是“保险资金及凭证对账”；

## 1、收付及记账流程
1. 保险公司的收付款常见的场景有：保险业务（新契约、保全、理赔、续期等），费用业务（员工报销、对外费用结算等），保险公司的收付费业务一般并发量不会很大，但是金额可能会比较大。 
2. 收付费业务的发起端，我们可以统称为是业务系统。 
3. 一笔资金收付的数据处理流程如下：
   - 第一步，资金支付接收交易请求，先进行有效性校验，通过后，进行支付分流并保存数据到数据库。 
   - 第二步，请求支付网关进行资金收付。 
   - 第三步，返回收付结果给业务系统。 
   - 第四步，调用会计引擎，生成财务明细。 
   - 第五步，会计引擎，生成汇总凭证，过账到总账系统（每天一次）。

## 2、对账系统逻辑架构

## 3、对账链路 
### 3.1 对账链路 
   - 对账包含两部分，一部分是资金对账、一部分是凭证对账。
   - 资金对账核对对象：保险公司的企业银行账户账单、支付机构的账单、资金支付系统内的明细数据。
   - 凭证对账核对对象：资金支付的明细数据、会计引擎的财务明细数据、总账系统的凭证。

### 3.2 资金对账流程
   - 第一步，资金流水与机构账单对账，一般有唯一的ID可以关联匹配。 
   - 第二步，与机构账单平账的部分，再和企业账单对账，如果和机构账未平，则不与企业账单对账。 

### 3.3 资金对账模式
保险公司会接入多家支付机构，如通联、银联、支付宝等等。 不同的机构，入账到企业账户账单的方式可能会不同，大体分为如下几种： 
   - a）明细入账，每一笔交易流水在银行账单都有体现。 
   - b）按批次汇总入账，每个交易批次包含多笔资金流水，按批次汇总入账单一笔。 
   - c）按日汇总入账，一天内全部交易汇总一笔入账到银行账单。 

### 3.4 凭证对账
- 核对对象是资金支付流水、会计引擎、总账系统。
- 这部分的核对关系比较明确，一般是根据主键进行金额、科目等关键字段的核对。
- 一个对账的复杂点在于，可能存在记错账的情况，记错账的时候，会由运维等发起冲销的操作，就会造成一个业务数据产生3个凭证的情况。
- 例如：一笔交易 +100元，金额计算错误，需要修改为120元。 原记录：A：+100元 冲销记录：B：-100元 冲销记录：C：+120元 这样的场景，如果冲销时间不在同一天，记账日期也不在同一天的话，那么ABC明细会产生3个凭证。
- 在对账时，需要将ABC三个凭证放在一起进行对账才能平账。
- 最后，每一个平账的对账结果，会显示出，一个SAP凭证会对应一笔或多笔资金流水，每一笔资金流水也会对应到一笔或多笔SAP凭证，以满足外审的查验。

## Q&A
**Q:** 资金对账，是通过资金单单进行核对吗？  
**A:** 资金对账核对三方：资金系统的交易流水，支付机构的对账单，资金出入账账户的银行对账单文件；  

**Q:** 资金的流水从交易来的吗？资金的在途、已达你们都是怎么来处理的？  
**A:** 对账的数据抽取只核对已达账。每次对账抽取的是对账日及之前的未平账，所以未平的交易会每日滚动对账，直至对平，否则每天都会核对；未达账不在对账阶段发现，会在资金支付系统设置一些预警，比如超过2个小时未达的交易进行预警，人为联系机构确认等。  
**Q:** 已达是以银行的已达来处理是吧？  
**A:** 我们是以资金系统的已达为准的，因为银行对账单里面的交易一定是已达的。那么会抽取资金系统已达的数据与银行账单核对。 资金系统未达，而银行已达的情况，目前我们是通过预警的方式进行发现。一般是T+1对账成功，如果发生日切，那么滚动对账，T+2可以对平。  
**Q:** 多大的数据量对账？  
**A:** 目前生产数据量是万级，另外一个项目数据量比较大，上亿级，但是暂停了，没有上线。  
**Q:** 对账发现问题，你们是人工处理吗？原始交易状态或金额怎么调整？  
**A:** 对账发现的问题，现在是人工介入分析，确认原因，如果是系统错误导致金额错误等问题，那么会进行冲账等操作，原始的交易一般不会改动。比如如果收钱收多了，会再手工退回给客户，那么同时也会记录汇款的SAP账。  
**Q:** 如果发现交易系统未成功，而银行已经成功，你们是怎么修改交易状态的？  
**A:** 一般分为两种情况，1、银行成功，但是支付机构未成功，保险公司未成功。发现问题后联系到支付机构确认交易情况，如是支付机构状态未更新，则由支付机构修复交易状态，修复后，对未达交易进行异常交易补偿处理，或者我们自动查询机构状态，或者支付机构推送状态。2、银行成功、支付机构成功，保险公司未成功。一般通过交易补偿，查询支付机构的状态，更新保险公司的交易结果。  
**Q:** 上亿的还是一条一条对？  
**A:** 我们的方案是通过阿里的ODPS大数据平台进行处理，一次比对一般是两张单表进行比对，结果会插入到另一张结果表。 因为ODPS是大数据平台，那么对单表数量没有限制。但是从方案角度来讲，会对已平账数据进行归档，也会通过表分区的方式划分开已平账和未平账。  