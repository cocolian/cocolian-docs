---  
layout:     post   
title:      "20180721-630断直联经验分享"  
date:       2018-07-21 12:00:00  
author:     "支付产品架构群"  
tag:		[publish] 
description: "断直联无疑是今年支付圈的顶级大事。 今天嘉宾跟大家介绍和分享一下自己从开始参与网联接入到630断直连整个过程中所经历的一些事情及遇到的问题，主要是银行端的断直联处理。" 
--- 

> 今天我跟大家介绍和分享一下自己从开始参与网联接入到630断直连整个过程中所经历的一些事情及遇到的问题。

## 一、	网联接入项目背景简介

[国办发〔2016〕21号国务院办公厅关于印发互联网金融风险专项整治工作实施方案的通知](http://www.gov.cn/zhengce/content/2016-10/13/content_5118471.htm)，非银行支付机构开展跨行支付业务应通过人民银行跨行清算系统或者具有合法资质的清算机构进行。

![20180721_153455](http://static.cocolian.cn/img/201807/20180721_153455.png)

根据中国人民银行支付结算司发布的《关于将非银行支付机构网络支付业务由直连模式迁移至网联平台处理的通知》（银支付[2017]209号）文件通知。根据党中央、国务院关于互联网金融风险专项整治的工作部署，人民银行指导支付清算协会建设“非银行支付机构网络支付清算平台”（以下简称网联平台），处理非银行支付机构（以下简称机构）发起的涉及银行账户的网络支付业务。

![20180721_153559](http://static.cocolian.cn/img/201807/20180721_153559.png)

![20180721_153600](http://static.cocolian.cn/img/201807/20180721_153600.png)

## 二、	XX行在实施网联接入项目过程中主要的时间节点

![20180721_153816](http://static.cocolian.cn/img/201807/20180721_153816.png)

![20180721_153817](http://static.cocolian.cn/img/201807/20180721_153817.png)

大家可能都知道网联采用三地六中心的架构方案：

![20180721_154027](http://static.cocolian.cn/img/201807/20180721_154027.png)

提供给各家行有2种接入方案：

![20180721_154156](http://static.cocolian.cn/img/201807/20180721_154156.png)

![20180721_154157](http://static.cocolian.cn/img/201807/20180721_154157.png)

## 三、直接阶段在业务流程和异常处理机制的变化

给大家挑选几个主要的交易，说明一下和直连阶段相比业务流程和异常处理机制的变化。

### 1、	业务流程变化

（1）协议签约流程

![20180721_154538](http://static.cocolian.cn/img/201807/20180721_154538.png)

（2）协议支付流程

![20180721_154620](http://static.cocolian.cn/img/201807/20180721_154620.png)

与原直连交易相比，原来1笔交易由网联拆成2笔：客户签约付款行1笔+支付机构备付金账户收款行，交易状态和异常处理机制更复杂。

交易状态分为：成功、失败、推定成功（异常成功）和推定失败（异常失败）

### 2、异常处理机制变化

![20180721_154920](http://static.cocolian.cn/img/201807/20180721_154920.png)

![20180721_155015](http://static.cocolian.cn/img/201807/20180721_155015.png)

![20180721_155046](http://static.cocolian.cn/img/201807/20180721_155046.png)

异常处理总的原则是，付款行交易状态未知时，终态一般推定为异常失败；付款行成功，收款行交易未知时，通常推定为异常成功。以协议支付为例，资金清算的流程大概是

![20180721_155411](http://static.cocolian.cn/img/201807/20180721_155411.png)

跨行交易，二代支付大额即时转账将资金从付款行（即协议签约客户所属行）划转到收款行（即支付机构备付金账户存管行）。

支付机构备付金账户收款入账为非实时记账，在网联下发交易批次对账文件对平后汇总记账，实时记账容易导致备付金账户成为热点账户。


## 四、实施过程中遇到的问题

1. 由于部分行认为备付金集中存管，认为自己不会有备付金行交易，所以未开发作为备付金行的功能，等生产验证时发现网联和机构又要求需要有这一块功能（对账、清算）。   
2. 生产验证时备付金实时记账，等到切量时发现备付金帐号为热点账户，需改造   
3. 某些支付机构退款先受理，后批量向退款行发起（同一客户的多笔订单再0.03秒内到达），使退款行做限额检查或客户账号成热点账户而退款失败  
4. 支付宝原直连卡通协议号长度比网联协议长，不兼容，目前还无迁移方案  
5. 新旧协议兼容，存量数据迁移切量问题，直连与网联新旧系统并行与交易路由问题，不同机构的规划设计方案不一致，协议不同库或不同系统、资源不同，相互之间兼容方案和切量方案都不一致，给各机构新旧系统的运维带来很大的困难。  

其实生产切量分为2部分：增量用户切量+存量用户切量，通常的切量方案是增量先切试运行，后切存量；部分用户较少的机构或不支持新旧系统并行的机构可以在生产验证完成后增量和存量一次性全切。

存量客户数据迁移至网联平台后，出现原直连渠道交易退款异常，原直连交易退款处理的3种方法：

1. 行方保留原直连退款请求，先行垫款退款，后期提供账号，支付机构电汇平账；  
2. 行方保留原直连退款请求，需支付机构先电汇打款至指定账户，银行端做退款；  
3. 关闭原直连退款请求，需支付机构走超级网银打款。  

## 五、网联1.2和1.3技术规范的主要变化

![20180721_160930](http://static.cocolian.cn/img/201807/20180721_160930.png)

主要新增了商业委托支付、差错异常处理、联合运维等方面的内容。

![20180721_161011](http://static.cocolian.cn/img/201807/20180721_161011.png)

---

## 六、Q&A

Q：热点账户有什么解决方案或思路？

A：目前暂时没特别好的方案，按交易批次进行汇总记账

---

Q：异常成功 这个能说下？是什么情况？

A：异常成功通常是收款方交易超时状态未知，网联发交易查询也未知时，网联平台终态时推定交易为成功

---

Q：为什么没有用那些教科书方案比如账户分类呢？我只是听过这种对高频账户采用账户分类减轻压力的做法，没有实际操作过，看到你们不用，以为有啥不适场景，可能还是交易压力问题吧

A：目前主要通过延迟汇总记账来解决
