---  
layout:     post   
title:      "20180808-通道路由设计"  
date:       2018-08-08 12:00:00  
author:     "支付产品架构群"  
tag:		[hidden] 
--- 

又一个通道路由的分享，介绍路由系统架构、维度和应用场景。

## 1、通道路由定义

通道路由，即通过程序自动为每一笔交易选择最优“线路”，对于支付系统而言，就是要自动选择入款、出款渠道。

## 2、通道路由架构

借用一张图来说明下：通道路由的架构，下边会再介绍下支付流程的实现。

![magie](http://static.cocolian.cn/img/201808/20180808_194812.png)

## 3、通道路由维度

我们一起看下入款（支付） 、出款（提现）渠道常见的几个限制维度：     
- 入款：金额、卡种、银行、交易限额、 其他限额等； 
- 出款：到账时效、金额、发卡行、发起时间、账户类型（对公、对私）、通道头寸等  

选择的原则： 
1. 确保交易稳定   
2. 实现节约成本  

## 4、通道路由应用场景

实际的通道路由应用场景包含：   
1. 支持通过“发卡行”+“账户类型（卡种）”+“支付金额”+“支付要素”查询返回最优渠道属性信息；    
2. 支持通过“账户类型”+“支付金额”查询返回各发卡行最优渠道属性信息；    

返回最优渠道属性信息包括业务信息如下：
- 是否需要签约；  
- 是否需要下发短信；  
- 支付要 素（明确必填or选填）；  
- 签约/鉴权要素（明确必填or选填）。  

利用流程图说明一下：

![magie](http://static.cocolian.cn/img/201808/20180808_194942.png) 

路由是支付的核心模块，稳定性是第一要素，其次是性能，最后才是怎么省钱。
路由系统的设计，需要和公司业务发展保持一致，并适度超前。
简单的if-else实现可以满足大多数场景下的需求。避免在系统建设初期引入过于复杂的路由。

当然了，伴随各第三方支付公司现在断直联接入网联后，针对通道路由应用场景相应会有所减少，但针对各四方公司或中型规模的商户（接入多家第三方公司进行收款的场景）还是有一定价值的。

今天分享到此结束，因为还有事，今天晚上没法很及时回复大家问题，大家可以提出问题@下我，我在明天上午之前会逐一回复。多谢大家聆听。希望跟大家多交流互相学习。

---

## 二、Q&A  

**Q1路由核心算法怎么样。**
- A1核心算法？我因为没在微信支付宝类的大型支付企业供职过，所以对于核心算法这种没有太多研究  
- 我文中提到了，基本以通过if else来输出一个最终唯一的结果
- A2决策树

**Q2请问这个是商户侧的路由么？**
- A1通道侧~商户侧路由这个问题线下会有吧，大商户池里选择当前交易走谁。 所以之前没细研究过~
- A2商户侧四方的应用较多
- A1嗯，我不知道之前回复那位朋友的理解对不对，我的理解反正类似于一机10商户什么的，还有mpos的所谓落地商户什么的都是这个意思吧。。。包括之前出的那个完美账单应该都是这类的。只是做细了。。。
- Q2 [奸笑]完美账单，队友无疑
- A1嗯嗯，之前听说这个，特好奇研究了一下
- Q2你们这个是现在线上跑的版本还是以前的基础版？跑一次路由多少毫秒，还有你们有做通道分析的么？比如通过一定的数据分析去改变规则
- A1通道分析包括通道运营人员都有，因为有些特殊场景需要人为介入，比如阶梯优惠等等场景，实现自动的成本过高没意义
- 这个跟大家分享的就是在用的，因为路由规则本身并不会有太大改动，改动更多来源于通道管理内容等等的升级。


