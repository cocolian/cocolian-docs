---                                                                         
layout:     post                                            
title:      "20180813-云闪付与支付机构接入"                                                                       
date:       2018-08-13 12:00:00                                                                           
author:     "支付产品架构群"                                      
tag:		[publish]                                
--- 

本次内容包括6月8日的云闪付介绍（复习），和8月20日的支付机构接入分享。 

云闪付广义来说是一个品牌，旗下像最早的手机闪付pay产品、到后来衍生的二维码与云闪付app，包含多个产品条线。这次主要介绍一下传统手机pay产品的相关内容，考虑到整体性与直观性，分享以图片形式为主，文字介绍为辅。  

## 1. 产品的定位  

![20180608_163452](http://static.cocolian.cn/img/201806/20180608_163452.png)  
通俗地理解就是 把银行卡放进手机里使用，要点是 手机设备必须支持nfc 功能。

## 2. 产品形态和特征

![20180608_163604](http://static.cocolian.cn/img/201806/20180608_163604.png)  

- 四形态根据安全加密模块（se模块）的形态来区分，包含基于运营商sim卡的（已经被淘汰），手机厂商主导的（applepay、华为pay、小米pay、三星pay等，目前最主流），可穿戴设备（苹果手表、拉卡拉手环、swatch手表等）以及手机软件虚拟的（HCE，非手机厂商但仍想推出闪付pay的，如银行app钱包）。 目前基本只有三形态了。
![20180608_163641](http://static.cocolian.cn/img/201806/20180608_163641.png)  
- 三特征，空中发卡指的是实体银行卡如何绑定在手机上，非接支付与在线支付分别就是线下和线上支付的方式，到银行发卡端的话，云闪付pay产品金融交易与实体银行卡金融交易并无差别，个别保留域会区分来源渠道。

## 3. 空中发卡

![20180608_163714](http://static.cocolian.cn/img/201806/20180608_163714.png)

简单理解，用户有三台手机，苹果、华为、小米，他拿自己的工资卡去这三台手机里的wallet钱包分别绑定applepay、华为pay和小米pay。 后台就会产生三个不同的token号，也就是虚拟卡号，用来标识同张实体银行卡在不同设备上绑定的虚拟设备卡。

Token映射约束条件:  
- 一张实体银行卡SPAN（具有借记/贷记功能）在一个设备上只能加载一个设备卡MPAN,在不同设备上可以分别加载一张设备卡。  
- 一个设备上对应多张SPAN可有多张设备卡MPAN,但有且仅可设定一张默认卡。  
- 设备卡MPAN可以包含以下信息： 一个借记/贷记账户；一个UPCash账户（可选） 
- SPAN的借记/贷记账户与实体银行卡关联同一个后台账户，并使用相同的交易密码。

Token卡的生命周期管理交易:  
设备卡的生命周期（主动）  
1. 加载  
2. 挂失与解挂（通过银行或手机厂商渠道  ）
3. 注销   

设备卡的生命周期（被动）  
1. 银行主动发起对设备卡的暂停、恢复、更新、注销等操作    
2. 实体银行卡的挂失与解挂、更新、注销    
3. 移动设备的丢失、找回、抹除内容、完整恢复    
4. 用户账号操作：从设备上注销、移除登录密码或指纹   

目前是支持手机渠道与行内渠道的管理

Token卡的金融支付交易
![20180608_163842](http://static.cocolian.cn/img/201806/20180608_163842.png)

银联侧会对收单上送的token号做映射转换，上送银行卡系统时已是转换后的实体银行卡号，除了个别保留域会有区分来源渠道，与实体卡的金融交易没有大差别。

## 4. 使用方式
### 4.1 线下近场非接的pos支付方式  

![20180608_163934](http://static.cocolian.cn/img/201806/20180608_163934.png)  
线下免密由收单侧与发卡系统共同控制。

### 4.2 线上app远程支付方式  

![20180608_164005](http://static.cocolian.cn/img/201806/20180608_164005.png)
目前applepay线上免密的金额限制，是发卡行自行控制，银联负责透传给苹果公司 下发到终端，终端在输入金额时做判别控制是否弹出密码框。

## 5、系统架构简图

![20180608_164101](http://static.cocolian.cn/img/201806/20180608_164101.png)

由于现在云闪付这块涵盖的内容较以往更多，且更新拓展的速度很快，云闪付产品全体系介绍可见：

https://wenku.baidu.com/view/09f1532e53d380eb6294dd88d0d233d4b14e3f86.html

开放平台内容可见：

https://portal.unionpay.com/portal/login.jsp

这里有目前云闪付品牌下各产品的入网资料，包括详细的需求、改造文档，以及具体的入网流程指导

---

## 6、接入云闪付

银联云闪付接入方式有两种：机构接入和商户接入，今天主要讲一下机构接入的情况。

接入主要是SDK的形式接入，产品流程有以下三种：
- 云闪付控件支付，  
- 云闪付收银台，
- 银联WAP 网页支付。

![8b6ea0a9c9ad6c76aed3b8292aa9b59d](http://static.cocolian.cn/img/201808/20180813_173328.png)

支付的时候会有以下三种流程：
1. 用户已安装并登录银联云闪付App，  
2. 用户已安装未登录银联云闪付App，
3. 调起内嵌商户App 内的``支付控件 SDK 银联 WAP 网页支付``，

在此说明一下：``SDK的 银联 WAP网页支付``和``API接入的 银联 WAP网页支付``在后台是两个权限。 如果之前有结果API的，在SDK调取的情况下也需要开通权限。

调取云闪付支付时不需要进行绑卡操作，用户支付是用的云闪付账户下绑定的银行卡。
在选择云闪付支付的时候，不需要App去判定用户是否下载云闪付，SDK会自动检测来调取``云闪付控件支付``，``云闪付收银台``，和``银联WAP 网页支付``这三种支付方式。

在使用云闪付控件支付时，机构接入会回传消费流水号TN，通过TN查询订单信息，支付结果为同步，返回参数支持借贷记。  
若用户下载云闪付App但未登录账号，支付时SDK会调取云闪付收银台，支持卡号支付和账号登录支付形式。   
若需使用优惠，需要登录云闪付账户。如SDK判定手机未安装云闪付App,调起内嵌的``支付控件SDK 银联 WAP 网页支付``，支付形式与``API的银联 WAP网页支付``一致。 
此支付结果为异步传输，不区分借贷记。
在跟银联测试联调中，会有5个测试联调窗口，按照接口文档及电话沟通，如果及时开通相关后台权限，一次测试窗口即可联调完成。
在接入云闪付支付后，支付优先级低于余额支付，高于App内绑卡支付。

---  

## Q&A

Q:现在云闪付SDK支持哪些支付方式啊？只有无卡吗？

A:有无卡,你可以理解为类似于微信app支付和微信网页支付.

Q:SDK的 银联 WAP 网页支付和API接入的 银联 WAP 网页支付有什么区别呢?

A: 后台权限不一样，是不用部门开启，支付流程都一致

Q:哦，除了权限，还有是不是就是一个走sdk，一个是直接走接口是吧?云闪付收银台，主要可以支持哪些支付呢？网页支付是不是也可以包在收银台中的一种啊

A:是的。网页支付和收银台不一样，云闪付收银台，主要可以支持直接支付和账号支付两种。
