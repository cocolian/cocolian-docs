---                                                                        
layout:     post                                            
title:      "20180826-商服系统"                                                                       
date:       2018-08-26 12:00:00                                                                           
author:     "支付产品开发群"                                      
tag:		[publish]                                
---


大家好，很荣幸能在这里和大家分享我们之前做的商服系统。该系统是去年4月份做调研、分析、设计并实施的。  

## 一、系统概述

**商户服务**系统的用户**面向主体****为与银行签约的特约商户**，主要提供的服务有资金交易查询、门店管理、对账文件明细查询和下载、交易统计、交易退货、门店二维码生成（商家固定二维码）、证书管理及其他一些附加功能（产品中心、活动宝典、帮助中心等）。 

根据各大银行及消费金融公司的具体情况，有的是经过业代上门拓展，有的是委托相关的代理商拓展，即商户性质为自营商户和代理商拓展商户。通过代理商拓展的，银行还需要和代理商签订协议，确定商户的合法性及有效性，以及分佣比例，这里主要说的是**自营商户**。商户签约需要提供的字段如下图。  
![image](http://static.cocolian.cn/img/201808/20180826_193336.png)   
【商户的基本信息】  
![image](http://static.cocolian.cn/img/201808/20180826_193411.png)  
【商户的清算信息】  
![image](http://static.cocolian.cn/img/201808/20180826_193436.png)  
【商户的具体门店信息】  
![image](http://static.cocolian.cn/img/201808/20180826_193458.png)  
【商户选择的收单方式】  
![image](http://static.cocolian.cn/img/201808/20180826_193536.png)  
【商户资质的上传图片】  


银行运营人员登录银行后台系统，输入商户的相关信息并提交，通过**风控、产品、运营等审核**通过后（如果在选择收单方式时选择**支付宝和微信**，此时系统会调用微信或者支付宝的增加商户接口完成在**微信、支付宝的入驻**），下发短信给商户管理员，商户管理员**凭此短信**，**登录商服系统**，进行相关操作。  
![image](http://static.cocolian.cn/img/201808/20180826_194021.png)   

商服系统的功能比较多，在这里主要讲一下主要的功能。  

## 二、主要功能  

**1. 对账单查询及下载** 
  
该对账回盘文件，是通过**批量**程序**获取**后台（支付宝、微信等）提供的**交易流水**文件，经**对账**、**清分**、**结算**后生成，提供txt和csv格式下载。**商户可通过此功能查看具体的交易信息并下载核对**。  

**2. 退款功能** 
  
商户在与用户协商完成后在商服系统选择**全额退款**或**部分退款**，++当日的交易可在商服系统选择交易撤销。撤销只支持全额撤销。++  
![image](http://static.cocolian.cn/img/201808/20180826_194634.png)  

同时开发了给商户使用的**商户APP**，功能和pc端类似。  
对于商户证书管理和差错争议功能在这就不阐述了。

---

## Q&A
**Q:** 结算日内部分金额反向交易是不是算退款了？  
**A:** 退款只能隔日退款，当日的未结算的只能全额撤销；结算前的只能全额撤销，如果是部分的话是直接拒绝的。    
**Q1:** 计费是怎么记的，是有单独的手续费账户吗？以及退款是不是退手续费？  
**A1:** 退款是否退手续费，可以在后管的参数管理设置。  
**Q2:** 退款和撤销对外的是一个接口还是各自一个接口呐？  
**A2:** 退款和撤销是2个接口；  

**Q:** 支持哪些支付方式呢？  
**A:** 微信/支付宝/本行卡/他行卡等；  
**Q:** 能说下退款为啥只支持隔日退吗？  
**A:** 目前市场部要求，且在晚上22：00到0：00不许退款和支付。    
**Q:** 请问下，你们这个商服系统属于银行的业务系统还是外部系统？    
**A:** 外部系统    

**Q:** 对于一笔消费，如果这比消费日终已经清算给了商户，还允许商户退款吗？  
**A:** 目前支持隔日部分退货和全额退货；  
**Q1:** 如果说按照贵司开发的系统，D日交易只能D+1退款；当在D+1日，发现有笔成功的消费，商户点击了退款，（但是这笔退款还没发送给后端通道）那么在D+1日，这笔原消费成功的资金会清算给商户吗？  
**A1:** 如果采用的是差额结算的话；从D+1当日的交易款项扣；  
**Q2:** 也就是说发往通道前会去判断该商户当日交易额是否大于该商户下发生的退款金额，然后再把退款发往通道是吗？  
**A2:** 是的，不够退的话肯定不会发生；   

**Q:** 商户这块日终是钆差结算，那客户退款资金是从哪里出来的？备付金账户么？  
**A:** 商户中间户；  
**Q1:** 商户中间户是什么概念？针对每个商户的结算户，会有一个对应的商户中介户？然后到了日终清算后再入账进结算户？  
**A1:** 也就是日间交易划到这个中间户，结算日时再从中间户结算到商户结算户里，这与每个银行具体的科目设置有关；如果结算方式不是实时的才会有这个中间户；  

**Q:** 实时结算？能说说实时结算，怎么实时么？  
**A:** 实时这块可以做，看商务，否则手续费不低。  
**Q1:** 能说下为啥能支持实时结算吗？通道一般一天给一次对账文件，目前我只接触到网联每小时能给一次对账文件；  
**A1:** 垫资d0。  
**Q2:** 哪个参与者垫资？银行吗？  
**A2:** 实时结算，借银行往来，贷商户余额，借商户余额，贷银行往来，商户当日交易金额实时结算进商户可用余额账户，可以代付提现；支付公司垫资，也有用银联授信额度的，风险是大，d0不好开，一般还额外收垫资费用，风险很大。  
**Q3:** 一笔用户消费，商服发到行内支付，行内支付发给通道，通道响应行内支付，然后实时清算给商户，这个时候，为啥是支付公司垫资呢？  
**A3:** 只是信息流成功，资金渠道不会马上到帐，所以得支付公司垫资；是的，和节假日结算是一个道理，上游一般都是都是t1资金结算。  
**Q4:** 您从的是那个行内的XX通道结算户 垫资是吗？我一直没太理解跟账户相关的东西，这里刚好请教下，在没断直连之前，这个支付里面的XX通道结算户，是不是三方支付公司在某个银行开的户，还是说是银行在支付机构那儿存的备付金，然后这个XX通道结算户是这个备付金的一个影子户，相互映射？  
**A4:** 原来支付机构的备付金银行账户有三类，存管户，收付户，汇缴户，存管户一个支付机构只有一个，收付户一个银行只有一个，汇缴户不限，可以有多个，这个是在2号令里面规定的，以后备付金是央行存管的，就只有一个存管户了，基金等业务除外，其他的银行备付金账户就没有了。  
**Q5:** 跨境业务的备付金户呢？  
**A5:** 跨境业务也可以开设一个（只能一个）专用的。  

---

## 补充
1. 验证退货交易：验证是否存在原交易；验证退款金额是否小于可退金额；如果当日交易且退款金额=可退金额=原订单交易金额，则无论本行卡或者他行卡均发送实时撤销交易；实时撤销交易失败，流水记为“待退货”状态。返回前端的交易状态为“退款中”如果非当日交易，则发送实时退货交易。实时退货交易失败，流水记为“交易失败”，返回前端的交易状态为“交易失败”；  
2. 撤销接口更多是用于处理异常业务的，而不是用于做正常的退款业务的；  
3. 差额结算：是指商户结算日时从商户未结算款中扣收手续费、退货金额的结算方式。  
4. 一般退款时会先检查商户的余额户，够钱才退，然后做轧差结算；
5. 有个设想会不会好一点，就是在每天清分清算前 去判断 是否有退款交易，如果有退款 那么不把原交易金额结算给商户，也不会涉及手续费，等到这笔退款 得到最终结果后，再根据结果结算给商户，这样的话就不存在用商户D+1的交易额来抵扣D日的退款。不管退款交易是否成功，再没结算给商户前，这笔钱始终会在行里的某个过渡户里；  
6. 商户入网时，就要确定结算方式，如果支持D0结算，每笔交易都是直接记在余额户；