---
layout: 	essay
title: 		"P2P系统设计"
date: 		2018-06-01 12:00:00
author: 	"shamphone"
chapter:	"4"

---

## 一、存管系统设计

了解P2P系统设计，需要先了解p2p存管系统。 存管业务系统在银行架构中的位置:

![存管业务系统在银行架构中的位置](http://static.cocolian.cn/img/201806/20180608/f4706e8b36632f60e5176bce0b2adbe1.png)

存管系统在整体的银行架构中属于中间业务，和这个业务相关的模块有： 
- 银行产品：现在逐步使用模块化管理。对私业务包括理财业务、直销银行；对公业务包括存管、中间业务、现金管理、票据等。 
- 聚合支付：对接银行的支付系统，提供统一的支付服务给各个产品使用；  
- 虚拟账户：提供了独立虚拟账户，供应用模块使用；  

从产品设计上，存管系统应用模型: 

![png](http://static.cocolian.cn/img/201806/20180608/e9687596340dcffb5770f8568a5883a1.png)

- 渠道层：对外是银行接入的资源，包括行内终端，用户、商户接入等；  
- 核心层：是银行提供的存、贷、汇的业务系统，包括支付、核心系统、互联网核心和信贷系统；  
- 产品层：产品层是此次介绍的重点，是前面图的进一步细化；  

存管系统主要模块： 
- 存管系统：这相当于一个业务容器，各个银行存管产品是模块化部署的，通过存管支撑系统将各个模块整合起来；  
- 账务系统：是交易流程的处理系统，提供记账、对账、清算相关的业务处理流程；  

基础服务主要模块：      
- 互联网支付：在这个架构中是用来处理用户、商户接触和交互；包括接口、H5、sdk访问；  
- 账户系统：就是虚拟账户系统，为各个业务模块提供虚拟账户记账服务；  

## 二、直接存管模式设计


### 2.1 账户体系  

商业银行托管模式中最常规的就是银行直接存管，也称为单核心模式。这种模式下，需要开立如下账户： 
1. 银行为P2P网贷平台开立网络借贷资金存管专用账户（大账户）和自有资金账户。
2. 出借人和借款人在P2P平台注册账户，然后到银行界面开立个人存管账户（子账户）。这个银行子账户关联到P2P账户。
3. 根据平台自身需求与实际情况为平台开立风险备用金存管账户和担保公司存管账户。  


### 2.2 资金流向 
当出借人进行投资时，资金流向是：  
1. 出借人在P2P平台充值，资金从出借人发卡银行账户转移到出借人银行子账户上。
2. 满标后，平台将信息同步到银行，募集的资金直接从出借人账户转移到借款人子账户上，手续费转移到自有资金账户上。 
3. 借款人提现时， 资金从借款人子账户转移到发卡行银行账户上。 提现可以走银行通道或者支付通道。 

返款流程也是类似的： 
1. 借款人返款时，资金从发卡行银行账户转移到借款人子账户上。 
2. 平台将信息同步到银行，银行将返款转移到出借人的子账户上，并将扣除的手续费转到自有资金账户上。 
3. 出借人提现时， 资金从出借人子账户转移到发卡行银行账户上。 

注意，按照《规范》的要求：
1. “存管人应该在自有网站页面为客户开立子账户” 。出借人和借款人必须在银行页面上自主开户，不允许通过银行的接口来委托开户。 
2. “存管人应该在汇总账户下为每个出借人、借款人、担保人开立子账户”。并要求“子账户应该仅具备记账功能的虚拟账户”， 这就注定了银行I、II、III类户无法直接用于P2P存管。 
3. 禁止第三方代理开户，批量开户、静默开户也都不允许。存量用户需要重新开户。 
4. “存管人应该将客户子账户与该客户不具备透支功能的银行卡/银行账户绑定”， 也就是不能使用信用卡了。 
5. “充值环节委托人不应接入支付通道”，也就是出借人直接通过银行或者支付公司的通道来充值，P2P平台不能采用接口转接或者封装的方式来提供充值功能。 


### 2.3 架构设计

在系统架构设计上，采用虚拟账户（存管前置）+存管账户（核心系统）的方式，整体分为三层：

![虚拟](http://static.cocolian.cn/img/201806/20180608/62e31066456cd158e381437cb62f556d.png)

**1. 网贷平台**

存管系统对网贷平台按个人、企业、担保方和平台方，分成了几个主要角色，便于平台可以按需求进行直接映射和包装；  

**2. 银行核心**

1. 存管账户：平台方首先需要在银行开立存管账户，该账户存放了交易各方的资金，所以需要根据不同行业的监管政策进行监管，因此该资金池的使用仅能通过存管系统进行资金进出和结算；在未授权的和监管许可的情况下银行内是没有入口提供给平台方处理账户资金的；  
2. 平台自有资金账户：如前所述，存管账户的资金是严格进行监管的，那么平台自有资金这块就需要单独开立账户，通过调拨接口充值或者提现；  
3. 跨行结算账户：这是行内对接不同的支付系统提供的清结算账户；（名字上就能区分出来，不做赘述了）  

**3. 存管系统**

由于核心开立的存管账户是资金池，存放了交易各方的资金，因此资金池内的资金需要按不同的客户进行区分；所以存管系统按平台不同的结算开立不同的虚拟账户，用来把存管账户资金池内的钱进行清楚的区分；

平台方的虚拟账户：可以看到平台方作为撮合方，只能主动向用户转账，而不能逆向，这样的设计是一方面为了满足平台提供营销资金的使用，和抹平平台和交易各方的利率差；另一方面从技术手段上防止平台在用户不知情的情况下将自己划入自己的账户；

用户的虚拟账户：用户可以通过投资、借款、还款等特定场景和协议的接口向其他用户转账，但所有操作都是需要基于指令和协议的；

整个过程中，托管银行会对用户的充值、提现和资金流向进行监管。这样的资金流中，一笔交易从开始到结束，资金均在银行内流动，P2P平台没有接触交易资金的机会，杜绝了P2P平台挪用交易资金的风险。
直联存管模式是遵循《规范》的要求设计的模式，也是目前合规推荐的方式。 


## 三、银行直联模式

与直接存管不同的是，银行直连模式中，托管银行为出借人和借款人开立的是可以直接进行在线交易的银行电子账户。
用户不需要到P2P平台进行充值或提现，就可以实现与绑定的同名银行账户之间的转入和转出，P2P平台只充当中介作用。
借款时，银行根据P2P平台提供的信息，将资金从出借人的银行账户转移到借款人的银行账户上。 
返款时，银行根据P2P平台提供的信息，将资金从借款人的银行账户转移到出借人的银行账户上。 

银行直连模式最大的特点是在交易支付时直接经由银行的网上银行进行操作，不存在其他方面介入。
这种模式对于投资者而言是资金风险最小的一种——因为他的资金流向最清晰，同时最能满足P2P平台作为信息中介的定位。但问题也比较突出。
国内银行体系中的支付体验差、主动服务意识不足。尤其是充值或提现到账时间方面较慢，难以及时满足投资人的充值或提现需求，用户体验感较差。目前业内仅有极少的几家平台选择此模式。

在架构上， 这种模式也被称为“双核心模式”， 采用虚拟账户（存管前置）+电子账户（互联网核心）+存管账户（核心系统）的架构： 

![png](http://static.cocolian.cn/img/201806/20180608/51eba4b552dce661e98ca0906bc90532.png)

存管账户是两个模式都要开立的账户，II类账是用户在注册虚拟账户时绑定的一个钱包账户或者说II类银行卡，涉及的账户有： 

- 存管账户：该账户由平台委托银行申请开立，用来存放交易资金，账户上的资金归属与交易参与各方；因此平台对该账户没有归属权，也不能像普通企业账户一样直接操作账户内的客户资金；  
- 虚拟账户：存管账户由于是资金池的属性，为了更好的区分资金池内部的资金，因此设立了虚拟账户；通过虚拟账户将存管账户上的资金按用户进行映射。虚拟户属于簿记等级，是记录的资金的信息，实际的资金在存管户存放；  
- II类账户：又称为电子账户，电子账户是实际的个人在银行开立的II类账户，该账户有归属于开户人，用来存放自有资金；  


## 四、联合存管模式

根据最新的行业进展来看，第三方支付机构与银行相比在系统对接和行业认识上具有比较优势，并未当即出局，而是出现折衷，即由商业银行与第三方支付机构联合存管P2P 平台资金。
这种模式下，支付环节由第三方支付企业完成，第三方支付为平台提供技术方案、支付结算、数据运营等技术类服务，起支付通道作用。
银行则提供账户开立服务，P2P 平台和第三方支付机构分别在银行开通资金存管账户，并由银行监督资金流向。

在实现上，入金使用支付机构提供的通道，出金则采用银行的接口。 之所以这样设计是基于收款放开，出款收紧的原则；

- 收款资金放开：比较好理解，为了用户体验和更多收取资金；
- 出款资金收紧：这就提现存管的特点了，存管因为是在出款和结算的时候进行扎口；在出金前要完成账实核对（总分核对）之后，确认交易和到账资金无风险才会结算到用户银行卡上，是作为事后风险处理的关键节点；

### 4.1 充值（三方支付）

![png](http://static.cocolian.cn/img/201806/20180608/fff95a111a81dfbc7f0ce383632f902e.png)

以上是整个支付流程（图示由说明不再赘述了）

其中需要说明的是T日入款的资金用户虚拟账户上记“待清算资金”，可以在平台内部使用但是不能提现；

### 4.2 提现（人行大小额、超级网银等）

![png](http://static.cocolian.cn/img/201806/20180608/a246bb596c2b4ebd655e39d183344802.png)

以上是整个支付流程，图示比较清楚了，说明下几个关键业务点；

1. 提现会先冻结在用户账户上或者划入过渡户；  
2. 日终存管系统对交易完成账实核对后存管系统才会对外出款；  
3. 如果是T+0出款，需要开通行内法透账户，T日通过银行法透账户按；T+1账实核对后资金入法透账户；  

### 4.3 交易撮合处理

![png](http://static.cocolian.cn/img/201806/20180608/a10902c783ce9fa3c897fbab0975093d.png)

交易撮合过程都是在虚拟账户上的资金信息转移处理，此时资金还没有到账都是信息流的登记；需要T+1日资金结算到存管户后，虚拟登记簿和存管户汇总资金进行账实核对（详细撮合的虚账处理此次不做展开）

### 4.4 支付业务日终处理

![png](http://static.cocolian.cn/img/201806/20180608/a4fd2a551a3b7b1ed592659d8670d188.png)

1. 日间交易（0:00—23:59）: 日间交易提供充值和投资、借款、放款、还款业务，但是资金到账后用户可以使用但是不能当日提现；  
2. 日终交易对账：(0:00—0:10): 下载渠道对账文件，以渠道为准进行对账，根据流水逐笔核销“用户虚拟账户”上的“待清算资金”；  
3. 结算资金对账（9:00—9:10）: 如果通过第三方渠道，结算资金会在T+1日打入存管账户；  
   - 触发存管系统进行账实核对；    
   - 总对总核对：清算资金（核心存管账户）=应收待清算资金（平台虚拟账户）  
   - 总分核对：存管账户总资金-清算资金（核心存管账户）=∑个人/企业/平台/担保方虚拟账户汇总资金；  
4. 下发对账文件:  包括“支付流水文件”，“汇总资金文件”，“虚拟账户日结余额文件”  
5. 发起自动出款业务，如果T0垫资业务，资金一笔划入法透账户；  

