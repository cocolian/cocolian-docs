---
layout:     essay
title:      "网联业务-协议支付"
date:       2018-05-05 12:00:00
author:     "shamphone"
chapter:	"1"
status:		"hidden"
---

## 一、定义

协议支付指客户需要先进行身份认证及签约，然后再根据签约协议进行支付，银行需要校验协议信息。和现有的快捷支付类似。 
网联的协议支付业务与现有市场的快捷支付业务相比主要增加了银行端解约的功能。 在支付宝卡通业务改造为快捷支付之后，快捷支付的解约支付机构不再通知到银行，银行本身也没有发起解约的功能，所以银行系统中保留的签约信息不是完全正确的。
目前网联切量数据的迁移方案就需要解决这个问题。 
网联建立后，根据人行发文要求，快捷支付业务的协议信息支付机构必须和银行保持一致，并且可以从银行发起解约交易。  

快捷支付业务最初的前身是支付宝卡通业务； 通过支付宝或者银行网银建立支付宝账户和银行卡号之间的绑定关系，客户可以通过支付宝或者银行内系统互相查询余额，互相转账。  
   
卡通当时是非常方便的； 后来支付宝推出了快捷支付，逐步停用了卡通的功能； 快捷支付后期，快捷支付的解约支付也不再通知给银行系统；  
网联业务中，协议支付的解约分为支付机构发起和银行发起  
   
支付机构发起的解约申请是指支付机构根据客户委托，向银行提交解除指定银行账户支付协议的申请。银行收到解约申请后，应校验协议信息，校验通过的将相关协议状态置为已解约，同时向平台返回解约成功回执。对校验未通过的请求，银行应给予失败应答并向平台返回失败原因码。     
银行发起的解约为解约通知，即向支付机构强制解约；银行发起的渠道包括：手机银行、个人网银等。   
网联协议支付业务除了解约功能外，其他和现有的快捷支付业务是一样的。


### 3.4 认证支付

认证支付是指客户无需事先或首笔交易时与支付机构及银行签约，每笔交易时均输入身份信息、银行账户及动态验证信息，并由客户账户所属银行负责对上述信息校验后进行扣款的交易。 认证支付业务主要为无支付账户体系或者支付账户体系应用较少的支付机构开展网络支付业务时使用。 

![2018-04-02 17:20:33](http://static.cocolian.cn/img/in-post/nucc-9.png) 

### 3.5 网关支付

网关支付，是指客户通过支付机构发起，跳转至银行网关验证客户身份信息和银行账户信息后，向客户银行账户发起支付指令扣划资金的交易。      网关支付限定为客户跳转至银行网关进行支付的场景，需要根据银行要求下载安全控件或插入U盾等安全设备进行支付，可分为个人网银、企业网银。       
   
网联改造前的网关支付流程： 
1. 支付机构先将订单信息发送给银行，请求银行网关地址。这一步也被称为预下单。   
2. 银行网关根据订单信息生成的支付页面， 并在订单请求返回报文中返回该页面的地址，  
3. 支付机构将地址发送到用户端浏览器，引导用户跳转到银行的支付页面。 
4. 用户在银行支付页面填写支付信息，执行支付， 提交到银行网关处理。 
5. 银行在支付成功后异步返回给支付机构订单支付结果。   

![2018-04-02 17:20:32](http://static.cocolian.cn/img/201804/20180402_172032.png) 


网联网关支付，分为网关支付申请、网关支付跳转、网关支付状态通知、网关支付终态通知几个交易， 我们这里对接通过统一的网关系统实现相应的页面（网联前置没有网关的功能）， 网联网关支付对接后的流程：   
   
![2018-04-02 17:20:33](http://static.cocolian.cn/img/in-post/nucc-1.png) 
   
下面是网联网关接口的调用流程   
   
![2018-04-02 17:21:15](http://static.cocolian.cn/img/in-post/nucc-2.png) 
   
新的网关支付即考虑了个人支付网关，也考虑了企业支付网关，其中个人网关根据终端的不同又分为PC网页版和H5版（主要根据网关跳转报文中的终端类型字段判断）   
   
网联规定，个人网关订单有效期为**3小时**，企业网关订单有效期为**30天**。  
   
### 3.6 商业委托代扣
   
网联针对代收、代扣业务提出了商业委托支付的功能，      商业委托支付业务，是指支付机构经网联建立商业委托支付协议，并依据协议约定发起的客户银行账户资金扣划业务。       
商业委托支付和协议支付的区别：
- 商业委托支付具有固定收款人、定期收款的特性，而协议支付没有此特别要求。
- 商业委托支付以商户和客户签署的收款协议为前提之一，而协议支付没有。     

商业委托支付业务包括“建立委托”、“解除委托”、“商业委托支付”和“退款”等交易环节。  
  
![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-3.png) 

商业委托支付业务参考《《中国人民银行关于规范支付创新业务的通知》（银发[2017]281号）中关于代收业务的要求， 需要注意如下事项：
1. 付款人开户机构应当事先或者在首笔交易时取得付款人授权，明确
异议处理和交易关闭方式等事项，并在后续交易时及时提示付款人交易信息。
2. 代收服务机构应当要求收款人事先与付款人签订收款协议，并在代收交易处理中验证协议关系。代收服务机构应当真实、完整传输交易金额、交易时间、收款人名称和收款用途等代收交易信息，并采取有效措施禁止收款人滥用、出借、出租、出售代收交易接口。

   
#### 3.6.1 建立委托
   
建立委托是指支付机构根据客户委托向其账户所属银行提交申请，为指定银行账户开通商业委托支付功能的处理过程。       建立委托支持的账户类型包括个人银行账户和单位银行结算账户。建立委托的方式包括网关方式和线下方式，具体使用网关或线下方式由银行与支付机构协商确定。  
客户在授权委托协议时，银行需对其客户进行身份验证；委托协议号由银行生成，生成规则由银行规定；建立委托的状态以银行为准；签约要素信息具体参见《网联商业委托支付业务处理规则》。

**1. 网关方式**  

网关建立委托的方式，是网联新引入的。 网关方式建立委托是指通过支付机构发起，跳转至银行网关后，客户提交建立委托所需要素信息，经银行审核通过授权后，支付机构向银行取得委托支付协议授权的过程。
流程如下：   
   
![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-4.png) 

- 开户银行对客户身份信息及银行账户信息进行验证；在规定时间内（7个工作日）返回建立委托的交易应答。
- 支付机构应要求商户与客户签署委托授权协议，支付机构应采取有效措施确保委托授权协议的真实、合规
   
银行可以通过银行网关系统发布了一个签约的网关页面，银行网关系统提供验证相关的功能和验证结果，签约完成后协议保存在网联前置系统中，和协议支付的协议存在一起。
   
   
**2. 线下方式**  

线下方式建立委托是指商业委托支付业务各交易参与方线下建立委托关系后，支付机构通过网联向银行提交商业委托支付协议信息，银行进行客户授权意愿确认后返回支付机构委托支付协议授权结果的过程。   
      
![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-5.png) 

银行侧处理流程： 
1. 银行收到支付机构线下的建立委托信息后，网联前置入库留存。  
2. 客户通过企业网银、手机银行、个人网银从网联前置查询出待确认的商业委托列表。   
3. 点击其中一条待确认的委托，显示出具体的待确认商业委托信息（包含商户信息、支付机构信息、委托支付卡/账号）等。 
4. 客户输入卡/账号密码进行确认。    


#### 3.6.2 解除委托
   
商业委托协议的解除，也分为支付机构发起的解除委托和银行发起的解除委托。  

**1. 支付机构发起**  

支付机构端发起解除委托，可由商户或客户发起。如果由客户发起，支付机构向商户确认是否解除该委托关系，确认商户与客户达成解除委托关系的一致后通过网联向银行发起解除委
托的请求。而银行对交易信息验证通过后，标记相应的商业委托支付协议，并返回支付机构交易应答。 

**2. 银行发起**  

客户可通过开户银行提供的渠道发起解除指定银行账户商业委托支付协议的申请。开户银行接收客户解除委托的申请后应及时通过网联提交至支付机构。如支付机构返回同意解除委托，开户银行应将相应的商业委托支付协议进行标记。如支付机构返回不同意解除委托，开户银行应保持相应的商业委托支付协议状态不变。如支付机构未在规定时间内（7个工作日）返回是否同意解除委托的应答，则开户银行将该笔解除委托交易视作同意解除委托，对相应的商业委托支付协议进行标记。开户银行应在获取解除委托交易的结果后通知客户。因支付机构未及时返回解除委托应答引起纠纷造成客户资金损失的，原则上应由支付机构承担。规定时间内（7 个工作日）开户银行在收到支付机构应答前，商业委托支付协议状态不变。   
   
![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-6.png) 
   
#### 3.6.3  委托支付

商业委托支付是指支付机构根据事先或首笔交易时建立的商业委托支付协议，定期经网联发起的无需客户确认的银行账户支付交易。     商业委托支付业务支持扣款至备付金账户和扣款至非备付金银行账户。 

**1. 扣款至备付金账户**  

业务流程与协议支付流程一致。 

![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-7.png)
 

**2. 扣款至非备付金账户**  

1. 仅用于商业委托支付业务，个人银行账户至个人银行账户不支持；  
2. 不支持退款，如确需退款，由商户和客户进行协商；  
3. 各参与方要解决支付机构户名替换的问题，也就是出入金在交易流水中应该是具体的商户和客户，而不是支付机构名。 
   
![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-8.png)

商业委托支付的退款、网关支付的退款、协议支付的退款处理流程是相同的，和现有市场的退款业务处理一致，也不再展开了 。  


### 3.7 付款业务

付款业务是指通过支付机构发起，经平台转发的，由支付机构备付金账户扣划资金至指定银行账户的实时网络支付交易。 付款业务主要解决商户结算、提现等备付金出金类业务需求。

![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-10.png)
   
## 4. 资金清算

4.1 清算过程     
资金清算由网联清算平台负责，交易资金差额清算。网联清算平台在清算时点后将该清算场次内所有的交易清分结果按清算行纬度进行汇总轧差，生成各银行的轧差净额。间接接入的银行与其清算行的交易汇总轧差，生成轧差净额。  

![2018-04-02 17:24:39](http://static.cocolian.cn/img/in-post/nucc-11.png)
     
在大额支付系统工作日，网联按清算场次提交清算指令，由大额支付系统完成交易资金划拨，划拨币种为人民币。   
在大额支付系统工作日进行，网联清算目前为2场次： 

1. 当日9点后（进行上一工作日15点至本工作日9点的资金清算）   
2. 当日15点后（后进行当日9点至15点的资金清算）； 网联通过人行大额系统新即时转账报文通知收款银行和付款银行。 

网联清算平台在大额日终2小时后提供清算信息文件。在每工作日日为每一清算行提供一份清算信息文件，描述清算场次和交易批次号之间的关联关系。  银行系统收到网联的清算文件后进行清算账务的处理，将清算资金从每个支付机构的过渡户中转移到网联清算平台的过渡户；  汇款系统在处理人行大额即时转账报文时，自动将网联清算平台过渡户的资金转移到人行备付金账户对应的过渡户中；  
   
![2018-04-02 17:36:18](http://static.cocolian.cn/img/201804/20180402_173618.png) 
     
网联的资金结算 
1. 非备付金账户结算实时完成（指到客户账户的资金需要银行实时记账处理完成）。   
2. 备付金账户结算按自然日完成。   
   
备付金账户行在 12：00 前完成上一自然日20：00 至本日 9：00 的交易资金结算。24：00 前完成本日9：00至20：00的交易资金结算。 
   
![2018-04-02 17:38:05](http://static.cocolian.cn/img/201804/20180402_173805.png) 
   
  
由于网联清算周期和资金结算周期的不一致，导致支付机构备付金账户行会产生资金垫款（对应的，非备付金账户银行资金会有结余）。  清算行在垫付资金时，网联将按照中国人民银行超额准备金利率，对借贷记差额向清算行分别计收计付利息。  应计收或计付的利息按如下方式计算：       

```bash

利息=本金 * 时间 * 利率       

```

本金是指垫资方未收即付的轧差净额；利率按照中国人 民银行超额准备金利率执行；时间是指垫资方未收即付的时间，以自然日为计量单位。 

**1. 利息清算**    

网联平台在大额支付系统工作日计算上一工作日至本工作日各清算行应收或应付利息金额，生成对应的清算指令后以网联平台为中央对手方提交大额支付系统完成利息资金清算。其中，付差方为利息补偿机制中付息方，收差方为利息补偿机制中的收息方。该清算指令单独提交，每家银行在每个工作日由网联提交一笔清算指令。 

**2. 利息核对**       
网联平台在大额支付系统日终 2小时后，按既定规则向清算行提供单独的清算信息文件供银行进行利息金额核对。文件中包含该笔清算指令清算结果及对应批次净额结果等信息。  目前行内尚未对利息进行核对，后续可能增加核对的功能。  
   
网联对接后相关交易的对账以网联为准。如对账不一致，银行应先自行排查原因，需进行调整的，可联系网联进行核查，根据核查结果进行调整或进行差错处理。  
网联对账文件的生成依赖于联机交易中的批次号。      网联交易的参与者发起支付业务时，由网联清算平台为每笔支付业务分配一个确定的交易批次号。交易批次号由“B”+“8位日期”+“4位序号”组成，长度13位。      网联清算平台在接收到参与者的交易申请报文后，将交易批次号字段填入交易申请报文并依次转发至付款行/退款行、收款行，随后将交易批次号填入返回至支付机构的交易回执报文。       

网联清算平台每个小时一个批次号，自然日一天24批次。       
联机交易对账文件在批次结束后的2小时内产生。        网联在每自然日为每一银行提供多份对账文件，对账文件由对账汇总文件和对账明细文件组成。平台在每个获取时点（可参数化配置）提供1个对账汇总文件和N个对账明细文件。对账明细文件包含交易状态为“00”（交易成功）、“01”（交易失败）、“03”（交易异常成功）、“04”（交易异常失败）的终态交易记录。当无交易发生时，不生成对账明细文件。  
   
 
### 4.1 差错处理      

网联提供了2种差错处理接入方式：   

1. 直接应用网联的差错公共处理平台   
2. 使用银行自有系统，与网联通过差错处理API接口对接   
   
  
核查，对应到网联进行交易详情查询，确认交易账务处理结果。 差错提交，向对手机构发起差错调账申请，待对手机构确认是否同意差错调整。 差错调账申请（贷记调整），真正的进行差错调账处理。  
   
![2018-04-02 17:44:30](http://static.cocolian.cn/img/201804/20180402_174430.png) 
   
![2018-04-02 17:44:31](http://static.cocolian.cn/img/201804/20180402_174431.png) 
   
## 5. 银行侧对接
   
网联清算平台自身建立了3地6中心，银行总行统一与网联接入，生产环境采用专线对接。 银行至少2个中心对接主机房，1个中心对接灾备机房，系统采用SSL等 设备进行通讯加解密，SSL 设备与应用系统之间采用可以采用F5等设备来实现负载均衡。 
   

![2018-04-02 17:47:44](http://static.cocolian.cn/img/201804/20180402_174744.png) 
   
参考业务架构如下   
   
   
![2018-04-02 17:48:19](http://static.cocolian.cn/img/201804/20180402_174819.png) 
   
   
网联清算平台模式与原有业务模式对比    

银行接入支付宝快捷支付业务后，2015年又要求各个城市商业银行必须通过8家市场上的金融服务公司对接。 银行借此将各个支付机构的对接通过金融服务公司代理的模式对接，现有生产的模式如下   
   
![2018-04-02 17:50:49](http://static.cocolian.cn/img/201804/20180402_175049.png) 
   
网联对接后的模式与银行现有的模式基本相同，所以可以使用了已有的快捷支付前置系统对接网联  
   
网联建立后，对城商行来说有一些优势： 
1. 目前支付机构与银行多对多连接，多头连接会导致小行接入每家支付机构时均需按不同支付机构的要求重新开发程序。采用网联清算平台一点接入的模式，会避免重复开发的情况，节约连接成本   
2. 针对我们这种没有支付机构备付金管理资格的小行，网联的建立将纠正每日通过大额支付系统手工汇划支付机构资金的问题  

网联的建立对城商行也有一些劣势   
1. 面临给备付金收款行支付利息问题   
2. 资金清算时间由T+1日改为了T日，我行的日均存款余额会受到影响（以前支付宝机构的日存资金会计入存款余额） 
3. 目前客户与第三方支付机构对签约验证短信、直接支付短信是由支付机构发送，接入网联平台之后，该短信需由银行发送，增加短信发送成本  


## 6. 支付侧对接
---


网联平台总体架构设计的四个关键选择 《金融电子化》 | 强群力 | 2017-10-09 09:21